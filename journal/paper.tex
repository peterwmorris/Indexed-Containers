
\documentclass[a4paper]{article}

\usepackage{url}
\usepackage{times}
\usepackage{amsmath}
\usepackage{xypic}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{stmaryrd}
\usepackage{color}

\newcommand{\note}[1]{}
\newcommand{\todo}[1]{\textcolor{red}{\textbf{Todo:~}#1}}

%% ODER: format ==         = "\mathrel{==}"
%% ODER: format /=         = "\neq "
%
%
\makeatletter
\@ifundefined{lhs2tex.lhs2tex.sty.read}%
  {\@namedef{lhs2tex.lhs2tex.sty.read}{}%
   \newcommand\SkipToFmtEnd{}%
   \newcommand\EndFmtInput{}%
   \long\def\SkipToFmtEnd#1\EndFmtInput{}%
  }\SkipToFmtEnd

\newcommand\ReadOnlyOnce[1]{\@ifundefined{#1}{\@namedef{#1}{}}\SkipToFmtEnd}
\usepackage{amstext}
\usepackage{amssymb}
\usepackage{stmaryrd}
\DeclareFontFamily{OT1}{cmtex}{}
\DeclareFontShape{OT1}{cmtex}{m}{n}
  {<5><6><7><8>cmtex8
   <9>cmtex9
   <10><10.95><12><14.4><17.28><20.74><24.88>cmtex10}{}
\DeclareFontShape{OT1}{cmtex}{m}{it}
  {<-> ssub * cmtt/m/it}{}
\newcommand{\texfamily}{\fontfamily{cmtex}\selectfont}
\DeclareFontShape{OT1}{cmtt}{bx}{n}
  {<5><6><7><8>cmtt8
   <9>cmbtt9
   <10><10.95><12><14.4><17.28><20.74><24.88>cmbtt10}{}
\DeclareFontShape{OT1}{cmtex}{bx}{n}
  {<-> ssub * cmtt/bx/n}{}
\newcommand{\tex}[1]{\text{\texfamily#1}}	% NEU

\newcommand{\Sp}{\hskip.33334em\relax}


\newcommand{\Conid}[1]{\mathit{#1}}
\newcommand{\Varid}[1]{\mathit{#1}}
\newcommand{\anonymous}{\kern0.06em \vbox{\hrule\@width.5em}}
\newcommand{\plus}{\mathbin{+\!\!\!+}}
\newcommand{\bind}{\mathbin{>\!\!\!>\mkern-6.7mu=}}
\newcommand{\rbind}{\mathbin{=\mkern-6.7mu<\!\!\!<}}% suggested by Neil Mitchell
\newcommand{\sequ}{\mathbin{>\!\!\!>}}
\renewcommand{\leq}{\leqslant}
\renewcommand{\geq}{\geqslant}
\usepackage{polytable}

%mathindent has to be defined
\@ifundefined{mathindent}%
  {\newdimen\mathindent\mathindent\leftmargini}%
  {}%

\def\resethooks{%
  \global\let\SaveRestoreHook\empty
  \global\let\ColumnHook\empty}
\newcommand*{\savecolumns}[1][default]%
  {\g@addto@macro\SaveRestoreHook{\savecolumns[#1]}}
\newcommand*{\restorecolumns}[1][default]%
  {\g@addto@macro\SaveRestoreHook{\restorecolumns[#1]}}
\newcommand*{\aligncolumn}[2]%
  {\g@addto@macro\ColumnHook{\column{#1}{#2}}}

\resethooks

\newcommand{\onelinecommentchars}{\quad-{}- }
\newcommand{\commentbeginchars}{\enskip\{-}
\newcommand{\commentendchars}{-\}\enskip}

\newcommand{\visiblecomments}{%
  \let\onelinecomment=\onelinecommentchars
  \let\commentbegin=\commentbeginchars
  \let\commentend=\commentendchars}

\newcommand{\invisiblecomments}{%
  \let\onelinecomment=\empty
  \let\commentbegin=\empty
  \let\commentend=\empty}

\visiblecomments

\newlength{\blanklineskip}
\setlength{\blanklineskip}{0.66084ex}

\newcommand{\hsindent}[1]{\quad}% default is fixed indentation
\let\hspre\empty
\let\hspost\empty
\newcommand{\NB}{\textbf{NB}}
\newcommand{\Todo}[1]{$\langle$\textbf{To do:}~#1$\rangle$}

\EndFmtInput
\makeatother
%
%
%
%
%
%
% This package provides two environments suitable to take the place
% of hscode, called "plainhscode" and "arrayhscode". 
%
% The plain environment surrounds each code block by vertical space,
% and it uses \abovedisplayskip and \belowdisplayskip to get spacing
% similar to formulas. Note that if these dimensions are changed,
% the spacing around displayed math formulas changes as well.
% All code is indented using \leftskip.
%
% Changed 19.08.2004 to reflect changes in colorcode. Should work with
% CodeGroup.sty.
%
\ReadOnlyOnce{polycode.fmt}%
\makeatletter

\newcommand{\hsnewpar}[1]%
  {{\parskip=0pt\parindent=0pt\par\vskip #1\noindent}}

% can be used, for instance, to redefine the code size, by setting the
% command to \small or something alike
\newcommand{\hscodestyle}{}

% The command \sethscode can be used to switch the code formatting
% behaviour by mapping the hscode environment in the subst directive
% to a new LaTeX environment.

\newcommand{\sethscode}[1]%
  {\expandafter\let\expandafter\hscode\csname #1\endcsname
   \expandafter\let\expandafter\endhscode\csname end#1\endcsname}

% "compatibility" mode restores the non-polycode.fmt layout.

\newenvironment{compathscode}%
  {\par\noindent
   \advance\leftskip\mathindent
   \hscodestyle
   \let\\=\@normalcr
   \let\hspre\(\let\hspost\)%
   \pboxed}%
  {\endpboxed\)%
   \par\noindent
   \ignorespacesafterend}

\newcommand{\compaths}{\sethscode{compathscode}}

% "plain" mode is the proposed default.
% It should now work with \centering.
% This required some changes. The old version
% is still available for reference as oldplainhscode.

\newenvironment{plainhscode}%
  {\hsnewpar\abovedisplayskip
   \advance\leftskip\mathindent
   \hscodestyle
   \let\hspre\(\let\hspost\)%
   \pboxed}%
  {\endpboxed%
   \hsnewpar\belowdisplayskip
   \ignorespacesafterend}

\newenvironment{oldplainhscode}%
  {\hsnewpar\abovedisplayskip
   \advance\leftskip\mathindent
   \hscodestyle
   \let\\=\@normalcr
   \(\pboxed}%
  {\endpboxed\)%
   \hsnewpar\belowdisplayskip
   \ignorespacesafterend}

% Here, we make plainhscode the default environment.

\newcommand{\plainhs}{\sethscode{plainhscode}}
\newcommand{\oldplainhs}{\sethscode{oldplainhscode}}
\plainhs

% The arrayhscode is like plain, but makes use of polytable's
% parray environment which disallows page breaks in code blocks.

\newenvironment{arrayhscode}%
  {\hsnewpar\abovedisplayskip
   \advance\leftskip\mathindent
   \hscodestyle
   \let\\=\@normalcr
   \(\parray}%
  {\endparray\)%
   \hsnewpar\belowdisplayskip
   \ignorespacesafterend}

\newcommand{\arrayhs}{\sethscode{arrayhscode}}

% The mathhscode environment also makes use of polytable's parray 
% environment. It is supposed to be used only inside math mode 
% (I used it to typeset the type rules in my thesis).

\newenvironment{mathhscode}%
  {\parray}{\endparray}

\newcommand{\mathhs}{\sethscode{mathhscode}}

% texths is similar to mathhs, but works in text mode.

\newenvironment{texthscode}%
  {\(\parray}{\endparray\)}

\newcommand{\texths}{\sethscode{texthscode}}

% The framed environment places code in a framed box.

\def\codeframewidth{\arrayrulewidth}
\RequirePackage{calc}

\newenvironment{framedhscode}%
  {\parskip=\abovedisplayskip\par\noindent
   \hscodestyle
   \arrayrulewidth=\codeframewidth
   \tabular{@{}|p{\linewidth-2\arraycolsep-2\arrayrulewidth-2pt}|@{}}%
   \hline\framedhslinecorrect\\{-1.5ex}%
   \let\endoflinesave=\\
   \let\\=\@normalcr
   \(\pboxed}%
  {\endpboxed\)%
   \framedhslinecorrect\endoflinesave{.5ex}\hline
   \endtabular
   \parskip=\belowdisplayskip\par\noindent
   \ignorespacesafterend}

\newcommand{\framedhslinecorrect}[2]%
  {#1[#2]}

\newcommand{\framedhs}{\sethscode{framedhscode}}

% The inlinehscode environment is an experimental environment
% that can be used to typeset displayed code inline.

\newenvironment{inlinehscode}%
  {\(\def\column##1##2{}%
   \let\>\undefined\let\<\undefined\let\\\undefined
   \newcommand\>[1][]{}\newcommand\<[1][]{}\newcommand\\[1][]{}%
   \def\fromto##1##2##3{##3}%
   \def\nextline{}}{\) }%

\newcommand{\inlinehs}{\sethscode{inlinehscode}}

% The joincode environment is a separate environment that
% can be used to surround and thereby connect multiple code
% blocks.

\newenvironment{joincode}%
  {\let\orighscode=\hscode
   \let\origendhscode=\endhscode
   \def\endhscode{\def\hscode{\endgroup\def\@currenvir{hscode}\\}\begingroup}
   %\let\SaveRestoreHook=\empty
   %\let\ColumnHook=\empty
   %\let\resethooks=\empty
   \orighscode\def\hscode{\endgroup\def\@currenvir{hscode}}}%
  {\origendhscode
   \global\let\hscode=\orighscode
   \global\let\endhscode=\origendhscode}%

\makeatother
\EndFmtInput
%
%
\ReadOnlyOnce{agda.fmt}%


\RequirePackage[T1]{fontenc}
\RequirePackage[utf8x]{inputenc}
\RequirePackage{ucs}
\RequirePackage{amsfonts}

\providecommand\mathbbm{\mathbb}

% TODO: Define more of these ...
\DeclareUnicodeCharacter{737}{\textsuperscript{l}}
\DeclareUnicodeCharacter{8718}{\ensuremath{\blacksquare}}
\DeclareUnicodeCharacter{8759}{::}
\DeclareUnicodeCharacter{9669}{\ensuremath{\triangleleft}}
\DeclareUnicodeCharacter{8799}{\ensuremath{\stackrel{\scriptscriptstyle ?}{=}}}
\DeclareUnicodeCharacter{10214}{\ensuremath{\llbracket}}
\DeclareUnicodeCharacter{10215}{\ensuremath{\rrbracket}}

% TODO: This is in general not a good idea.
\providecommand\textepsilon{$\epsilon$}
\providecommand\textmu{$\mu$}


%Actually, varsyms should not occur in Agda output.

% TODO: Make this configurable. IMHO, italics doesn't work well
% for Agda code.

\renewcommand\Varid[1]{\mathord{\textsf{#1}}}
\let\Conid\Varid
\newcommand\Keyword[1]{\textsf{\textbf{#1}}}
\EndFmtInput













\begin{document}

\newcounter{theorem}

\newtheorem{proposition}[theorem]{Proposition}
\newenvironment{proof}[1][Proof]{\begin{trivlist}
\item[\hskip \labelsep {\bfseries #1}]}{\end{trivlist}}

\title{Indexed Containers}
\author{Thorsten Altenkirch 
   \and Neil Ghani 
   \and Peter Hancock 
   \and Conor McBride 
   \and Peter Morris}
\date{\today}

\maketitle

\begin{abstract}

  We show that the syntactically rich notion of inductive families can
  be reduced to a core type theory with a fixed number of type
  constructors exploiting the novel notion of indexed containers.
  Indexed containers generalize simple containers, capturing strictly
  positive families instead of just strictly positive types, without
  having to extend the core type theory. Other applications of indexed
  containers include datatype-generic programming and reasoning about
  polymorphic functions. The construction presented here has been
  formalized using the Agda system.

\end{abstract}


%%Introduction

\section{Introduction}




\noindent Inductive datatypes are a central feature of modern Type Theory
(e.g. COQ~\cite{CIC}) or functional programming (e.g. 
Haskell\footnote{Here we shall view Haskell as an approximation of strong
  functional programming as proposed by Turner \cite{sfp} and ignore
non-termination.}). Examples include the natural numbers al Peano:
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{9}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{data}\;\Conid{ℕ}\;\in\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{zero}\;{}\<[9]%
\>[9]{}\in\;\Conid{ℕ}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{suc}\;{}\<[9]%
\>[9]{}\in\;(\Varid{n}\;\in\;\Conid{ℕ})\;\rightarrow\;\Conid{ℕ}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
the set of lists indexed by any given set:
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{8}{@{}>{\hspre}l<{\hspost}@{}}%
\column{24}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{data}\;\Conid{List}\;(\Conid{A}\;\in\;\Conid{Set})\;\in\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}[\mskip1.5mu \mskip1.5mu]\;{}\<[8]%
\>[8]{}\in\;{}\<[24]%
\>[24]{}\Conid{List}\;\Conid{A}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{\char95 ∷\char95 }\;{}\<[8]%
\>[8]{}\in\;\Conid{A}\;\rightarrow\;\Conid{List}\;\Conid{A}\;\rightarrow\;{}\<[24]%
\>[24]{}\Conid{List}\;\Conid{A}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
and the set of  de Bruijn $\lambda$-terms:
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{8}{@{}>{\hspre}l<{\hspost}@{}}%
\column{23}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{data}\;\Conid{Lam}\;\in\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{var}\;{}\<[8]%
\>[8]{}\in\;(\Varid{n}\;\in\;\Conid{ℕ})\;{}\<[23]%
\>[23]{}\rightarrow\;\Conid{Lam}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{app}\;{}\<[8]%
\>[8]{}\in\;(\Varid{f}\;\Varid{a}\;\in\;\Conid{Lam})\;{}\<[23]%
\>[23]{}\rightarrow\;\Conid{Lam}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{lam}\;{}\<[8]%
\>[8]{}\in\;(\Varid{t}\;\in\;\Conid{Lam})\;{}\<[23]%
\>[23]{}\rightarrow\;\Conid{Lam}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks


\noindent An elegant way to formalize and reason about inductive types
is to model them as the initial algebra of an endofunctor, we can
define the siganture functors cirresponding to each of the examples above:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Conid{F}_{\Conid{ℕ}}\;\in\;\Conid{Set}\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\Conid{F}_{\Conid{ℕ}}\;\Conid{X}\;\mathrel{=}\;\top\;\uplus\;\Conid{X}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Conid{F}_{\Conid{List}}\;\in\;(\Conid{A}\;\in\;\Conid{Set})\;\rightarrow\;\Conid{Set}\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\Conid{F}_{\Conid{List}}\;\Conid{A}\;\Conid{X}\;\mathrel{=}\;\top\;\uplus\;(\Conid{A}\;\times\;\Conid{X}){}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Conid{F}_{\Conid{Lam}}\;\in\;\Conid{Set}\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\Conid{F}_{\Conid{Lam}}\;\Conid{X}\;\mathrel{=}\;\Conid{ℕ}\;\uplus\;(\Conid{X}\;\times\;\Conid{X})\;\uplus\;\Conid{X}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

This perspective has been very
successful in providing a generic approach to programming with and
reasoning about inductive types, e.g. see the \emph{Algebra of
Programming} \cite{BirdDeMoor:AlgProp}.

While the theory of inductive types is well developed, we often want
to have a finer, more expressive, notion of types, for example to
ensure the absence of runtime errors --- access to arrays out of
range or access to an undefined variable in the previous example of
$\lambda$-terms. 

To model this we move to the notion of an inductive
family in Type Theory. A family is a type indexed by another already
given type. The first example is the family of finite sets \ensuremath{\Conid{Fin}} which
assigns to any natural number \ensuremath{\Varid{n}} a set \ensuremath{\Conid{Fin}\;\Varid{n}} which has exactly
\ensuremath{\Varid{n}} elements. \ensuremath{\Conid{Fin}} can be used where in conventional reasoning we
assume any finite set, e.g. when dealing with a finite address apace or
a finite set of variables. The inductive definition of \ensuremath{\Conid{Fin}} refines
the type of natural numbers:
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{9}{@{}>{\hspre}l<{\hspost}@{}}%
\column{30}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{data}\;\Conid{Fin}\;\in\;\Conid{ℕ}\;\rightarrow\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{zero}\;{}\<[9]%
\>[9]{}\in\;\forall{}\;\{\mskip1.5mu \Varid{n}\mskip1.5mu\}\;{}\<[30]%
\>[30]{}\rightarrow\;\Conid{Fin}\;(\Varid{suc}\;\Varid{n}){}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{suc}\;{}\<[9]%
\>[9]{}\in\;\forall{}\;\{\mskip1.5mu \Varid{n}\mskip1.5mu\}\;(\Varid{i}\;\in\;\Conid{Fin}\;\Varid{n})\;{}\<[30]%
\>[30]{}\rightarrow\;\Conid{Fin}\;(\Varid{suc}\;\Varid{n}){}\<[E]%
\ColumnHook
\end{hscode}\resethooks

In the same fashion we can refine the type of lists to the type of
vectors which are additionally indexed by a number indicating the
length of the vector:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{8}{@{}>{\hspre}l<{\hspost}@{}}%
\column{42}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{data}\;\Conid{Vec}\;(\Conid{A}\;\in\;\Conid{Set})\;\in\;\Conid{ℕ}\;\rightarrow\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}[\mskip1.5mu \mskip1.5mu]\;{}\<[8]%
\>[8]{}\in\;{}\<[42]%
\>[42]{}\Conid{Vec}\;\Conid{A}\;\Varid{zero}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{\char95 ∷\char95 }\;{}\<[8]%
\>[8]{}\in\;\forall{}\;\{\mskip1.5mu \Varid{n}\mskip1.5mu\}\;(\Varid{a}\;\in\;\Conid{A})\;(\Varid{as}\;\in\;\Conid{Vec}\;\Conid{A}\;\Varid{n})\;\rightarrow\;{}\<[42]%
\>[42]{}\Conid{Vec}\;\Conid{A}\;(\Varid{suc}\;\Varid{n}){}\<[E]%
\ColumnHook
\end{hscode}\resethooks

Using \ensuremath{\Conid{Fin}} and \ensuremath{\Conid{Vec}} instead of \ensuremath{\Conid{Nat}} and \ensuremath{\Conid{List}} enables us to write
a total projection function projecting the nth element out of vector:
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{20}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Varid{\char95 !!\char95 }\;\in\;\{\mskip1.5mu \Conid{A}\;\in\;\Conid{Set}\mskip1.5mu\}\;\rightarrow\;\Conid{List}\;\Conid{A}\;\rightarrow\;\Conid{ℕ}\;\rightarrow\;\Conid{Maybe}\;\Conid{A}{}\<[E]%
\\
\>[B]{}[\mskip1.5mu \mskip1.5mu]\;\mathbin{!!}\;\Varid{n}\;{}\<[20]%
\>[20]{}\mathrel{=}\;\Varid{nothing}{}\<[E]%
\\
\>[B]{}(\Varid{a}\;\Varid{∷}\;\Varid{as})\;\mathbin{!!}\;\Varid{zero}\;{}\<[20]%
\>[20]{}\mathrel{=}\;\Varid{just}\;\Varid{a}{}\<[E]%
\\
\>[B]{}(\Varid{a}\;\Varid{∷}\;\Varid{as})\;\mathbin{!!}\;\Varid{suc}\;\Varid{n}\;{}\<[20]%
\>[20]{}\mathrel{=}\;\Varid{as}\;\mathbin{!!}\;\Varid{n}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
Note, that a corresponding function \ensuremath{\Varid{\char95 !!\char95 }\;\in\;\{\mskip1.5mu \Conid{A}\;\in\;\Conid{Set}\mskip1.5mu\}\;\rightarrow\;\Conid{List}\;\Conid{A}\;\rightarrow\;\Conid{ℕ}\;\rightarrow\;\Conid{A}} is not definable in a total language like Agda.

Finally we can define the notion of a well-scoped lambda term with
\ensuremath{\Conid{ScLam}} which assigns to a natural number \ensuremath{\Varid{n}} the set of $\lambda$-terms
with at most \ensuremath{\Varid{n}} free variables \ensuremath{\Conid{ScLam}\;\Varid{n}}. DeBruijn variables are now
modelled by elements of \ensuremath{\Conid{Fin}\;\Varid{n}} replacing \ensuremath{\Conid{Nat}} in the previous,
unindexed definition of $\lambda$-terms \ensuremath{\Conid{Lam}}.

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{8}{@{}>{\hspre}l<{\hspost}@{}}%
\column{31}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{data}\;\Conid{ScLam}\;(\Varid{n}\;\in\;\Conid{ℕ})\;\in\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{var}\;{}\<[8]%
\>[8]{}\in\;(\Varid{i}\;\in\;\Conid{Fin}\;\Varid{n})\;{}\<[31]%
\>[31]{}\rightarrow\;\Conid{ScLam}\;\Varid{n}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{app}\;{}\<[8]%
\>[8]{}\in\;(\Varid{f}\;\Varid{a}\;\in\;\Conid{ScLam}\;\Varid{n})\;{}\<[31]%
\>[31]{}\rightarrow\;\Conid{ScLam}\;\Varid{n}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{lam}\;{}\<[8]%
\>[8]{}\in\;(\Varid{t}\;\in\;\Conid{ScLam}\;(\Varid{suc}\;\Varid{n}))\;{}\<[31]%
\>[31]{}\rightarrow\;\Conid{ScLam}\;\Varid{n}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\noindent
Importantly, the constructor
\ensuremath{\Varid{lam}} reduces the number of \emph{free} variables by one --- by
binding one. 
Inductive families may be mutually defined, for example the scoped
versions of  $\beta$ (\ensuremath{\Conid{NfLam}})
normal forms and neutral $\lambda$-terms (\ensuremath{\Conid{NeLam}}): 
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{10}{@{}>{\hspre}l<{\hspost}@{}}%
\column{41}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{mutual}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{data}\;\Conid{NeLam}\;(\Varid{n}\;\in\;\Conid{ℕ})\;\in\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{var}\;{}\<[10]%
\>[10]{}\in\;(\Varid{i}\;\in\;\Conid{Fin}\;\Varid{n})\;{}\<[41]%
\>[41]{}\rightarrow\;\Conid{NeLam}\;\Varid{n}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{app}\;{}\<[10]%
\>[10]{}\in\;(\Varid{f}\;\in\;\Conid{NeLam}\;\Varid{n})\;(\Varid{a}\;\in\;\Conid{NfLam}\;\Varid{n})\;{}\<[41]%
\>[41]{}\rightarrow\;\Conid{NeLam}\;\Varid{n}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{data}\;\Conid{NfLam}\;(\Varid{n}\;\in\;\Conid{ℕ})\;\in\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{lam}\;{}\<[10]%
\>[10]{}\in\;(\Varid{t}\;\in\;\Conid{NfLam}\;(\Varid{suc}\;\Varid{n}))\;{}\<[41]%
\>[41]{}\rightarrow\;\Conid{NfLam}\;\Varid{n}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{ne}\;{}\<[10]%
\>[10]{}\in\;(\Varid{t}\;\in\;\Conid{NeLam}\;\Varid{n})\;{}\<[41]%
\>[41]{}\rightarrow\;\Conid{NfLam}\;\Varid{n}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks


The initial algebra semantics of inductive types can be extended to
model inductive families by replacing functors on the category \ensuremath{\Conid{Set}}
with functors on the category of families indexed by a given type - in
the case of all our examples so far this indexing type was \ensuremath{\Conid{Nat}}. The objects
of the category of families indexed over a type \ensuremath{\Conid{I}\;\in\;\Varid{set}} are
\ensuremath{\Conid{I}}-indexed families, i.e. functions of type \ensuremath{\Conid{I}\;\rightarrow\;\Conid{Set}}, and a
morphism between \ensuremath{\Conid{I}}-indexed families \ensuremath{\Conid{A},\Conid{B}\;\in\;\Conid{I}\;\rightarrow\;\Conid{Set}} is given by a
family of maps \ensuremath{\Varid{f}\;\in\;(\Varid{i}\;\in\;\Conid{I})\;\to \;\Conid{A}\;\Varid{i}\;\to \;\Conid{B}\;\Varid{i}}
Indeed, this category
is easily seen to be isomorphic to the slice category $\ensuremath{\Conid{Set}}/ \ensuremath{\Conid{I}}$ but
the chosen representation is more convenient type-theoretically. Using
$\Sigma$-types and equality types from Type Theory, we can define the
following endofunctors \ensuremath{\Conid{F}_{\Conid{Fin}}}, \ensuremath{\Conid{F}_{\Conid{Vec}}} and \ensuremath{\Conid{F}_{\Conid{Lam}}}
on the category of families
over \ensuremath{\Conid{Nat}} whose initial algebras are \ensuremath{\Conid{Fin}} and \ensuremath{\Conid{Lam}}, respectively:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Conid{F}_{\Conid{Fin}}\;\in\;(\Conid{ℕ}\;\rightarrow\;\Conid{Set})\;\rightarrow\;\Conid{ℕ}\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\Conid{F}_{\Conid{Fin}}\;\Conid{X}\;\Varid{n}\;\mathrel{=}\;\Sigma\;\Conid{ℕ}\;\lambda\;\Varid{m}\;\rightarrow\;(\Varid{n}\;\equiv\;\Varid{suc}\;\Varid{m})\;\times\;(\top\;\uplus\;\Conid{X}\;\Varid{m}){}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Conid{F}_{\Conid{Vec}}\;\in\;(\Conid{A}\;\in\;\Conid{Set})\;\rightarrow\;(\Conid{ℕ}\;\rightarrow\;\Conid{Set})\;\rightarrow\;\Conid{ℕ}\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\Conid{F}_{\Conid{Vec}}\;\Conid{A}\;\Conid{X}\;\Varid{n}\;\mathrel{=}\;\Varid{n}\;\equiv\;\Varid{zero}\;\uplus\;\Sigma\;\Conid{ℕ}\;\lambda\;\Varid{m}\;\rightarrow\;(\Varid{n}\;\equiv\;\Varid{suc}\;\Varid{m})\;\times\;(\Conid{A}\;\times\;\Conid{X}\;\Varid{m}){}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Conid{F}_{\Conid{ScLam}}\;\in\;(\Conid{ℕ}\;\rightarrow\;\Conid{Set})\;\rightarrow\;\Conid{ℕ}\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\Conid{F}_{\Conid{ScLam}}\;\Conid{X}\;\Varid{n}\;\mathrel{=}\;\Conid{Fin}\;\Varid{n}\;\uplus\;(\Conid{X}\;\Varid{n}\;\times\;\Conid{X}\;\Varid{n})\;\uplus\;(\Conid{X}\;\ensuremath{\mbox{$\circ$}}\;\Varid{suc})\;\Varid{n}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

The equality type expresses the focussed character of the
constructors for \ensuremath{\Conid{Fin}}. 

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Conid{FNe}\;\in\;(\Conid{ℕ}\;\rightarrow\;\Conid{Set})\;\rightarrow\;(\Conid{ℕ}\;\rightarrow\;\Conid{Set})\;\rightarrow\;\Conid{ℕ}\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\Conid{FNe}\;\Conid{X}\;\Conid{Y}\;\Varid{n}\;\mathrel{=}\;\Conid{Fin}\;\Varid{n}\;\uplus\;(\Conid{X}\;\Varid{n}\;\uplus\;\Conid{Y}\;\Varid{n}){}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Conid{FNf}\;\in\;(\Conid{ℕ}\;\rightarrow\;\Conid{Set})\;\rightarrow\;(\Conid{ℕ}\;\rightarrow\;\Conid{Set})\;\rightarrow\;\Conid{ℕ}\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\Conid{FNf}\;\Conid{X}\;\Conid{Y}\;\Varid{n}\;\mathrel{=}\;(\Conid{Y}\;\ensuremath{\mbox{$\circ$}}\;\Varid{suc})\;\Varid{n}\;\uplus\;\Conid{X}\;\Varid{n}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\todo{Discuss mutual case.}



This approach extends uniformly to more complicated examples such as
the family of typed $\lambda$-terms, using lists of types  to
represent typing contexts:
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{6}{@{}>{\hspre}l<{\hspost}@{}}%
\column{8}{@{}>{\hspre}l<{\hspost}@{}}%
\column{9}{@{}>{\hspre}l<{\hspost}@{}}%
\column{11}{@{}>{\hspre}l<{\hspost}@{}}%
\column{19}{@{}>{\hspre}l<{\hspost}@{}}%
\column{34}{@{}>{\hspre}l<{\hspost}@{}}%
\column{44}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{data}\;\Conid{Ty}\;\in\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\iota\;{}\<[6]%
\>[6]{}\in\;\Conid{Ty}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\anonymous \Rightarrow\anonymous \;{}\<[11]%
\>[11]{}\in\;(\sigma\;\tau\;\in\;\Conid{Ty})\;\rightarrow\;\Conid{Ty}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Keyword{data}\;\Conid{Var}\;(\tau\;\in\;\Conid{Ty})\;\in\;\Conid{List}\;\Conid{Ty}\;\rightarrow\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{zero}\;{}\<[9]%
\>[9]{}\in\;\forall{}\;\{\mskip1.5mu \Gamma\mskip1.5mu\}\;{}\<[34]%
\>[34]{}\rightarrow\;\Conid{Var}\;\tau\;(\tau\;\Varid{∷}\;\Gamma){}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{suc}\;{}\<[9]%
\>[9]{}\in\;\forall{}\;\{\mskip1.5mu \sigma\;\Gamma\mskip1.5mu\}\;(\Varid{i}\;\in\;\Conid{Var}\;\tau\;\Gamma)\;{}\<[34]%
\>[34]{}\rightarrow\;\Conid{Var}\;\tau\;(\sigma\;\Varid{∷}\;\Gamma){}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Keyword{data}\;\Conid{STLam}\;(\Gamma\;\in\;\Conid{List}\;\Conid{Ty})\;\in\;\Conid{Ty}\;\rightarrow\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{var}\;{}\<[8]%
\>[8]{}\in\;\forall{}\;\{\mskip1.5mu \tau\mskip1.5mu\}\;{}\<[19]%
\>[19]{}(\Varid{i}\;\in\;\Conid{Var}\;\tau\;\Gamma)\;{}\<[44]%
\>[44]{}\rightarrow\;\Conid{STLam}\;\Gamma\;\tau{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{app}\;{}\<[8]%
\>[8]{}\in\;\forall{}\;\{\mskip1.5mu \sigma\;\tau\mskip1.5mu\}\;{}\<[19]%
\>[19]{}(\Varid{f}\;\in\;\Conid{STLam}\;\Gamma\;(\sigma\;\Rightarrow\;\tau))\;{}\<[E]%
\\
\>[19]{}(\Varid{a}\;\in\;\Conid{STLam}\;\Gamma\;\sigma)\;{}\<[44]%
\>[44]{}\rightarrow\;\Conid{STLam}\;\Gamma\;\tau{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{lam}\;{}\<[8]%
\>[8]{}\in\;\forall{}\;\{\mskip1.5mu \sigma\;\tau\mskip1.5mu\}\;{}\<[19]%
\>[19]{}(\Varid{t}\;\in\;\Conid{STLam}\;(\sigma\;\Varid{∷}\;\Gamma)\;\tau)\;{}\<[44]%
\>[44]{}\rightarrow\;\Conid{STLam}\;\Gamma\;(\sigma\;\Rightarrow\;\tau){}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\noindent
Types like this can be used to implement a tag-free, terminating
evaluator~\cite{bsn}. To obtain the corresponding functors
is a laborious but straightforward exercise.

\todo{Expand here?}

\noindent
Inductive families are the backbone of
dependently typed programming as present in Epigram or
Agda~\cite{Agda}. Coq also supports the definition of inductive families
but programming with them is rather hard --- a situation which has been
improved by the new \texttt{Program} tactic~\cite{sozeau}. 
More recently, the implementation of Generalized Algebraic Datatypes 
(GADTs)~\cite{Hinze:GADT} 
allows \ensuremath{\Conid{Fin}} and \ensuremath{\Conid{Lam}} to be encoded in Haskell:
\begin{tabbing}\tt
~data~Fin~a~where~\\
\tt ~~~FZero~\char58{}\char58{}~Fin~\char40{}Maybe~a\char41{}\\
\tt ~~~FSucc~\char58{}\char58{}~Fin~a~\char45{}\char62{}~Fin~\char40{}Maybe~a\char41{}\\
\tt ~\\
\tt ~data~Lam~a~where~\\
\tt ~~~Var~\char58{}\char58{}~Fin~a~\char45{}\char62{}~Lam~a\\
\tt ~~~App~\char58{}\char58{}~Lam~a~\char45{}\char62{}~Lam~a~\char45{}\char62{}~Lam~a\\
\tt ~~~Abs~\char58{}\char58{}~Lam~\char40{}Maybe~a\char41{}~\char45{}\char62{}~Lam~a
\end{tabbing}
Here \texttt{Fin} and \texttt{Lam} are indexed by types instead of
natural numbers; The type constructor \texttt{Maybe} serves as a type level
copy of the \ensuremath{\Varid{succ}} constructor for natural numbers.
Note that \texttt{Lam} is actually just a nested datatype 
\cite{alti:csl99} while \texttt{Fin} exploits the full power of
GADTs because the range of the constructors is constrained.

\subsection{Overview over the paper}
\label{sec:overview-over-paper}

We develop our type theoretic and categorical background in section
\ref{sec:background} and also summarize the basic definitions of
non-indexed containers. In section \ref{sec:ifunc} we develop the
concept of an indexed functor, showing that this is a relative monad
and presenting basic constructions on indexed functors including the
definition of a parametrized initial algebra. In section
\ref{sec:icont} we devlop the basic theory of indexed containers and
relate them to indexed functors. Subsequently in section
\ref{sec:initalg} we construct initial algebras of indexed containers
assuming the existence of indexed W-types, this can be dualized to
showing the existence of terminal coalgebras from indexed M-types 
\ref{sec:termcoalg}. Both requirements, indexed W-types and indexed
M-types can be derived from ordinary W-types, this is shown in section
\ref{sec:w-enough}. Finally, we define a syntax from strictly positive
families and interpret this using indexed containers \ref{sec:spf}.

\subsection{Related work}
\label{sec:related-work}

\noindent We introduce the notion of indexed container which
generalizes containers allowing us to represent inductive
families. This is a further step from \emph{dependent polynomial
  functors} \cite{HylandGambino} representing endofunctors on a slice
category. Indexed containers as introduced in the present paper allow us
to represent functors between different slices and capture also mutual
and nested inductive definitions.

While Hyland and Gambino \cite{HylandGambino} show that dependent polynomial 
functors always
have initial algebras, we show that indexed containers are closed under 
parametrized initial algebras. Hence we can apply the fixpoint
construction several times. The flexibility of indexed
containers allows us to also establish closure under the adjoints of
reindexing. This leads directly to a grammar for strictly positive
families, which itself is an instance of a strictly positive family 
(section \ref{sec:spf}) --- see also our previous work \cite{alti:cats07,alti:jcats07}.

Containers are related to Girard's normal functors \cite{GirardNormal} which
themselves are a special case of Joyal's analytic functors
\cite{JoyalA:fonaes} --- those that allow only finite sets of positions.
Fiore, Gambino, Hyland and Winskel's work on generalized species
\cite{fiore2008ccb} considers those concepts in a more generic setting ---
th e precise relation of this work to indexed containers remains to be
explored.

Perhaps the earliest publication related to indexed containers
occurs in Petersson and Synek's paper
\cite{PS89} from 1989. They present rules extending Martin-L{\"o}f's
type theory with a set constructor for `tree sets' : families of
mutually defined inductive sets, over a fixed index set.

Inspired in part by Petersson and Synek's constructor,
Hancock, Hyvernat and Setzer \cite{hancock-apal06} applied indexed (and unindexed)
containers, under the name `interaction structures' to the task of
modelling imperative interfaces such as command-response interfaces in
a number of publications. 

This paper is an expanded and revised version of the LICS paper by the
first and 3rd author \cite{lics}. In the present paper we have
integrated the Agda formalisation in the main development, which in
many instances required extending it. We have made explicit the use of
relative monads which was only hinted at in the conference version
based on the recent work on relative monads \cite{relmon}. We have
also dualized the development to terminal coalgebras which required
the type of paths to be defined inductively instead of recursively as
done in the conference paper (section \ref{sec:termcoalg}).  We
have also formalized the derivation of indexed W-types from ordinary
W-types (section \ref{wifromw}. The derivation of M-types from W-types
(section \ref{sec:mfromw})
was already given in \cite{C-CSPTs} is revisited here exploiting the
indexed W-type derived previously. moreover the development is formalized in
Agda. 

\todo{What did I miss?}


\section{Background}
\label{sec:background}

 

\subsection{Type Theory}

\newcommand{\prodd}{\ensuremath{\mathaccent\cdot{\prod}}}





Our constructions are all developed in Agda, and so we adopt its syntax, but we will take certain liberties with its type-theory. 

We have $\Pi$-types, denoted \ensuremath{(\Varid{a}\;\in\;\Conid{A})\;\rightarrow\;\Conid{B}\;\Varid{a}} and $\Sigma$-types, which we write as: \ensuremath{\Sigma(\!\;\Varid{a}\;\in\;\Conid{A}\;\!)\!\times\!\;\Conid{B}\;\Varid{a}}. In fact this is sugar for the record type:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{record}\;\Sigma\;(\Conid{A}\;\in\;\Conid{Set})\;(\Conid{B}\;\in\;\Conid{A}\;\rightarrow\;\Conid{Set})\;\in\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{constructor}\;\anonymous ,\anonymous {}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{field}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\pi_0\;\in\;\Conid{A}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\pi_1\;\in\;\Conid{B}\;\pi_0{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

We will, however assume that the type-theory we work in has $\Sigma$-types as primative, and has no native support for data-types. 
Instead, we only have \ensuremath{\Conid{W}}-types, the empty-type \ensuremath{\bot}, the unit type \ensuremath{\Varid{tt}\;\in\;\top} and the booleans \ensuremath{\Varid{true},\Varid{false}\;\in\;\Conid{Bool}}. 

A type theory has \ensuremath{\Conid{W}} types if it has a type former \ensuremath{\Conid{W}\;\in\;(\Conid{S}\;\in\;\Conid{Set})\;(\Conid{P}\;\in\;\Conid{S}\;\rightarrow\;\Conid{Set})\;\rightarrow\;\Conid{Set}} with a constructor \ensuremath{\Varid{sup}} and an eliminator \ensuremath{\Varid{wrec}}:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{9}{@{}>{\hspre}l<{\hspost}@{}}%
\column{15}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{data}\;\Conid{W}\;(\Conid{S}\;\in\;\Conid{Set})\;(\Conid{P}\;\in\;\Conid{S}\;\rightarrow\;\Conid{Set})\;\in\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{sup}\;\in\;\Sigma(\!\;\Varid{s}\;\in\;\Conid{S}\;\!)\!\times\!\;(\Conid{P}\;\Varid{s}\;\rightarrow\;\Conid{W}\;\Conid{S}\;\Conid{P})\;\rightarrow\;\Conid{W}\;\Conid{S}\;\Conid{P}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Varid{wrec}\;\in\;{}\<[9]%
\>[9]{}\{\mskip1.5mu \Conid{S}\;\in\;\Conid{Set}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{P}\;\in\;\Conid{S}\;\rightarrow\;\Conid{Set}\mskip1.5mu\}\;(\Conid{Q}\;\in\;\Conid{W}\;\Conid{S}\;\Conid{P}\;\rightarrow\;\Conid{Set})\;{}\<[E]%
\\
\>[9]{}(\Varid{x}\;\in\;\Conid{W}\;\Conid{S}\;\Conid{P})\;{}\<[E]%
\\
\>[9]{}(\Varid{m}\;\in\;{}\<[15]%
\>[15]{}(\Varid{s}\;\in\;\Conid{S})\;(\Varid{f}\;\in\;\Conid{P}\;\Varid{s}\;\rightarrow\;\Conid{W}\;\Conid{S}\;\Conid{P})\;{}\<[E]%
\\
\>[15]{}(\Varid{h}\;\in\;(\Varid{p}\;\in\;\Conid{P}\;\Varid{s})\;\rightarrow\;\Conid{Q}\;(\Varid{f}\;\Varid{p}))\;{}\<[E]%
\\
\>[15]{}\rightarrow\;\Conid{Q}\;(\Varid{sup}\;(\Varid{s},\Varid{f})))\;{}\<[E]%
\\
\>[9]{}\rightarrow\;\Conid{Q}\;\Varid{x}{}\<[E]%
\\
\>[B]{}\Varid{wrec}\;\Conid{Q}\;(\Varid{sup}\;(\Varid{s},\Varid{f}))\;\Varid{m}\;\mathrel{=}\;\Varid{m}\;\Varid{s}\;\Varid{f}\;(\lambda\;\Varid{p}\;\rightarrow\;\Varid{wrec}\;\Conid{Q}\;(\Varid{f}\;\Varid{p})\;\Varid{m}){}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\noindent
As a notational convenience, we will continue to define extra Agda data-types
in the rest of the paper, but in the end we will show how each of these can
be reduced to a theory that contains only \ensuremath{\Conid{W}}. For compactness, and
readability we will also define functions using Agda's pattern matching
syntax, rather than encoding them using \ensuremath{\Varid{wrec}}, it is an unstated lemma that
each of these definitions can be reduced to terms which only use \ensuremath{\Varid{wrec}}.

We'll also require a notion of propositional equality. To simplyfy the presentation of some definitions later on, we will employ a heterogeneous equality.
This can be defined in Agda via a data-type:


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{data}\;\Varid{\char95 ≅\char95 }\;\{\mskip1.5mu \Conid{A}\;\in\;\Conid{Set}\mskip1.5mu\}\;(\Varid{x}\;\in\;\Conid{A})\;\in\;\{\mskip1.5mu \Conid{B}\;\in\;\Conid{Set}\mskip1.5mu\}\;\rightarrow\;\Conid{B}\;\rightarrow\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{refl}\;\in\;\Varid{x}\;\cong\;\Varid{x}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Varid{subst}\;\in\;\{\mskip1.5mu \Conid{A}\;\in\;\Conid{Set}\mskip1.5mu\}\;(\Conid{P}\;\in\;\Conid{A}\;\rightarrow\;\Conid{Set})\;\{\mskip1.5mu \Varid{x}\;\Varid{y}\;\in\;\Conid{A}\mskip1.5mu\}\;\rightarrow\;\Varid{x}\;\cong\;\Varid{y}\;\rightarrow\;\Conid{P}\;\Varid{x}\;\rightarrow\;\Conid{P}\;\Varid{y}{}\<[E]%
\\
\>[B]{}\Varid{subst}\;\Conid{P}\;\Varid{refl}\;\Varid{p}\;\mathrel{=}\;\Varid{p}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

Most of the time our equalities will be homogeneous, however, so we introduce a short hand for this:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Varid{\char95 ≡\char95 }\;\in\;\{\mskip1.5mu \Conid{A}\;\in\;\Conid{Set}\mskip1.5mu\}\;\rightarrow\;\Conid{A}\;\rightarrow\;\Conid{A}\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\Varid{a}\;\equiv\;\Varid{b}\;\mathrel{=}\;\Varid{a}\;\cong\;\Varid{b}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

It is also known that homogeneous and heterogeneous equality have the same 
strength, so all the definitions employing our equality could also be encoded in
a theory with only homogeneous equality.

This is an intensional equality, but we want to work in a setting with extensional type-theory, so we extend the propositional equality with this extensionality axiom:


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{12}{@{}>{\hspre}l<{\hspost}@{}}%
\column{20}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[3]{}\Keyword{postulate}\;\Varid{ext}\;\in\;{}\<[20]%
\>[20]{}\{\mskip1.5mu \Varid{f}\;\Varid{g}\;\in\;(\Varid{a}\;\in\;\Conid{A})\;\rightarrow\;\Conid{B}\;\Varid{a}\mskip1.5mu\}\;\rightarrow\;{}\<[E]%
\\
\>[20]{}((\Varid{a}\;\in\;\Conid{A})\;\rightarrow\;\Varid{f}\;\Varid{a}\;\equiv\;\Varid{g}\;\Varid{a})\;\rightarrow\;\Varid{f}\;\equiv\;\Varid{g}{}\<[E]%
\\[\blanklineskip]%
\>[3]{}\Varid{ext⁻¹}\;\in\;{}\<[12]%
\>[12]{}\{\mskip1.5mu \Varid{f}\;\Varid{g}\;\in\;(\Varid{a}\;\in\;\Conid{A})\;\rightarrow\;\Conid{B}\;\Varid{a}\mskip1.5mu\}\;\rightarrow\;{}\<[E]%
\\
\>[12]{}\Varid{f}\;\equiv\;\Varid{g}\;\rightarrow\;((\Varid{a}\;\in\;\Conid{A})\;\rightarrow\;\Varid{f}\;\Varid{a}\;\equiv\;\Varid{g}\;\Varid{a}){}\<[E]%
\\
\>[3]{}\Varid{ext⁻¹}\;\Varid{refl}\;\Varid{a}\;\mathrel{=}\;\Varid{refl}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

This creates non-canonical elements of \ensuremath{\Varid{\char95 ≅\char95 }}, \emph{i.e.} closed terms in
equality types which are not \ensuremath{\Varid{refl}}. In order to deal with these
non-canonical elements, we also rely on axiom \ensuremath{\Conid{K}}, or the uniqueness of
identity proofs:



\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[3]{}\Conid{UIP}\;\in\;\{\mskip1.5mu \Varid{a}\;\Varid{b}\;\in\;\Conid{A}\mskip1.5mu\}\;\{\mskip1.5mu \Varid{p}\;\in\;\Varid{a}\;\cong\;\Varid{b}\mskip1.5mu\}\;\{\mskip1.5mu \Varid{q}\;\in\;\Varid{a}\;\cong\;\Varid{b}\mskip1.5mu\}\;\rightarrow\;\Varid{p}\;\cong\;\Varid{q}{}\<[E]%
\\
\>[3]{}\Conid{UIP}\;\{\mskip1.5mu \Varid{p}\;\mathrel{=}\;\Varid{refl}\mskip1.5mu\}\;\{\mskip1.5mu \Varid{q}\;\mathrel{=}\;\Varid{refl}\mskip1.5mu\}\;\mathrel{=}\;\Varid{refl}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks


With these ingredients we obtain a theory which corresponds to
extensional Type Theory \cite{hofmann-conservativity}.

We are going to use type theory versions of certain category theoretic
concepts For instance, we use ends \ensuremath{\Conid{End}} to capture natural transformations.
Given a bifunctor \ensuremath{\Conid{F}\;\in\;\Conid{Set}^{\Varid{op}}\;\rightarrow\;\Conid{Set}\;\rightarrow\;\Conid{Set}}, an element of \ensuremath{\prodd\;\Conid{X}\;.\;\Conid{F}\;\Conid{X}\;\Conid{X}} is
equivalent to an element of \ensuremath{\Varid{f}\;\in\;\{\mskip1.5mu \Conid{X}\;\in\;\Conid{Set}\mskip1.5mu\}\;\rightarrow\;\Conid{F}\;\Conid{X}\;\Conid{X}}, along with a proof:

\[ \mbox{\ensuremath{\{\mskip1.5mu \Conid{A}\;\Conid{B}\;\in\;\Conid{Set}\mskip1.5mu\}\;(\Varid{g}\;\in\;\Conid{A}\;\rightarrow\;\Conid{B})\;\rightarrow\;\Conid{F}\;\Varid{g}\;\Conid{B}\;(\Varid{f}\;\{\mskip1.5mu \Conid{B}\mskip1.5mu\})\;\equiv\;\Conid{F}\;\Conid{A}\;\Varid{g}\;(\Varid{f}\;\{\mskip1.5mu \Conid{A}\mskip1.5mu\})}} \]


\noindent
The natural transformations between functors \ensuremath{\Conid{F}} and \ensuremath{\Conid{G}} are ends \ensuremath{\prodd\;\Conid{X}\;.\;\Conid{F}\;\Conid{X}\;\rightarrow\;\Conid{G}\;\Conid{X}}. We will often ignore the presence of the proofs, and 
use such ends directly as polymorphic functions.

In this setting, the Yoneda lemma can be stated as follows, for any functor \ensuremath{\Conid{F}\;\in\;\Conid{Set}\;\rightarrow\;\Conid{Set}}:

\[\mbox{\ensuremath{\Conid{F}\;\Conid{X}\;\cong\;\prodd\;\Conid{Y}\;.\;(\Conid{X}\;\rightarrow\;\Conid{Y})\;\rightarrow\;\Conid{F}\;\Conid{Y}}}\]

we will make use of this fact later on.

Finally, for readability we will elide certain artifacts in Agda's syntax,
for instance the quantification of implicit arguments when their types can be
inferred from the context. The reader should be reassured that the paper is a
literate agda file, available from the final author's webpage.

\todo{Define Func.}
 
\subsection{Containers}


The initial algebra semantics is useful to provide a generic
analysis of inductive types exploiting generic concepts such as
constructors and functorial map. However, it cannot say whether such inductive
types actually exist, and it falls short of providing a systematic
characterisation of generic operations such as equality or the
zipper~\cite{huet:zipper,conor:derivative}. 

In previous
work, \cite{alti:cont-tcs,alti:fossacs03}, we have proposed the notion of a container
type: A (unary) container is given by a set of shapes \ensuremath{\Conid{S}} and a
family of positions \ensuremath{\Conid{P}} assigning, to each shape, the set
of positions where data can be stored in a data structure of that
shape.

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{record}\;\Conid{Cont}\;\in\;\Conid{Set₁}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{constructor}\;\anonymous \lhd\anonymous {}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{field}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Conid{S}\;\in\;\Conid{Set}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Conid{P}\;\in\;\Conid{S}\;\rightarrow\;\Conid{Set}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

Every container \ensuremath{\Conid{S}\;\lhd\;\Conid{P}}  gives rise to a functor:
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{21}{@{}>{\hspre}l<{\hspost}@{}}%
\column{28}{@{}>{\hspre}l<{\hspost}@{}}%
\column{69}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Varid{⟦\char95 ⟧}\;\in\;\Conid{Cont}\;\rightarrow\;\Conid{Func}{}\<[E]%
\\
\>[B]{}\Varid{⟦}\;\Conid{S}\;\lhd\;\Conid{P}\;\Varid{⟧}\;\mathrel{=}\;\Keyword{record}\;{}\<[21]%
\>[21]{}\{\mskip1.5mu \Varid{obj}\;{}\<[28]%
\>[28]{}\mathrel{=}\;\lambda\;\Conid{A}\;\rightarrow\;\Sigma(\!\;\Varid{s}\;\in\;\Conid{S}\;\!)\!\times\!\;(\Conid{P}\;\Varid{s}\;\rightarrow\;\Conid{A}){}\<[E]%
\\
\>[21]{};\Varid{mor}\;{}\<[28]%
\>[28]{}\mathrel{=}\;\lambda\;\Varid{m}\;\rightarrow\;\lambda (\!\;\Varid{s}\;\!,\!\;\Varid{f}\;\!\!)\;\rightarrow\;(\Varid{s},\Varid{m}\;\ensuremath{\mbox{$\circ$}}\;\Varid{f})\;{}\<[69]%
\>[69]{}\!\;\!{}\<[E]%
\\
\>[21]{}\mskip1.5mu\}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

For example the list functor is a container, its shapes are given by the natural numbers (representing the list's length) and the positions for a shape \ensuremath{\Varid{n}\;\in\;\Conid{ℕ}} are given by a finite set of size \ensuremath{\Varid{n}}. 




We define morphisms of containers, this can be derived from the specification that embedding should be full and faithful using the Yoneda lemma:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{record}\;\anonymous \Rightarrow\anonymous \;(\Conid{C}\;\Conid{D}\;\in\;\Conid{Cont})\;\in\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{constructor}\;\anonymous \lhd\anonymous {}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{field}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{f}\;\in\;\Conid{C}\;\!.\Conid{S}\;\rightarrow\;\Conid{D}\;\!.\Conid{S}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{r}\;\in\;(\Varid{s}\;\in\;\Conid{C}\;\!.\Conid{S})\;\rightarrow\;\Conid{D}\;\!.\Conid{P}\;\!\!\;(\Varid{f}\;\Varid{s})\;\rightarrow\;\Conid{C}\;\!.\Conid{P}\;\!\!\;\Varid{s}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Varid{⟦}\anonymous \Varid{⟧}\mbox{$\!^{\Rightarrow}$}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{C}\;\Conid{D}\mskip1.5mu\}\;\rightarrow\;\Conid{C}\;\Rightarrow\;\Conid{D}\;\rightarrow\;\prodd\;\Conid{A}\;.\;(\!\;\Varid{⟦}\;\Conid{C}\;\Varid{⟧}\;\Conid{A}\;\rightarrow\;\!\;\Varid{⟦}\;\Conid{D}\;\Varid{⟧}\;\Conid{A}){}\<[E]%
\\
\>[B]{}\Varid{⟦}\;\Varid{f}\;\lhd\;\Varid{r}\;\Varid{⟧}\mbox{$\!^{\Rightarrow}$}\;(\Varid{s},\Varid{g})\;\mathrel{=}\;\Varid{f}\;\Varid{s},\Varid{g}\;\ensuremath{\mbox{$\circ$}}\;\Varid{r}\;\Varid{s}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

The category of containers is a full and faithful sub-category of the functor category. We have also shown that the category of containers is cartesian closed (\cite{cie}, and is closed under formation of co-products.

Container functors have initial algebras, indeed these are exactly the \ensuremath{\Conid{W}} types we know well from Type-Theory, which we can be equivalently defined to be:


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{data}\;\Conid{W}\;(\Conid{S}\;\in\;\Conid{Set})\;(\Conid{P}\;\in\;\Conid{S}\;\rightarrow\;\Conid{Set})\;\in\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{sup}\;\in\;\!\;\Varid{⟦}\;\Conid{S}\;\lhd\;\Conid{P}\;\Varid{⟧}\;(\Conid{W}\;\Conid{S}\;\Conid{P})\;\rightarrow\;\Conid{W}\;\Conid{S}\;\Conid{P}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks


However, we have also shown that for \ensuremath{\Varid{n}}-ary containers (containers with \ensuremath{\Varid{n}} position sets), it is possible to define a \emph{parameterised} initial algebra construction \ensuremath{\mu\;\in\;\forall{}\;\{\mskip1.5mu \Varid{n}\mskip1.5mu\}\;\rightarrow\;\Conid{Cont}\;(\Varid{suc}\;\Varid{n})\;\rightarrow\;\Conid{Cont}\;\Varid{n}}. This allows us to model a broad range of nested and mutual types as containers.


%%Indexed Functors


\section{Indexed Functors}
\label{sec:ifunc}


Given \ensuremath{\Conid{I}\;\in\;\Conid{Set}} we consider the category of families over \ensuremath{\Conid{I}}. Its objects are
\ensuremath{\Conid{I}}-indexed families of types \ensuremath{\Conid{A}\;\in\;\Conid{I}\;\rightarrow\;\Conid{Set}} and morphisms are given by 
\ensuremath{\Conid{I}}-indexed families of functions:


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{8}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\anonymous \rightarrow^{\star}\anonymous \;\in\;\{\mskip1.5mu \Conid{I}\;\in\;\Conid{Set}\mskip1.5mu\}\;\to \;(\Conid{A}\;\Conid{B}\;\in\;\Conid{I}\;\to \;\Conid{Set})\;\to \;\Conid{Set}{}\<[E]%
\\
\>[B]{}\anonymous \rightarrow^{\star}\anonymous \;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\Conid{A}\;\Conid{B}\;\mathrel{=}\;(\Varid{i}\;\in\;\Conid{I})\;\to \;\Conid{A}\;\Varid{i}\;\to \;\Conid{B}\;\Varid{i}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Varid{id}^{\star}\;\in\;\{\mskip1.5mu \Conid{I}\;\in\;\Conid{Set}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{A}\;\in\;\Conid{I}\;\rightarrow\;\Conid{Set}\mskip1.5mu\}\;\rightarrow\;\Conid{A}\;\rightarrow^{\star}\;\Conid{A}{}\<[E]%
\\
\>[B]{}\Varid{id}^{\star}\;\Varid{i}\;\Varid{a}\;\mathrel{=}\;\Varid{a}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\anonymous \circ^{\star}\anonymous \;\in\;{}\<[8]%
\>[8]{}\{\mskip1.5mu \Conid{I}\;\in\;\Conid{Set}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{A}\;\Conid{B}\;\Conid{C}\;\in\;\Conid{I}\;\rightarrow\;\Conid{Set}\mskip1.5mu\}\;\rightarrow\;{}\<[E]%
\\
\>[8]{}(\Conid{B}\;\rightarrow^{\star}\;\Conid{C})\;\rightarrow\;(\Conid{A}\;\rightarrow^{\star}\;\Conid{B})\;\rightarrow\;(\Conid{A}\;\rightarrow^{\star}\;\Conid{C}){}\<[E]%
\\
\>[B]{}\Varid{f}\;\circ^{\star}\;\Varid{g}\;\mathrel{=}\;\lambda\;\Varid{i}\;\rightarrow\;(\Varid{f}\;\Varid{i})\;\ensuremath{\mbox{$\circ$}}\;(\Varid{g}\;\Varid{i}){}\<[E]%
\ColumnHook
\end{hscode}\resethooks



\noindent
We call this category \ensuremath{\Conid{Fam}\;\Conid{I}}.
An \ensuremath{\Conid{I}}-indexed functor is then a functor from \ensuremath{\Conid{Fam}\;\Conid{I}} to \ensuremath{\Conid{Set}}, given by:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{record}\;\Conid{IFunc}\;(\Conid{I}\;\in\;\Conid{Set})\;\in\;\Conid{Set₁}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{field}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{obj}\;\in\;(\Conid{A}\;\in\;\Conid{Fam}\;\Conid{I})\;\to \;\Conid{Set}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{mor}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{A}\;\Conid{B}\mskip1.5mu\}\;\to \;(\Conid{A}\;\rightarrow^{\star}\;\Conid{B})\;\to \;\Varid{obj}\;\Conid{A}\;\to \;\Varid{obj}\;\Conid{B}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\noindent
such that both \ensuremath{\Varid{id}^{\star}} is mapped to \ensuremath{\Varid{id}} and \ensuremath{\anonymous \circ^{\star}\anonymous } to \ensuremath{\anonymous \ensuremath{\mbox{$\circ$}}\anonymous } under the action of 
\ensuremath{\Varid{mor}}. We adopt the convention that the projections \ensuremath{\Varid{obj}} and \ensuremath{\Varid{mor}} are silent, 
\emph{i.e.} depending on the context \ensuremath{\Conid{F}\;\in\;\Conid{IFunc}\;\Conid{I}} can stand for either the 
functor's action on objects, or on morphisms. A morphism between to such 
indexed functors is a natural transformation:


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{12}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\anonymous \Rightarrow^{\text{\tiny F}}\anonymous \;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\rightarrow\;(\Conid{F}\;\Conid{G}\;\in\;\Conid{IFunc}\;\Conid{I})\;\rightarrow\;\Conid{Set₁}{}\<[E]%
\\
\>[B]{}\Conid{F}\;\Rightarrow^{\text{\tiny F}}\;\Conid{G}\;\mathrel{=}\;{}\<[12]%
\>[12]{}\prodd\;\Conid{A}\;.\;\!\;\Conid{F}\;\Conid{A}\;\rightarrow\;\!\;\Conid{G}\;\Conid{A}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\noindent




\ensuremath{\Conid{IFunc}} comes with a monad like structure given by:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{4}{@{}>{\hspre}l<{\hspost}@{}}%
\column{12}{@{}>{\hspre}c<{\hspost}@{}}%
\column{12E}{@{}l@{}}%
\column{15}{@{}>{\hspre}l<{\hspost}@{}}%
\column{20}{@{}>{\hspre}l<{\hspost}@{}}%
\column{23}{@{}>{\hspre}l<{\hspost}@{}}%
\column{28}{@{}>{\hspre}l<{\hspost}@{}}%
\column{48}{@{}>{\hspre}l<{\hspost}@{}}%
\column{61}{@{}>{\hspre}l<{\hspost}@{}}%
\column{68}{@{}>{\hspre}l<{\hspost}@{}}%
\column{71}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\eta^{\text{\tiny F}}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\rightarrow\;\Conid{I}\;\rightarrow\;\Conid{IFunc}\;\Conid{I}{}\<[E]%
\\
\>[B]{}\eta^{\text{\tiny F}}\;\Varid{i}\;\mathrel{=}\;\Keyword{record}\;\{\mskip1.5mu \Varid{obj}\;\mathrel{=}\;\lambda\;\Conid{A}\;\rightarrow\;\Conid{A}\;\Varid{i};\Varid{mor}\;\mathrel{=}\;\lambda\;\Varid{f}\;\rightarrow\;\Varid{f}\;\Varid{i}\mskip1.5mu\}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\anonymous \bind ^{\text{\tiny F}}\anonymous \;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\;\Conid{J}\mskip1.5mu\}\;\rightarrow\;\Conid{IFunc}\;\Conid{I}\;\rightarrow\;(\Conid{I}\;\rightarrow\;\Conid{IFunc}\;\Conid{J})\;\rightarrow\;\Conid{IFunc}\;\Conid{J}{}\<[E]%
\\
\>[B]{}\Conid{F}\;\bind ^{\text{\tiny F}}\;\Conid{H}\;\mathrel{=}{}\<[E]%
\\
\>[B]{}\hsindent{4}{}\<[4]%
\>[4]{}\Keyword{record}\;{}\<[12]%
\>[12]{}\{\mskip1.5mu {}\<[12E]%
\>[15]{}\Varid{obj}\;{}\<[20]%
\>[20]{}\mathrel{=}\;{}\<[23]%
\>[23]{}\lambda\;\Conid{A}\;{}\<[28]%
\>[28]{}\rightarrow\;\!\;\Conid{F}\;(\lambda\;\Varid{i}\;{}\<[48]%
\>[48]{}\rightarrow\;\!\;{}\<[61]%
\>[61]{}(\Conid{H}\;\Varid{i})\;{}\<[68]%
\>[68]{}\Conid{A}{}\<[71]%
\>[71]{}){}\<[E]%
\\
\>[12]{};{}\<[12E]%
\>[15]{}\Varid{mor}\;{}\<[20]%
\>[20]{}\mathrel{=}\;{}\<[23]%
\>[23]{}\lambda\;\Varid{f}\;{}\<[28]%
\>[28]{}\rightarrow\;\!\;\Conid{F}\;(\lambda\;\Varid{i}\;{}\<[48]%
\>[48]{}\rightarrow\;\!\;{}\<[61]%
\>[61]{}(\Conid{H}\;\Varid{i})\;{}\<[68]%
\>[68]{}\Varid{f}{}\<[71]%
\>[71]{})\mskip1.5mu\}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\noindent
It's clear that \ensuremath{\Conid{IFunc}} cannot be a monad in the usual sense, since it is not 
an endo-functor, it does how ever fit with the notion of relative monad 
presented by Altenkirch \emph{et al.} Note that in the code above we have 
elided the use of the lifting functor.


\begin{proposition} 
\ensuremath{(\Conid{IFunc},\eta^{\text{\tiny F}},\anonymous \bind ^{\text{\tiny F}}\anonymous )} is a \emph{relative monad}\cite{alti:relmonads} on the 
lifting functor \ensuremath{\uparrow\;\in\;\Conid{Set}_{i}\;\rightarrow\;\Conid{Set}_{i+1}}.
\end{proposition}

\begin{proof}
To prove the structure is a relative 
monad we observe that the following equalities hold up to 
Agda's $\beta\eta$-equality, and our postulate \ensuremath{\Varid{ext}}.

For \ensuremath{\Conid{F}\;\in\;\Conid{IFunc}\;\Conid{I}}, \ensuremath{\Conid{G}\;\in\;\Conid{IFunc*}\;\Conid{J}\;\Conid{I}}, \ensuremath{\Conid{H}\;\in\;\Conid{IFunc*}\;\Conid{K}\;\Conid{J}}:
\begin{align}
\ensuremath{\Conid{H}\;\Varid{i}}                 &\quad& \equiv &&\quad& \ensuremath{(\eta^{\text{\tiny F}}\;\Varid{i})\;\bind ^{\text{\tiny F}}\;\Conid{H}}               \\
\ensuremath{\Conid{F}}                   && \equiv &&& \ensuremath{\Conid{F}\;\bind ^{\text{\tiny F}}\;\eta^{\text{\tiny F}}}                 \\
\ensuremath{(\Conid{F}\;\bind ^{\text{\tiny F}}\;\Conid{G})\;\bind ^{\text{\tiny F}}\;\Conid{F}} && \equiv &&& \ensuremath{\Conid{F}\;\bind ^{\text{\tiny F}}\;(\lambda\;\Varid{i}\;\rightarrow\;(\Conid{G}\;\Varid{i})\;\bind ^{\text{\tiny F}}\;\Conid{H})} 
\end{align}

\end{proof}


\noindent
The opposite of the Kleisli category associated with \ensuremath{\Conid{IFunc}} has objects 
\ensuremath{\Conid{I},\Conid{J}\;\in\;\Conid{Set}} and morphisms given by \ensuremath{\Conid{J}}-indexed families of \ensuremath{\Conid{I}}-indexed 
functors. We denote this notion of indexed functor \ensuremath{\Conid{IFunc}^{\star}}: 

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{9}{@{}>{\hspre}l<{\hspost}@{}}%
\column{13}{@{}>{\hspre}l<{\hspost}@{}}%
\column{15}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Conid{IFunc}^{\star}\;\in\;(\Conid{I}\;\Conid{J}\;\in\;\Conid{Set})\;\rightarrow\;\Conid{Set₁}{}\<[E]%
\\
\>[B]{}\Conid{IFunc}^{\star}\;\Conid{I}\;\Conid{J}\;\mathrel{=}\;\Conid{J}\;\rightarrow\;\Conid{IFunc}\;\Conid{I}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Varid{obj}^{\star}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\;\Conid{J}\mskip1.5mu\}\;\rightarrow\;\Conid{IFunc}^{\star}\;\Conid{I}\;\Conid{J}\;\rightarrow\;\Conid{Fam}\;\Conid{I}\;\rightarrow\;\Conid{Fam}\;\Conid{J}{}\<[E]%
\\
\>[B]{}\Varid{obj}^{\star}\;\Conid{F}\;\Conid{A}\;\Varid{j}\;{}\<[15]%
\>[15]{}\mathrel{=}\;\!\;(\Conid{F}\;\Varid{j})\;\Conid{A}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Varid{mor}^{\star}\;\in\;{}\<[9]%
\>[9]{}\forall{}\;\{\mskip1.5mu \Conid{I}\;\Conid{J}\;\Conid{A}\;\Conid{B}\mskip1.5mu\}\;(\Conid{F}\;\in\;\Conid{IFunc}^{\star}\;\Conid{I}\;\Conid{J})\;\rightarrow\;\Conid{A}\;\rightarrow^{\star}\;\Conid{B}\;\rightarrow\;\Varid{obj}^{\star}\;\Conid{F}\;\Conid{A}\;\rightarrow^{\star}\;\Varid{obj}^{\star}\;\Conid{F}\;\Conid{B}{}\<[E]%
\\
\>[B]{}\Varid{mor}^{\star}\;\Conid{F}\;\Varid{m}\;\Varid{j}\;{}\<[13]%
\>[13]{}\mathrel{=}\;\!\;(\Conid{F}\;\Varid{j})\;\Varid{m}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\noindent
Again, we will omit \ensuremath{\Varid{obj}^{\star}} and \ensuremath{\Varid{mor}^{\star}} when inferable from the context 
in which they appear. Natural transformations extend to this double index 
setting, too:




\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\anonymous \Rightarrow^{\text{\tiny F}^{\star}}\anonymous \;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\;\Conid{J}\mskip1.5mu\}\;\rightarrow\;(\Conid{F}\;\Conid{G}\;\in\;\Conid{IFunc}^{\star}\;\Conid{I}\;\Conid{J})\;\rightarrow\;\Conid{Set₁}{}\<[E]%
\\
\>[B]{}\Conid{F}\;\Rightarrow^{\text{\tiny F}^{\star}}\;\Conid{G}\;\mathrel{=}\;\prodd\;\Conid{A}\;.\;\;\Conid{F}\;\Conid{A}\;\rightarrow^{\star}\;\;\Conid{G}\;\Conid{A}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks


\noindent
Clearly, the Kleisli structure gives rise to identities and composition in 
\ensuremath{\Conid{IFunc}^{\star}}. Indeed, composition gives rise to a \emph{re-indexing} operation which
we denote \ensuremath{\Delta^{\text{\tiny F}}}:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Delta^{\text{\tiny F}}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\;\Conid{J}\;\Conid{K}\mskip1.5mu\}\;\rightarrow\;(\Conid{J}\;\rightarrow\;\Conid{K})\;\rightarrow\;\Conid{IFunc}^{\star}\;\Conid{I}\;\Conid{K}\;\rightarrow\;\Conid{IFunc}^{\star}\;\Conid{I}\;\Conid{J}{}\<[E]%
\\
\>[B]{}\Delta^{\text{\tiny F}}\;\Varid{f}\;\Conid{F}\;\mathrel{=}\;\Conid{F}\;\ensuremath{\mbox{$\circ$}}\;\Varid{f}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks


\noindent
This construction is used, for instance, in building the pattern functor for
\ensuremath{\Conid{ScLam}} as in the introduction; Concentrating only on the \ensuremath{\Varid{abs}} case we want
to build  \ensuremath{\Conid{ScLam′}\;\Conid{X}\;\Varid{n}\;\mathrel{=}\;(\Conid{X}\;\ensuremath{\mbox{$\circ$}}\;\Varid{suc})\;\Varid{n}}. Or simply \ensuremath{\Conid{ScLam′}\;\Conid{X}\;\mathrel{=}\;\Delta^{\text{\tiny F}}\;\Varid{suc}\;\Conid{X}}. In
general this combinator restricts the functor \ensuremath{\Conid{X}} to the indices in the
image of the function \ensuremath{\Varid{f}}.

What if the restriction appears on the right of such an equation? As an example,
consider the successor constructor for \ensuremath{\Conid{Fin}}; here we want to build the pattern functor: \ensuremath{\Conid{FFin′}\;\Conid{X}\;(\Varid{1}\;\Varid{+}\;\Varid{n})\;\mathrel{=}\;\Conid{X}\;\Varid{n}}. To do this we observe that this is equivalent to
the equation \ensuremath{\Conid{FFin′}\;\Conid{X}\;\Varid{n}\;\mathrel{=}\;\Sigma\;\Conid{Nat}\;\lambda\;\Varid{m}\;\rightarrow\;\Varid{n}\;\equiv\;\Varid{1}\;\Varid{+}\;\Varid{m}\;\times\;\Conid{X}\;\Varid{m}}. We denote the general
construction \ensuremath{\Sigma^{\text{\tiny F}}}, so the 2nd equation can be written \ensuremath{\Conid{FFin′}\;\Conid{X}\;\mathrel{=}\;\Sigma^{\text{\tiny F}}\;\Varid{suc}\;\Conid{X}}:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{4}{@{}>{\hspre}l<{\hspost}@{}}%
\column{12}{@{}>{\hspre}c<{\hspost}@{}}%
\column{12E}{@{}l@{}}%
\column{15}{@{}>{\hspre}l<{\hspost}@{}}%
\column{20}{@{}>{\hspre}l<{\hspost}@{}}%
\column{23}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Sigma^{\text{\tiny F}}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{J}\;\Conid{I}\;\Conid{K}\mskip1.5mu\}\;\rightarrow\;(\Conid{J}\;\rightarrow\;\Conid{K})\;\rightarrow\;\Conid{IFunc}^{\star}\;\Conid{I}\;\Conid{J}\;\rightarrow\;\Conid{IFunc}^{\star}\;\Conid{I}\;\Conid{K}{}\<[E]%
\\
\>[B]{}\Sigma^{\text{\tiny F}}\;\{\mskip1.5mu \Conid{J}\mskip1.5mu\}\;\Varid{f}\;\Conid{F}\;\Varid{k}\;\mathrel{=}{}\<[E]%
\\
\>[B]{}\hsindent{4}{}\<[4]%
\>[4]{}\Keyword{record}\;{}\<[12]%
\>[12]{}\{\mskip1.5mu {}\<[12E]%
\>[15]{}\Varid{obj}\;{}\<[20]%
\>[20]{}\mathrel{=}\;{}\<[23]%
\>[23]{}\lambda\;\Conid{A}\;\rightarrow\;\Sigma(\!\;\Varid{j}\;\in\;\Conid{J}\;\!)\!\times\!\;(\Varid{f}\;\Varid{j}\;\equiv\;\Varid{k}\;\times\;\;\Conid{F}\;\Conid{A}\;\Varid{j}){}\<[E]%
\\
\>[12]{};{}\<[12E]%
\>[15]{}\Varid{mor}\;{}\<[20]%
\>[20]{}\mathrel{=}\;{}\<[23]%
\>[23]{}\lambda\;\Varid{m}\;\rightarrow\;\lambda (\!\;\Varid{j}\;\!,\!\;\Varid{p}\;\!,\!\;\Varid{x}\;\!\!)\;\rightarrow\;(\Varid{j},\Varid{p},\;\Conid{F}\;\Varid{m}\;\Varid{j}\;\Varid{x})\;\!\;\!\mskip1.5mu\}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\noindent
Perhaps unsurprisingly, \ensuremath{\Sigma^{\text{\tiny F}}} turns out to be the left adjoint to re-indexing 
(\ensuremath{\Delta^{\text{\tiny F}}}). Its right adjoint, we denote \ensuremath{\Pi^{\text{\tiny F}}}:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{4}{@{}>{\hspre}l<{\hspost}@{}}%
\column{12}{@{}>{\hspre}c<{\hspost}@{}}%
\column{12E}{@{}l@{}}%
\column{15}{@{}>{\hspre}l<{\hspost}@{}}%
\column{20}{@{}>{\hspre}l<{\hspost}@{}}%
\column{23}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Pi^{\text{\tiny F}}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{J}\;\Conid{I}\;\Conid{K}\mskip1.5mu\}\;\rightarrow\;(\Conid{J}\;\rightarrow\;\Conid{K})\;\rightarrow\;\Conid{IFunc}^{\star}\;\Conid{I}\;\Conid{J}\;\rightarrow\;\Conid{IFunc}^{\star}\;\Conid{I}\;\Conid{K}{}\<[E]%
\\
\>[B]{}\Pi^{\text{\tiny F}}\;\{\mskip1.5mu \Conid{J}\mskip1.5mu\}\;\Varid{f}\;\Conid{F}\;\Varid{k}\;\mathrel{=}{}\<[E]%
\\
\>[B]{}\hsindent{4}{}\<[4]%
\>[4]{}\Keyword{record}\;{}\<[12]%
\>[12]{}\{\mskip1.5mu {}\<[12E]%
\>[15]{}\Varid{obj}\;{}\<[20]%
\>[20]{}\mathrel{=}\;{}\<[23]%
\>[23]{}\lambda\;\Conid{A}\;\rightarrow\;(\Varid{j}\;\in\;\Conid{J})\;\rightarrow\;\Varid{f}\;\Varid{j}\;\equiv\;\Varid{k}\;\rightarrow\;\;\Conid{F}\;\Conid{A}\;\Varid{j}{}\<[E]%
\\
\>[12]{};{}\<[12E]%
\>[15]{}\Varid{mor}\;{}\<[20]%
\>[20]{}\mathrel{=}\;{}\<[23]%
\>[23]{}\lambda\;\Varid{m}\;\Varid{g}\;\Varid{j}\;\Varid{p}\;\rightarrow\;\;\Conid{F}\;\Varid{m}\;\Varid{j}\;(\Varid{g}\;\Varid{j}\;\Varid{p})\mskip1.5mu\}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\begin{proposition}
\ensuremath{\Sigma^{\text{\tiny F}}} and \ensuremath{\Pi^{\text{\tiny F}}} are left and right adjoint to re-indexing (\ensuremath{\Delta^{\text{\tiny F}}}). 
\end{proposition}

\begin{proof}

To show this we need to show that for all \ensuremath{\Varid{f}\;\in\;\Conid{J}\;\rightarrow\;\Conid{K}}, \ensuremath{\Varid{g}\;\in\;\Conid{K}\;\rightarrow\;\Conid{J}}, \ensuremath{\Conid{F}\;\in\;\Conid{IFunc}^{\star}\;\Conid{I}\;\Conid{J}} and \ensuremath{\Conid{G}\;\in\;\Conid{IFunc}^{\star}\;\Conid{I}\;\Conid{K}}:

\[\begin{array}{c}
\ensuremath{\Sigma^{\text{\tiny F}}\;\Varid{f}\;\Conid{F}\;\Rightarrow^{\text{\tiny F}^{\star}}\;\Conid{G}}
\\\hline\hline
\ensuremath{\Conid{F}\;\Rightarrow^{\text{\tiny F}^{\star}}\;\Delta^{\text{\tiny F}}\;\Varid{f}\;\Conid{G}}\\
\end{array}
\quad
\begin{array}{c}
\ensuremath{\Delta^{\text{\tiny F}}\;\Varid{f}\;\Conid{F}\;\Rightarrow^{\text{\tiny F}^{\star}}\;\Conid{G}}
\\\hline\hline
\ensuremath{\Conid{F}\;\Rightarrow^{\text{\tiny F}^{\star}}\;\Pi^{\text{\tiny F}}\;\Varid{f}\;\Conid{G}}\\
\end{array}
\]

We can build the components of these isomorphisms easily:



\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[3]{}\Sigma\!\dashv\!\Delta\;\in\;(\Varid{f}\;\in\;\Conid{J}\;\rightarrow\;\Conid{K})\;\rightarrow\;(\Sigma^{\text{\tiny F}}\;\Varid{f}\;\Conid{F}\;\Rightarrow^{\text{\tiny F}^{\star}}\;\Conid{G})\;\rightarrow\;(\Conid{F}\;\Rightarrow^{\text{\tiny F}^{\star}}\;\Delta^{\text{\tiny F}}\;\Varid{f}\;\Conid{G}){}\<[E]%
\\
\>[3]{}\Sigma\!\dashv\!\Delta\;\Varid{f}\;\Varid{m}\;\Varid{j}\;\Varid{x}\;\mathrel{=}\;\Varid{m}\;(\Varid{f}\;\Varid{j})\;(\Varid{j},\Varid{refl},\Varid{x}){}\<[E]%
\\[\blanklineskip]%
\>[3]{}\Sigma\!\dashv\!\Delta\Varid{⁻¹}\;\in\;(\Varid{f}\;\in\;\Conid{J}\;\rightarrow\;\Conid{K})\;\rightarrow\;(\Conid{F}\;\Rightarrow^{\text{\tiny F}^{\star}}\;\Delta^{\text{\tiny F}}\;\Varid{f}\;\Conid{G})\;\rightarrow\;(\Sigma^{\text{\tiny F}}\;\Varid{f}\;\Conid{F}\;\Rightarrow^{\text{\tiny F}^{\star}}\;\Conid{G}){}\<[E]%
\\
\>[3]{}\Sigma\!\dashv\!\Delta\Varid{⁻¹}\;\Varid{f}\;\Varid{m}\;.\;(\Varid{f}\;\Varid{j})\;(\Varid{j},\Varid{refl},\Varid{x})\;\mathrel{=}\;\Varid{m}\;\Varid{j}\;\Varid{x}{}\<[E]%
\\[\blanklineskip]%
\>[3]{}\Delta\!\dashv\!\Pi\;\in\;(\Varid{g}\;\in\;\Conid{K}\;\rightarrow\;\Conid{J})\;\rightarrow\;(\Delta^{\text{\tiny F}}\;\Varid{g}\;\Conid{F}\;\Rightarrow^{\text{\tiny F}^{\star}}\;\Conid{G})\;\rightarrow\;(\Conid{F}\;\Rightarrow^{\text{\tiny F}^{\star}}\;\Pi^{\text{\tiny F}}\;\Varid{g}\;\Conid{G}){}\<[E]%
\\
\>[3]{}\Delta\!\dashv\!\Pi\;\Varid{g}\;\Varid{m}\;.\;(\Varid{g}\;\Varid{k})\;\Varid{x}\;\Varid{k}\;\Varid{refl}\;\mathrel{=}\;\Varid{m}\;\Varid{k}\;\Varid{x}{}\<[E]%
\\[\blanklineskip]%
\>[3]{}\Delta\!\dashv\!\Pi\Varid{⁻¹}\;\in\;(\Varid{g}\;\in\;\Conid{K}\;\rightarrow\;\Conid{J})\;\rightarrow\;(\Conid{F}\;\Rightarrow^{\text{\tiny F}^{\star}}\;\Pi^{\text{\tiny F}}\;\Varid{g}\;\Conid{G})\;\rightarrow\;(\Delta^{\text{\tiny F}}\;\Varid{g}\;\Conid{F}\;\Rightarrow^{\text{\tiny F}^{\star}}\;\Conid{G}){}\<[E]%
\\
\>[3]{}\Delta\!\dashv\!\Pi\Varid{⁻¹}\;\Varid{g}\;\Varid{m}\;\Varid{k}\;\Varid{x}\;\mathrel{=}\;\Varid{m}\;(\Varid{g}\;\Varid{k})\;\Varid{x}\;\Varid{k}\;\Varid{refl}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\noindent
It only remains to observe that these pairs or functions are mutual inverses, 
which is a simple proof.

\end{proof}

In abstracting over all possible values for the extra indexing information \ensuremath{\Pi^{\text{\tiny F}}}
allows for the construction of infinitely branching trees, such as rose trees. 
We also note that finite co-products and products can be derived from \ensuremath{\Sigma^{\text{\tiny F}}} and 
\ensuremath{\Pi^{\text{\tiny F}}} respectively:






\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{12}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\bot^{\text{\tiny F}}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\rightarrow\;\Conid{IFunc}^{\star}\;\Conid{I}\;\top{}\<[E]%
\\
\>[B]{}\bot^{\text{\tiny F}}\;\mathrel{=}\;\Sigma^{\text{\tiny F}}\;{}\<[12]%
\>[12]{}\{\mskip1.5mu \Conid{J}\;\mathrel{=}\;\bot\mskip1.5mu\}\;\anonymous \;\lambda\;(){}\<[E]%
\\[\blanklineskip]%
\>[B]{}\anonymous \uplus^{\text{\tiny F}}\anonymous \;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\rightarrow\;(\Conid{F}\;\Conid{G}\;\in\;\Conid{IFunc}\;\Conid{I})\;\rightarrow\;\Conid{IFunc}^{\star}\;\Conid{I}\;\top{}\<[E]%
\\
\>[B]{}\Conid{F}\;\mathbin{\uplus^{\text{\tiny F}}}\;\Conid{G}\;\mathrel{=}\;\Sigma^{\text{\tiny F}}\;\anonymous \;\lambda\;\Varid{b}\;\rightarrow\;\Varid{if}\;\Varid{b}\;\Varid{then}\;\Conid{F}\;\Varid{else}\;\Conid{G}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\top^{\text{\tiny F}}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\rightarrow\;\Conid{IFunc}^{\star}\;\Conid{I}\;\top{}\<[E]%
\\
\>[B]{}\top^{\text{\tiny F}}\;\mathrel{=}\;\Pi^{\text{\tiny F}}\;{}\<[12]%
\>[12]{}\{\mskip1.5mu \Conid{J}\;\mathrel{=}\;\bot\mskip1.5mu\}\;\anonymous \;\lambda\;(){}\<[E]%
\\[\blanklineskip]%
\>[B]{}\anonymous \mathbin{\times^{\text{\tiny F}}}\anonymous \;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\rightarrow\;(\Conid{F}\;\Conid{G}\;\in\;\Conid{IFunc}\;\Conid{I})\;\rightarrow\;\Conid{IFunc}^{\star}\;\Conid{I}\;\top{}\<[E]%
\\
\>[B]{}\Conid{F}\;\mathbin{\times^{\text{\tiny F}}}\;\Conid{G}\;\mathrel{=}\;\Pi^{\text{\tiny F}}\;\anonymous \;\lambda\;\Varid{b}\;\rightarrow\;\Varid{if}\;\Varid{b}\;\Varid{then}\;\Conid{F}\;\Varid{else}\;\Conid{G}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\noindent
Clearly these are simply the constantly \ensuremath{\top} and \ensuremath{\bot} valued functors, and the 
point-wise product and co-product of functors, but this encoding allows us to 
keep the number of constants in our vocabulary to a minimum.

\subsection{Initial algebras of indexed functors}

We observe that an \ensuremath{\Conid{F}\;\in\;\Conid{IFunc}^{\star}\;\Conid{I}\;\Conid{I}} is an endo-functor on the category \ensuremath{\Conid{Fam}\;\Conid{I}}. 
Using this observation we know that an algebra of such a functor is a family 
\ensuremath{\Conid{A}\;\in\;\Conid{Fam}\;\Conid{I}} and a map \ensuremath{\alpha\;\in\;\;\Conid{F}\;\Conid{A}\;\rightarrow^{\star}\;\Conid{A}}. A morphism, then, between two such 
algebras \ensuremath{(\Conid{A},\alpha)} and \ensuremath{(\Conid{B},\beta)} is a map \ensuremath{\Varid{f}\;\in\;\Conid{A}\;\rightarrow^{\star}\;\Conid{B}} such that the follow 
diagram commutes:

 \[
\xymatrix{
\mbox{\ensuremath{\;\Conid{F}\;\Conid{A}}}  \ar[r]^{\;\mbox{\ensuremath{\alpha}}} 
\ar[d]_{\mbox{\ensuremath{\;\Conid{F}\;\Varid{f}}}} & \mbox{\ensuremath{\Conid{A}}} \ar[d]^{\mbox{\ensuremath{\Varid{f}}}}\\
\mbox{\ensuremath{\;\Conid{F}\;\Conid{B}}} \ar[r]^{\;\mbox{\ensuremath{\beta}}} & \mbox{\ensuremath{\Conid{B}}}}
\]

\noindent
If it exists then the initial algebra of \ensuremath{\Conid{F}} is the initial object of the 
category of \ensuremath{\Conid{F}}-algebras spelt out above. It follows from the fact that not all
functors in \ensuremath{\Conid{Set}\;\rightarrow\;\Conid{Set}} (for instance \ensuremath{\Conid{F}\;\Conid{A}\;\mathrel{=}\;(\Conid{A}\;\rightarrow\;\Conid{Bool})\;\rightarrow\;\Conid{Bool}}) have initial 
algebras that neither do all indexed-functors.

We also know that we cannot iterate the construction of initial algebras given 
above, an endo-functor \ensuremath{\Conid{IFunc}^{\star}\;\Conid{I}\;\Conid{I}} gives rise to an initial algebra in \ensuremath{\Conid{Fam}\;\Conid{I}}.
This prevents us from being able to define nested, or mutual inductive families 
in this way.

For the morphism part of an indexed-functor over a co-product we can eliminate
the co-product and curry the resulting definition in this way:

\begin{align*}
\ensuremath{\Conid{IFunc}\;(\Conid{I}\;\uplus\;\Conid{J})} 
  & \equiv      & \ensuremath{(\Conid{I}\;\uplus\;\Conid{J}\;\rightarrow\;\Conid{Set})\;\rightarrow\;\Conid{Set}} \\
  & \cong       & \ensuremath{(\Conid{I}\;\rightarrow\;\Conid{Set})\;\times\;(\Conid{J}\;\rightarrow\;\Conid{Set})\;\rightarrow\;\Conid{Set}}\\
  & \cong       & \ensuremath{(\Conid{I}\;\rightarrow\;\Conid{Set})\;\rightarrow\;(\Conid{J}\;\rightarrow\;\Conid{Set})\;\rightarrow\;\Conid{Set}}\\
\end{align*}

\noindent
This gives us partial application for indexed 
functors of the form \ensuremath{\Conid{IFunc}\;(\Conid{I}\;\uplus\;\Conid{J})}. Spelt out concretely we have:


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{11}{@{}>{\hspre}c<{\hspost}@{}}%
\column{11E}{@{}l@{}}%
\column{14}{@{}>{\hspre}l<{\hspost}@{}}%
\column{19}{@{}>{\hspre}l<{\hspost}@{}}%
\column{26}{@{}>{\hspre}l<{\hspost}@{}}%
\column{45}{@{}>{\hspre}l<{\hspost}@{}}%
\column{49}{@{}>{\hspre}l<{\hspost}@{}}%
\column{53}{@{}>{\hspre}l<{\hspost}@{}}%
\column{58}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\anonymous [\mskip1.5mu \anonymous \mskip1.5mu]^{\text{\tiny F}}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\;\Conid{J}\mskip1.5mu\}\;\rightarrow\;\Conid{IFunc}\;(\Conid{I}\;\uplus\;\Conid{J})\;\rightarrow\;\Conid{IFunc}^{\star}\;\Conid{I}\;\Conid{J}\;\rightarrow\;{}\<[49]%
\>[49]{}\Conid{IFunc}\;\Conid{I}{}\<[E]%
\\
\>[B]{}\Conid{F}\;[\mskip1.5mu \;\Conid{G}\;\mskip1.5mu]^{\text{\tiny F}}\;{}\<[11]%
\>[11]{}\mathrel{=}{}\<[11E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{record}\;{}\<[11]%
\>[11]{}\{\mskip1.5mu {}\<[11E]%
\>[14]{}\Varid{obj}\;{}\<[19]%
\>[19]{}\mathrel{=}\;\lambda\;\Conid{A}\;{}\<[26]%
\>[26]{}\rightarrow\;\!\;\Conid{F}\;[\mskip1.5mu \Conid{A}{}\<[45]%
\>[45]{},\;{}\<[53]%
\>[53]{}\Conid{G}\;\Conid{A}{}\<[58]%
\>[58]{}\mskip1.5mu]{}\<[E]%
\\
\>[11]{};{}\<[11E]%
\>[14]{}\Varid{mor}\;{}\<[19]%
\>[19]{}\mathrel{=}\;\lambda\;\Varid{f}\;{}\<[26]%
\>[26]{}\rightarrow\;\!\;\Conid{F}\;[\mskip1.5mu \Varid{f}{}\<[45]%
\>[45]{},\;{}\<[53]%
\>[53]{}\Conid{G}\;\Varid{f}{}\<[58]%
\>[58]{}\mskip1.5mu]\mskip1.5mu\}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\noindent
This construction is functorial:


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{10}{@{}>{\hspre}l<{\hspost}@{}}%
\column{12}{@{}>{\hspre}l<{\hspost}@{}}%
\column{16}{@{}>{\hspre}l<{\hspost}@{}}%
\column{19}{@{}>{\hspre}l<{\hspost}@{}}%
\column{21}{@{}>{\hspre}l<{\hspost}@{}}%
\column{28}{@{}>{\hspre}l<{\hspost}@{}}%
\column{37}{@{}>{\hspre}l<{\hspost}@{}}%
\column{42}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\anonymous [\mskip1.5mu \anonymous \mskip1.5mu]^{\text{\tiny F}}\;\in\;{}\<[10]%
\>[10]{}\forall{}\;\{\mskip1.5mu \Conid{I}\;\Conid{J}\mskip1.5mu\}\;{}\<[19]%
\>[19]{}(\Conid{F}\;\in\;\Conid{IFunc}\;(\Conid{I}\;\uplus\;\Conid{J}))\;\{\mskip1.5mu \Conid{G}\;\Conid{H}\;\in\;\Conid{IFunc}^{\star}\;\Conid{I}\;\Conid{J}\mskip1.5mu\}\;{}\<[E]%
\\
\>[10]{}\hsindent{2}{}\<[12]%
\>[12]{}\rightarrow\;{}\<[21]%
\>[21]{}\Conid{G}\;{}\<[28]%
\>[28]{}\Rightarrow^{\text{\tiny F}^{\star}}\;{}\<[42]%
\>[42]{}\Conid{H}\;{}\<[E]%
\\
\>[10]{}\hsindent{2}{}\<[12]%
\>[12]{}\rightarrow\;{}\<[16]%
\>[16]{}\Conid{F}\;[\mskip1.5mu \;{}\<[21]%
\>[21]{}\Conid{G}\;\mskip1.5mu]^{\text{\tiny F}}\;{}\<[28]%
\>[28]{}\Rightarrow^{\text{\tiny F}}\;{}\<[37]%
\>[37]{}\Conid{F}\;[\mskip1.5mu \;{}\<[42]%
\>[42]{}\Conid{H}\;\mskip1.5mu]^{\text{\tiny F}}{}\<[E]%
\\
\>[B]{}\Conid{F}\;[\mskip1.5mu \;\gamma\;\mskip1.5mu]^{\text{\tiny F}}\;\mathrel{=}\;\!\;\Conid{F}\;[\mskip1.5mu (\lambda\;\anonymous \;\Varid{a}\;\rightarrow\;\Varid{a}),\gamma\mskip1.5mu]{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\noindent
Each of these definitions generalises to \ensuremath{\Conid{IFunc}^{\star}}:


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{11}{@{}>{\hspre}l<{\hspost}@{}}%
\column{12}{@{}>{\hspre}l<{\hspost}@{}}%
\column{13}{@{}>{\hspre}l<{\hspost}@{}}%
\column{20}{@{}>{\hspre}l<{\hspost}@{}}%
\column{22}{@{}>{\hspre}l<{\hspost}@{}}%
\column{25}{@{}>{\hspre}l<{\hspost}@{}}%
\column{33}{@{}>{\hspre}l<{\hspost}@{}}%
\column{35}{@{}>{\hspre}l<{\hspost}@{}}%
\column{41}{@{}>{\hspre}l<{\hspost}@{}}%
\column{46}{@{}>{\hspre}l<{\hspost}@{}}%
\column{55}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\anonymous [\mskip1.5mu \anonymous \mskip1.5mu]^{\text{\tiny{F}}^{\star}}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\;\Conid{J}\;\Conid{K}\mskip1.5mu\}\;\rightarrow\;\Conid{IFunc}^{\star}\;(\Conid{I}\;\uplus\;\Conid{J})\;\Conid{K}\;\rightarrow\;\Conid{IFunc}^{\star}\;\Conid{I}\;\Conid{J}\;\rightarrow\;{}\<[55]%
\>[55]{}\Conid{IFunc}^{\star}\;\Conid{I}\;\Conid{K}{}\<[E]%
\\
\>[B]{}\Conid{F}\;[\mskip1.5mu \;\Conid{G}\;\mskip1.5mu]^{\text{\tiny{F}}^{\star}}\;{}\<[12]%
\>[12]{}\mathrel{=}\;\lambda\;\Varid{k}\;\rightarrow\;(\Conid{F}\;\Varid{k})\;[\mskip1.5mu \;\Conid{G}\;\mskip1.5mu]^{\text{\tiny F}}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\anonymous [\mskip1.5mu \anonymous \mskip1.5mu]^{\text{\tiny{F}}^{\star}}\;\in\;{}\<[11]%
\>[11]{}\forall{}\;\{\mskip1.5mu \Conid{I}\;\Conid{J}\;\Conid{K}\mskip1.5mu\}\;{}\<[22]%
\>[22]{}(\Conid{F}\;\in\;\Conid{IFunc}^{\star}\;(\Conid{I}\;\uplus\;\Conid{J})\;\Conid{K})\;\{\mskip1.5mu \Conid{G}\;\Conid{H}\;\in\;\Conid{IFunc}^{\star}\;\Conid{I}\;\Conid{J}\mskip1.5mu\}\;{}\<[E]%
\\
\>[11]{}\hsindent{2}{}\<[13]%
\>[13]{}\rightarrow\;{}\<[25]%
\>[25]{}\Conid{G}\;{}\<[33]%
\>[33]{}\Rightarrow^{\text{\tiny F}^{\star}}\;{}\<[46]%
\>[46]{}\Conid{H}\;{}\<[E]%
\\
\>[11]{}\hsindent{2}{}\<[13]%
\>[13]{}\rightarrow\;{}\<[20]%
\>[20]{}\Conid{F}\;[\mskip1.5mu \;{}\<[25]%
\>[25]{}\Conid{G}\;\mskip1.5mu]^{\text{\tiny{F}}^{\star}}\;{}\<[33]%
\>[33]{}\Rightarrow^{\text{\tiny F}^{\star}}\;{}\<[41]%
\>[41]{}\Conid{F}\;[\mskip1.5mu \;{}\<[46]%
\>[46]{}\Conid{H}\;\mskip1.5mu]^{\text{\tiny{F}}^{\star}}{}\<[E]%
\\
\>[B]{}\anonymous [\mskip1.5mu \anonymous \mskip1.5mu]^{\text{\tiny{F}}^{\star}}\;\Conid{F}\;\{\mskip1.5mu \Conid{G}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{H}\mskip1.5mu\}\;\gamma\;\mathrel{=}\;\lambda\;\Varid{k}\;\rightarrow\;\anonymous [\mskip1.5mu \anonymous \mskip1.5mu]^{\text{\tiny F}}\;{}\<[35]%
\>[35]{}(\Conid{F}\;\Varid{k})\;\{\mskip1.5mu \Conid{G}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{H}\mskip1.5mu\}\;\gamma{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\noindent
A parametrized \ensuremath{\Conid{F}}-algebra for \ensuremath{\Conid{F}\;\in\;\Conid{IFunc}^{\star}\;(\Conid{I}\;\uplus\;\Conid{J})\;\Conid{I}} is a pair of an 
indexed-functor \ensuremath{\Conid{G}\;\in\;\Conid{IFunc}\;\Conid{J}\;\Conid{I}} and a natural transformation
\ensuremath{\alpha\;\in\;\Conid{F}\;[\mskip1.5mu \;\Conid{G}\;\mskip1.5mu]^{\text{\tiny{F}}^{\star}}\;\Rightarrow^{\text{\tiny F}^{\star}}\;\Conid{G}}. A morphism between two such algebras 
\ensuremath{(\Conid{G},\alpha)} and \ensuremath{(\Conid{H},\beta)} is a natural transformation \ensuremath{\gamma\;\in\;\Conid{G}\;\Rightarrow^{\text{\tiny F}^{\star}}\;\Conid{H}} 
such that the follow diagram commutes:

\[
\xymatrix{
\mbox{\ensuremath{\Conid{F}\;[\mskip1.5mu \;\Conid{G}\;\mskip1.5mu]^{\text{\tiny{F}}^{\star}}}}  \ar[r]^{\quad\mbox{\ensuremath{\alpha}}} 
\ar[d]_{\mbox{\ensuremath{\Conid{F}\;[\mskip1.5mu \;\gamma\;\mskip1.5mu]^{\text{\tiny{F}}^{\star}}}}} & \mbox{\ensuremath{\Conid{G}}} \ar[d]^{\mbox{\ensuremath{\gamma}}}\\
\mbox{\ensuremath{\Conid{F}\;[\mskip1.5mu \;\Conid{H}\;\mskip1.5mu]^{\text{\tiny{F}}^{\star}}}} \ar[r]^{\quad\mbox{\ensuremath{\beta}}} & \mbox{\ensuremath{\Conid{H}}}}
\]

\noindent
As you might expect, a parametrized initial algebra for \ensuremath{\Conid{F}}, if it is exists, 
will be the initial object in the category of parametrized \ensuremath{\Conid{F}}-algebras. 

The fact that the parametrized initial algebra construction can be iterated, 
means that we can define nested and mutual families of data-types, such as the
tuple of neutral and normal \ensuremath{\lambda}-terms outlined in the introduction. 

As before we know that not all \ensuremath{\Conid{IFunc}^{\star}\;(\Conid{I}\;\uplus\;\Conid{J})\;\Conid{I}} functors have initial 
algebras. In the next section, however we spell out what it is for a functor to 
be given by an indexed container, and these functors are those which have such 
initial algebras.

%%Indexed Containers


\section{Indexed containers}
\label{sec:icont}


An \ensuremath{\Conid{I}}-indexed container is given by a set of shapes, and an \ensuremath{\Conid{I}}-indexed \emph{family} of positions:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{record}\;\Conid{ICont}\;(\Conid{I}\;\in\;\Conid{Set})\;\in\;\Conid{Set₁}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{constructor}\;\_\mbox{$\lhd$}\_{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{field}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Conid{S}\;\in\;\Conid{Set}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Conid{P}\;\in\;\Conid{S}\;\rightarrow\;\Conid{I}\;\rightarrow\;\Conid{Set}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

The extension of such a container is an \ensuremath{\Conid{IFunc}\;\Conid{I}}:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{11}{@{}>{\hspre}c<{\hspost}@{}}%
\column{11E}{@{}l@{}}%
\column{14}{@{}>{\hspre}l<{\hspost}@{}}%
\column{19}{@{}>{\hspre}l<{\hspost}@{}}%
\column{26}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Varid{⟦\char95 ⟧}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\rightarrow\;\Conid{ICont}\;\Conid{I}\;\rightarrow\;\Conid{IFunc}\;\Conid{I}{}\<[E]%
\\
\>[B]{}\Varid{⟦\char95 ⟧}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;(\Conid{S}\;\lhd\;\Conid{P})\;\mathrel{=}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{record}\;{}\<[11]%
\>[11]{}\{\mskip1.5mu {}\<[11E]%
\>[14]{}\Varid{obj}\;{}\<[19]%
\>[19]{}\mathrel{=}\;\lambda\;\Conid{A}\;{}\<[26]%
\>[26]{}\rightarrow\;\Sigma(\!\;\Varid{s}\;\in\;\Conid{S}\;\!)\!\times\!\;(\Conid{P}\;\Varid{s}\;\rightarrow^{\star}\;\Conid{A}){}\<[E]%
\\
\>[11]{};{}\<[11E]%
\>[14]{}\Varid{mor}\;{}\<[19]%
\>[19]{}\mathrel{=}\;\lambda\;\Varid{m}\;{}\<[26]%
\>[26]{}\rightarrow\;\lambda (\!\;\Varid{s}\;\!,\!\;\Varid{f}\;\!\!)\;\rightarrow\;(\Varid{s},\Varid{m}\;\circ^{\star}\;\Varid{f})\;\!\;\!\mskip1.5mu\}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

As with \ensuremath{\Conid{IFunc}} we can extend this notion to doubly indexed containers, where
an \ensuremath{\Conid{ICont}^{\star}\;\Conid{I}\;\Conid{J}} is a function from \ensuremath{\Conid{J}} to \ensuremath{\Conid{ICont}\;\Conid{I}}:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{record}\;\Conid{ICont}^{\star}\;(\Conid{I}\;\Conid{J}\;\in\;\Conid{Set})\;\in\;\Conid{Set₁}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{constructor}\;\anonymous \lhd^{\star}\anonymous {}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{field}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Conid{S}\;\in\;\Conid{J}\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Conid{P}\;\in\;(\Varid{j}\;\in\;\Conid{J})\;\rightarrow\;\Conid{S}\;\Varid{j}\;\rightarrow\;\Conid{I}\;\rightarrow\;\Conid{Set}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Varid{⟦\char95 ⟧*}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\;\Conid{J}\mskip1.5mu\}\;\rightarrow\;\Conid{ICont}^{\star}\;\Conid{I}\;\Conid{J}\;\rightarrow\;\Conid{IFunc}^{\star}\;\Conid{I}\;\Conid{J}{}\<[E]%
\\
\>[B]{}\Varid{⟦}\;\Conid{S}\;\lhd^{\star}\;\Conid{P}\;\Varid{⟧}^{\star}\;\Varid{i}\;\mathrel{=}\;\Varid{⟦}\;\Conid{S}\;\Varid{i}\;\lhd\;\Conid{P}\;\Varid{i}\;\Varid{⟧}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

We will denote the two projections for an \ensuremath{\Conid{ICont}} postfix as \ensuremath{\anonymous \;\!.\Conid{S}} and
\ensuremath{\anonymous \;\!.\Conid{P}}. 



\noindent
We can establish what denotes a morphism between a container \ensuremath{\Conid{S}\;\lhd\;\Conid{P}\;\in\;\Conid{ICont}\;\Conid{I}}
and functor \ensuremath{\Conid{F}\;\in\;\Conid{IFunc}\;\Conid{I}}, simply by expanding the definition and employing 
the following derivation:

\begin{align*}
                & \ensuremath{\Varid{⟦}\;\Conid{S}\;\lhd\;\Conid{P}\;\Varid{⟧}\;\Rightarrow^{\text{\tiny F}}\;\Conid{F}} & \\
  \equiv  \;    & \ensuremath{\prodd\;\Conid{X}\;.\;\Sigma(\!\;\Varid{s}\;\in\;\Conid{S}\;(\Conid{P}\;\Varid{s}\;\rightarrow^{\star}\;\Conid{X})\;\rightarrow\;\Conid{F}\;\Conid{X}} & \{\mbox{by definition}\} \\
  \equiv  \;    & \ensuremath{\prodd\;\Conid{X}\;.\;(\Varid{s}\;\in\;\Varid{s})\;\rightarrow\;(\Conid{P}\;\Varid{s}\;\rightarrow^{\star}\;\Conid{X})\;\rightarrow\;\Conid{F}\;\Conid{X}} & \{\mbox{currying}\} \\
  \cong   \;    & \ensuremath{(\Varid{s}\;\in\;\Conid{S})\;\rightarrow\;\prodd\;\Conid{X}\;.\;(\Conid{P}\;\Varid{s}\;\rightarrow^{\star}\;\Conid{X})\;\rightarrow\;\Conid{F}\;\Conid{X}} & \{\mbox{commuting end and pi} \} \\
  \cong   \;    & \ensuremath{(\Varid{s}\;\in\;\Conid{S})\;\rightarrow\;\Conid{F}\;(\Conid{P}\;\Varid{s})} & \{\mbox{Yoneda}\} \\
\end{align*}

\noindent
If \ensuremath{\Conid{F}} is also an indexed container \ensuremath{\Conid{T}\;\lhd\;\Conid{Q}} then we have:

\begin{align*}
           & \ensuremath{\Varid{⟦}\;\Conid{S}\;\lhd\;\Conid{P}\;\Varid{⟧}\;\Rightarrow^{\text{\tiny F}}\;\Varid{⟦}\;\Conid{T}\;\lhd\;\Conid{Q}\;\Varid{⟧}} \\
 \cong \;  & \ensuremath{(\Varid{s}\;\in\;\Conid{S})\;\rightarrow\;\Sigma(\!\;\Varid{t}\;\in\;\Conid{T}\;^{\star}\;\!)\!\times\!\;(\Conid{Q}\;\Varid{t}\;\rightarrow^{\star}\;\Conid{P}\;\Varid{s})} \\
 \cong \;  & \ensuremath{\Sigma(\!\;\Varid{f}\;\in\;\Conid{S}\;\rightarrow\;\Conid{T}\;\!)\!\times\!\;((\Varid{s}\;\in\;\Conid{S})\;\rightarrow\;\Conid{Q}\;(\Varid{f}\;\Varid{s})\;\rightarrow^{\star}\;\Conid{P}\;\Varid{s})}
\end{align*}
 
We will use this last line as the definition for container morphisms, captured by 
this record type:  

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{record}\;\anonymous \Rightarrow^{\text{\tiny C}}\anonymous \;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;(\Conid{C}\;\Conid{D}\;\in\;\Conid{ICont}\;\Conid{I})\;\in\;\Conid{Set₁}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{constructor}\;\_\mbox{$\lhd$}\_{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{field}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{f}\;\in\;\Conid{C}\;\!.\Conid{S}\;\rightarrow\;\Conid{D}\;\!.\Conid{S}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{r}\;\in\;(\Varid{s}\;\in\;\Conid{C}\;\!.\Conid{S})\;\rightarrow\;(\Conid{D}\;\!.\Conid{P}\;\!\!\;(\Varid{f}\;\Varid{s}))\;\rightarrow^{\star}\;(\Conid{C}\;\!.\Conid{P}\;\!\!\;\Varid{s}){}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\noindent
We witness one side of the isomorphism between container morphisms and natural 
transformations:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{15}{@{}>{\hspre}l<{\hspost}@{}}%
\column{41}{@{}>{\hspre}l<{\hspost}@{}}%
\column{44}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Varid{⟦}\anonymous \Varid{⟧}\mbox{$\!^{\Rightarrow}$}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;{}\<[15]%
\>[15]{}\{\mskip1.5mu \Conid{C}\;\Conid{D}\;\in\;\Conid{ICont}\;\Conid{I}\mskip1.5mu\}\;(\Varid{m}\;\in\;\Conid{C}\;\Rightarrow^{\text{\tiny C}}\;\Conid{D})\;{}\<[44]%
\>[44]{}\rightarrow\;{}\<[E]%
\\
\>[15]{}\prodd\;\Conid{A}\;.\;\!\;\Varid{⟦}\;\Conid{C}\;\Varid{⟧}\;\Conid{A}\;{}\<[41]%
\>[41]{}\rightarrow\;\!\;\Varid{⟦}\;\Conid{D}\;\Varid{⟧}\;\Conid{A}{}\<[E]%
\\
\>[B]{}\Varid{⟦}\;\Varid{f}\;\lhd\;\Varid{r}\;\Varid{⟧}\mbox{$\!^{\Rightarrow}$}\;(\Varid{s},\Varid{g})\;\mathrel{=}\;\Varid{f}\;\Varid{s},\Varid{g}\;\circ^{\star}\;\Varid{r}\;\Varid{s}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\begin{proposition}

The functor \ensuremath{(\Varid{⟦\char95 ⟧\char95 },\Varid{⟦\char95 ⟧⇒\char95 })} in \ensuremath{[\mskip1.5mu \Conid{ICont}\;\Conid{I},\Conid{IFunc}\;\Conid{I}\mskip1.5mu]} is full and faithful.

\end{proposition}

\begin{proof}

By construction.

%%\begin{code}
%%
%%q : {I : Set} (C D : ICont I) → ({A : I → Set}  → IFunc.obj ⟦  C ⟧ A  → IFunc.%%obj ⟦  D ⟧ A) 
%%                                                →              C      ⇒       %%       D
%%q C D m = (proj₁ ∘ eureka) ◁ (proj₂ ∘ eureka)
%% where
%%  eureka : (s : C projS) → IFunc.obj ⟦ D ⟧ (C projP $$ s)
%%  eureka s =  m (s , idd)
%%
%%\end{code}
%%
%%By naturality this must be the unique inverse to the extesion of a container
%%morphism given above.
%%

\end{proof}

We can lift this functor to the doubly indexed variant:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{12}{@{}>{\hspre}l<{\hspost}@{}}%
\column{35}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{record}\;\anonymous \Rightarrow^{\text{\tiny C}^{\star}}\anonymous \;\{\mskip1.5mu \Conid{I}\;\Conid{J}\mskip1.5mu\}\;(\Conid{C}\;\Conid{D}\;\in\;\Conid{ICont}^{\star}\;\Conid{I}\;\Conid{J})\;\in\;\Conid{Set₁}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{constructor}\;\anonymous \lhd^{\star}\anonymous {}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{field}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{f}\;\in\;\Conid{C}\;\!.\Conid{S}\;\rightarrow^{\star}\;\Conid{D}\;\!.\Conid{S}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{r}\;\in\;\{\mskip1.5mu \Varid{j}\;\in\;\Conid{J}\mskip1.5mu\}\;(\Varid{s}\;\in\;\Conid{C}\;\!.\Conid{S}\;\!\!\;\Varid{j})\;\rightarrow\;(\Conid{D}\;\!.\Conid{P}\;\!\!\;\Varid{j}\;\!\!\;(\Varid{f}\;\Varid{j}\;\Varid{s}))\;\rightarrow^{\star}\;(\Conid{C}\;\!.\Conid{P}\;\!\!\;\Varid{j}\;\!\!\;\Varid{s}){}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Varid{⟦\char95 ⟧⇒*}\;\in\;\forall{}\;{}\<[12]%
\>[12]{}\{\mskip1.5mu \Conid{I}\;\Conid{J}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{C}\;\Conid{D}\;\in\;\Conid{ICont}^{\star}\;\Conid{I}\;\Conid{J}\mskip1.5mu\}\;(\Varid{m}\;\in\;\Conid{C}\;\Rightarrow^{\text{\tiny C}^{\star}}\;\Conid{D})\;\rightarrow\;{}\<[E]%
\\
\>[12]{}\prodd\;\Conid{A}\;.\;(\;\Varid{⟦}\;\Conid{C}\;\Varid{⟧}^{\star}\;\Conid{A}\;{}\<[35]%
\>[35]{}\rightarrow^{\star}\;\;\Varid{⟦}\;\Conid{D}\;\Varid{⟧}^{\star}\;\Conid{A}){}\<[E]%
\\
\>[B]{}\Varid{⟦}\;\Varid{f}\;\lhd^{\star}\;\Varid{r}\;\Varid{⟧}\mbox{$\!^{\Rightarrow^{\!\star}}$}\;\Varid{j}\;\mathrel{=}\;\Varid{⟦}\;(\Varid{f}\;\Varid{j})\;\lhd\;\Varid{r}\;\Varid{⟧}\mbox{$\!^{\Rightarrow}$}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks




As with \ensuremath{\Conid{IFunc}}, we can equip \ensuremath{\Conid{ICont}} with a relative monadic structure:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{6}{@{}>{\hspre}l<{\hspost}@{}}%
\column{34}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\eta^{\text{\tiny C}}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\rightarrow\;\Conid{I}\;\rightarrow\;\Conid{ICont}\;\Conid{I}{}\<[E]%
\\
\>[B]{}\eta^{\text{\tiny C}}\;\Varid{i}\;\mathrel{=}\;\top\;\lhd\;\lambda\;\anonymous \;\Varid{i′}\;\rightarrow\;\Varid{i}\;\equiv\;\Varid{i′}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\anonymous \bind ^{\text{\tiny C}}\anonymous \;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\;\Conid{J}\mskip1.5mu\}\;\rightarrow\;\Conid{ICont}\;\Conid{I}\;\rightarrow\;\Conid{ICont}^{\star}\;\Conid{J}\;\Conid{I}\;\rightarrow\;\Conid{ICont}\;\Conid{J}{}\<[E]%
\\
\>[B]{}\anonymous \bind ^{\text{\tiny C}}\anonymous \;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;(\Conid{S}\;\lhd\;\Conid{P})\;(\Conid{T}\;\lhd^{\star}\;\Conid{Q})\;\mathrel{=}\;{}\<[E]%
\\
\>[B]{}\hsindent{6}{}\<[6]%
\>[6]{}(\!\;\Varid{⟦}\;\Conid{S}\;\lhd\;\Conid{P}\;\Varid{⟧}\;\Conid{T})\;{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\lhd\;{}\<[6]%
\>[6]{}\lambda (\!\;\Varid{s}\;\!,\!\;\Varid{f}\;\!\!)\;\Varid{j}\;\!\;\rightarrow\;\Sigma\;{}\<[34]%
\>[34]{}(\Sigma(\!\;\Varid{i}\;\in\;\Conid{I}\;\!)\!\times\!\;\Conid{P}\;\Varid{s}\;\Varid{i})\;(\lambda (\!\;\Varid{i}\;\!,\!\;\Varid{p}\;\!\!)\;\rightarrow\;\Conid{Q}\;\Varid{i}\;(\Varid{f}\;\Varid{i}\;\Varid{p})\;\Varid{j}\;\!\;\!)\;\!\;\!{}\<[E]%
\ColumnHook
\end{hscode}\resethooks


\begin{proposition}

The triple \ensuremath{(\Conid{ICont},\eta^{\text{\tiny C}},\anonymous \bind ^{\text{\tiny C}}\anonymous )} is a relative monad.

\end{proposition}

\begin{proof}

Instead of proving this directly, we observe that the \ensuremath{\eta^{\text{\tiny C}}} and \ensuremath{\anonymous \bind ^{\text{\tiny C}}\anonymous }
are preserved under \ensuremath{\Varid{⟦\char95 ⟧\char95 }}, i.e.:

\begin{align*}
\ensuremath{\Varid{⟦}\;\eta^{\text{\tiny C}}\;\Varid{i}\;\Varid{⟧}} && \approx &&& \ensuremath{\eta^{\text{\tiny F}}\;\Varid{i}} \\
\ensuremath{\Varid{⟦}\;\Conid{C}\;\bind ^{\text{\tiny C}}\;\Conid{D}\;\Varid{⟧}} && \approx &&& \ensuremath{\Varid{⟦}\;\Conid{C}\;\Varid{⟧}^{\star}\;\bind ^{\text{\tiny F}}\;\Varid{⟦}\;\Conid{D}\;\Varid{⟧}} \\
\end{align*}

Which follow from the extensionality of our propositional equality, the 
associativity of \ensuremath{\Sigma} and the terminality of \ensuremath{\top}. By the full and faithful 
nature of the embedding into \ensuremath{\Conid{IFunc}} we can then reuse the result that
\ensuremath{(\Conid{IFunc},\eta^{\text{\tiny F}},\anonymous \bind ^{\text{\tiny F}}\anonymous )} is a relative monad.

\end{proof}


As with indexed functors, the re-indexing \ensuremath{\Delta^{\text{\tiny C}}} is defined by composition, and 
has left and right adjoints \ensuremath{\Sigma^{\text{\tiny C}}} and \ensuremath{\Pi^{\text{\tiny C}}}:


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{8}{@{}>{\hspre}l<{\hspost}@{}}%
\column{21}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[3]{}\Delta^{\text{\tiny C}}\;\in\;(\Conid{J}\;\rightarrow\;\Conid{K})\;\rightarrow\;\Conid{ICont}^{\star}\;\Conid{I}\;\Conid{K}\;\rightarrow\;\Conid{ICont}^{\star}\;\Conid{I}\;\Conid{J}{}\<[E]%
\\
\>[3]{}\Delta^{\text{\tiny C}}\;\Varid{f}\;\Conid{F}\;\mathrel{=}\;\!\!\;\lambda\;\Varid{k}\;\rightarrow\;\Conid{F}\;\!\!\;(\Varid{f}\;\Varid{k}){}\<[E]%
\\[\blanklineskip]%
\>[3]{}\Sigma^{\text{\tiny C}}\;\in\;(\Conid{J}\;\rightarrow\;\Conid{K})\;\rightarrow\;\Conid{ICont}^{\star}\;\Conid{I}\;\Conid{J}\;\rightarrow\;\Conid{ICont}^{\star}\;\Conid{I}\;\Conid{K}{}\<[E]%
\\
\>[3]{}\Sigma^{\text{\tiny C}}\;\Varid{f}\;(\Conid{S}\;\lhd^{\star}\;\Conid{P})\;\mathrel{=}\;\!\!\;\lambda\;\Varid{k}\;\rightarrow\;{}\<[E]%
\\
\>[3]{}\hsindent{5}{}\<[8]%
\>[8]{}(\Sigma(\!\;\Varid{j}\;\in\;\Conid{J}\;\!)\!\times\!\;(\Varid{f}\;\Varid{j}\;\equiv\;\Varid{k}\;\times\;\Conid{S}\;\Varid{j}))\;{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\lhd\;{}\<[8]%
\>[8]{}\lambda (\!\;\Varid{j}\;\!,\!\;\Varid{eq}\;\!,\!\;\Varid{s}\;\!\!)\;\rightarrow\;\Conid{P}\;\Varid{j}\;\Varid{s}\;\!\;\!{}\<[E]%
\\[\blanklineskip]%
\>[3]{}\Pi^{\text{\tiny C}}\;\in\;(\Conid{J}\;\rightarrow\;\Conid{K})\;\rightarrow\;\Conid{ICont}^{\star}\;\Conid{I}\;\Conid{J}\;\rightarrow\;\Conid{ICont}^{\star}\;\Conid{I}\;\Conid{K}{}\<[E]%
\\
\>[3]{}\Pi^{\text{\tiny C}}\;\Varid{f}\;(\Conid{S}\;\lhd^{\star}\;\Conid{P})\;\mathrel{=}\;{}\<[21]%
\>[21]{}\!\!\;\lambda\;\Varid{k}\;\rightarrow\;{}\<[E]%
\\
\>[3]{}\hsindent{5}{}\<[8]%
\>[8]{}((\Varid{j}\;\in\;\Conid{J})\;\rightarrow\;\Varid{f}\;\Varid{j}\;\equiv\;\Varid{k}\;\rightarrow\;\Conid{S}\;\Varid{j})\;{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\lhd\;{}\<[8]%
\>[8]{}\lambda\;\Varid{s}\;\Varid{i}\;\rightarrow\;\Sigma(\!\;\Varid{j}\;\in\;\Conid{J}\;\!)\!\times\!\;(\Sigma(\!\;\Varid{eq}\;\in\;\Varid{f}\;\Varid{j}\;\equiv\;\Varid{k}\;\!)\!\times\!\;\Conid{P}\;\Varid{j}\;(\Varid{s}\;\Varid{j}\;\Varid{eq})\;\Varid{i}){}\<[E]%
\ColumnHook
\end{hscode}\resethooks


\begin{proposition}
\ensuremath{\Sigma^{\text{\tiny C}}} and \ensuremath{\Pi^{\text{\tiny C}}} are left and right adjoint to re-indexing (\ensuremath{\Delta^{\text{\tiny C}}}).
\end{proposition}

\begin{proof}

Again we appeal to the full and faithfulness of \ensuremath{\Varid{⟦\char95 ⟧\char95 }} and show instead that
the embedding into \ensuremath{\Conid{IFunc}} preserves these constructions. That, is we want to show that the following three statements hold:

\begin{align*}
\ensuremath{\Varid{⟦}\;\Sigma^{\text{\tiny C}}\;\Varid{f}\;\Conid{F}\;\Varid{j}\;\Varid{⟧}} && \approx &&& \ensuremath{\Sigma^{\text{\tiny F}}\;\Varid{f}\;\Varid{⟦}\;\Conid{F}\;\Varid{⟧}^{\star}\;\Varid{j}} \\
\ensuremath{\Varid{⟦}\;\Delta^{\text{\tiny C}}\;\Varid{f}\;\Conid{F}\;\Varid{j}\;\Varid{⟧}} && \equiv &&& \ensuremath{\Delta^{\text{\tiny F}}\;\Varid{f}\;\Varid{⟦}\;\Conid{F}\;\Varid{⟧}^{\star}\;\Varid{j}} \\
\ensuremath{\Varid{⟦}\;\Pi^{\text{\tiny C}}\;\Varid{f}\;\Conid{F}\;\Varid{j}\;\Varid{⟧}} && \approx &&& \ensuremath{\Pi^{\text{\tiny F}}\;\Varid{f}\;\Varid{⟦}\;\Conid{F}\;\Varid{⟧}^{\star}\;\Varid{j}} \\
\end{align*}

These can be proved simply by employing the associativity of \ensuremath{\Sigma}.

\end{proof}




Before we build the initial algebras of indexed containers, it will help to 
define their partial application. 

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{8}{@{}>{\hspre}l<{\hspost}@{}}%
\column{10}{@{}>{\hspre}l<{\hspost}@{}}%
\column{12}{@{}>{\hspre}l<{\hspost}@{}}%
\column{13}{@{}>{\hspre}l<{\hspost}@{}}%
\column{17}{@{}>{\hspre}l<{\hspost}@{}}%
\column{22}{@{}>{\hspre}l<{\hspost}@{}}%
\column{39}{@{}>{\hspre}c<{\hspost}@{}}%
\column{39E}{@{}l@{}}%
\column{42}{@{}>{\hspre}l<{\hspost}@{}}%
\column{46}{@{}>{\hspre}l<{\hspost}@{}}%
\column{49}{@{}>{\hspre}l<{\hspost}@{}}%
\column{52}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\anonymous [\mskip1.5mu \anonymous \mskip1.5mu]^{\text{\tiny C}}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\;\Conid{J}\mskip1.5mu\}\;\rightarrow\;\Conid{ICont}\;(\Conid{I}\;\uplus\;\Conid{J})\;\rightarrow\;\Conid{ICont}^{\star}\;\Conid{I}\;\Conid{J}\;\rightarrow\;\Conid{ICont}\;\Conid{I}{}\<[E]%
\\
\>[B]{}\anonymous [\mskip1.5mu \anonymous \mskip1.5mu]^{\text{\tiny C}}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{J}\mskip1.5mu\}\;(\Conid{S}\;\lhd\;\Conid{P})\;(\Conid{T}\;\lhd^{\star}\;\Conid{Q})\;\mathrel{=}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{let}\;{}\<[8]%
\>[8]{}\Conid{P}^{\Conid{I}}\;{}\<[12]%
\>[12]{}\in\;\Conid{S}\;{}\<[17]%
\>[17]{}\rightarrow\;\Conid{I}\;{}\<[22]%
\>[22]{}\rightarrow\;\Conid{Set}{}\<[39]%
\>[39]{};{}\<[39E]%
\>[42]{}\Conid{P}^{\Conid{I}}\;{}\<[46]%
\>[46]{}\Varid{s}\;{}\<[49]%
\>[49]{}\Varid{i}\;{}\<[52]%
\>[52]{}\mathrel{=}\;\Conid{P}\;\Varid{s}\;(\Varid{inl}\;\Varid{i}){}\<[E]%
\\
\>[8]{}\Conid{P}^{\Conid{J}}\;{}\<[12]%
\>[12]{}\in\;\Conid{S}\;{}\<[17]%
\>[17]{}\rightarrow\;\Conid{J}\;{}\<[22]%
\>[22]{}\rightarrow\;\Conid{Set}{}\<[39]%
\>[39]{};{}\<[39E]%
\>[42]{}\Conid{P}^{\Conid{J}}\;{}\<[46]%
\>[46]{}\Varid{s}\;{}\<[49]%
\>[49]{}\Varid{j}\;{}\<[52]%
\>[52]{}\mathrel{=}\;\Conid{P}\;\Varid{s}\;(\Varid{inr}\;\Varid{j}){}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{in}\;{}\<[8]%
\>[8]{}\!\;\Varid{⟦}\;\Conid{S}\;\lhd\;\Conid{P}^{\Conid{J}}\;\Varid{⟧}\;\Conid{T}\;\lhd\;{}\<[E]%
\\
\>[8]{}\hsindent{5}{}\<[13]%
\>[13]{}(\lambda (\!\;\Varid{s}\;\!,\!\;\Varid{f}\;\!\!)\;\Varid{i}\;\!\;\rightarrow\;\Conid{P}^{\Conid{I}}\;\Varid{s}\;\Varid{i}{}\<[E]%
\\
\>[8]{}\hsindent{2}{}\<[10]%
\>[10]{}\uplus\;{}\<[13]%
\>[13]{}(\Sigma(\!\;\Varid{j}\;\in\;\Conid{J}\;\!)\!\times\!\;(\Sigma(\!\;\Varid{p}\;\in\;\Conid{P}^{\Conid{J}}\;\Varid{s}\;\Varid{j}\;\!)\!\times\!\;\Conid{Q}\;\Varid{j}\;(\Varid{f}\;\Varid{j}\;\Varid{p})\;\Varid{i}))\;\!\;\!){}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\noindent
The composite container has shapes given by a shape \ensuremath{\Varid{s}\;\in\;\Conid{S}} and an assignment
of \ensuremath{\Conid{T}} shapes to \ensuremath{\Conid{P}^{\Conid{J}}\;\Varid{s}} positions. Positions are then a choice between a
\ensuremath{\Conid{I}}-indexed position, or a pair of an \ensuremath{\Conid{J}}-indexed position, and a \ensuremath{\Conid{Q}}
position \emph{underneath} the appropriate \ensuremath{\Conid{T}} shape. 


\noindent
As with indexed functors, this construction is functorial in its second 
argument, and lifts container morphisms in this way:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}c<{\hspost}@{}}%
\column{3E}{@{}l@{}}%
\column{6}{@{}>{\hspre}l<{\hspost}@{}}%
\column{11}{@{}>{\hspre}l<{\hspost}@{}}%
\column{14}{@{}>{\hspre}l<{\hspost}@{}}%
\column{21}{@{}>{\hspre}l<{\hspost}@{}}%
\column{28}{@{}>{\hspre}l<{\hspost}@{}}%
\column{33}{@{}>{\hspre}l<{\hspost}@{}}%
\column{38}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\anonymous [\mskip1.5mu \anonymous \mskip1.5mu]^{\text{\tiny C}}\;\in\;{}\<[11]%
\>[11]{}\forall{}\;{}\<[14]%
\>[14]{}\{\mskip1.5mu \Conid{I}\;\Conid{J}\mskip1.5mu\}\;(\Conid{C}\;\in\;\Conid{ICont}\;(\Conid{I}\;\uplus\;\Conid{J}))\;\{\mskip1.5mu \Conid{D}\;\Conid{E}\;\in\;\Conid{ICont}^{\star}\;\Conid{I}\;\Conid{J}\mskip1.5mu\}\;\rightarrow\;{}\<[E]%
\\
\>[14]{}\hsindent{7}{}\<[21]%
\>[21]{}\Conid{D}\;{}\<[28]%
\>[28]{}\Rightarrow^{\text{\tiny C}^{\star}}\;{}\<[38]%
\>[38]{}\Conid{E}\;{}\<[E]%
\\
\>[14]{}\rightarrow\;\Conid{C}\;[\mskip1.5mu \;{}\<[21]%
\>[21]{}\Conid{D}\;\mskip1.5mu]^{\text{\tiny C}}\;{}\<[28]%
\>[28]{}\Rightarrow^{\text{\tiny C}}\;{}\<[33]%
\>[33]{}\Conid{C}\;[\mskip1.5mu \;{}\<[38]%
\>[38]{}\Conid{E}\;\mskip1.5mu]^{\text{\tiny C}}{}\<[E]%
\\
\>[B]{}\Conid{C}\;[\mskip1.5mu \;\gamma\;\mskip1.5mu]^{\text{\tiny C}}\;\mathrel{=}\;{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}({}\<[3E]%
\>[6]{}\lambda (\!\;\Varid{s}\;\!,\!\;\Varid{f}\;\!\!)\;\rightarrow\;(\Varid{s},\lambda\;\Varid{j}\;\Varid{p}\;\rightarrow\;\gamma\;\!.\Varid{f}\;\!\!\;\Varid{j}\;\!\!\;(\Varid{f}\;\Varid{j}\;\Varid{p}))\;\!\;\!)\;\lhd\;{}\<[E]%
\\
\>[6]{}\lambda (\!\;\Varid{s}\;\!,\!\;\Varid{f}\;\!\!)\;\Varid{i}\;\!\;\rightarrow\;[\mskip1.5mu \Varid{inl},(\lambda (\!\;\Varid{j}\;\!,\!\;\Varid{p}\;\!,\!\;\Varid{q}\;\!\!)\;\rightarrow\;\Varid{inr}\;(\Varid{j},\Varid{p},\gamma\;\!.\Varid{r}\;\!\!\;\Varid{j}\;\!\!\;(\Varid{f}\;\Varid{j}\;\Varid{p})\;\!\!\;\Varid{i}\;\!\!\;\Varid{q})\;\!\;\!)\mskip1.5mu]\;\!\;\!{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

%%Init Alg ICont


\section{Initial Algebras of Indexed Containers}
\label{sec:initalg}

We will now examine how to construct the initial algebra of a container of
the form \ensuremath{\Conid{F}\;\in\;\Conid{ICont}^{\star}\;(\Conid{I}\;\uplus\;\Conid{J})\;\Conid{J}}. The shapes of such a container are an
\ensuremath{\Conid{J}}-indexed family of \ensuremath{\Conid{Set}}s and the positions are indexed by \ensuremath{\Conid{I}\;\uplus\;\Conid{J}}; we
will treat these position as two separate entities, those positions indexed
by \ensuremath{\Conid{I}} -- the recursive positions -- and those by \ensuremath{\Conid{J}} -- the payload
positions.

The shapes of initial algebra we are constructing will be trees with S shapes
at the nodes and which branch over the recursive \ensuremath{\Conid{P}^{\Conid{I}}} positions. We call
these trees \emph{indexed} \ensuremath{\Conid{W}}-types, denoted \ensuremath{\Conid{WI}} and they are the initial
algebra of the functor \ensuremath{\Varid{⟦}\;\Conid{S}\;\lhd\;\Conid{P}^{\Conid{J}}\;\Varid{⟧}^{\star}}:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{10}{@{}>{\hspre}l<{\hspost}@{}}%
\column{11}{@{}>{\hspre}l<{\hspost}@{}}%
\column{14}{@{}>{\hspre}l<{\hspost}@{}}%
\column{18}{@{}>{\hspre}l<{\hspost}@{}}%
\column{38}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{data}\;\Conid{WI}\;{}\<[10]%
\>[10]{}\{\mskip1.5mu \Conid{J}\;\in\;\Conid{Set}\mskip1.5mu\}\;(\Conid{S}\;\in\;\Conid{J}\;\rightarrow\;\Conid{Set})\;{}\<[E]%
\\
\>[10]{}(\Conid{P}^{\Conid{J}}\;\in\;(\Varid{j}\;\in\;\Conid{J})\;\rightarrow\;\Conid{S}\;\Varid{j}\;\rightarrow\;\Conid{J}\;\rightarrow\;\Conid{Set})\;\in\;\Conid{J}\;\rightarrow\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{sup}\;\in\;\;\Varid{⟦}\;\Conid{S}\;\lhd^{\star}\;\Conid{P}^{\Conid{J}}\;\Varid{⟧}^{\star}\;(\Conid{WI}\;\Conid{S}\;\Conid{P}^{\Conid{J}})\;{}\<[38]%
\>[38]{}\rightarrow^{\star}\;\Conid{WI}\;\Conid{S}\;\Conid{P}^{\Conid{J}}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Conid{WIfold}\;\in\;{}\<[11]%
\>[11]{}\forall{}\;{}\<[14]%
\>[14]{}\{\mskip1.5mu \Conid{J}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{X}\;\in\;\Conid{J}\;\rightarrow\;\Conid{Set}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{S}\;\in\;\Conid{J}\;\rightarrow\;\Conid{Set}\mskip1.5mu\}\;{}\<[E]%
\\
\>[14]{}\{\mskip1.5mu \Conid{P}^{\Conid{J}}\;\in\;(\Varid{j}\;\in\;\Conid{J})\;\rightarrow\;\Conid{S}\;\Varid{j}\;\rightarrow\;\Conid{J}\;\rightarrow\;\Conid{Set}\mskip1.5mu\}\;\rightarrow\;\;{}\<[E]%
\\
\>[14]{}\hsindent{4}{}\<[18]%
\>[18]{}\Varid{⟦}\;\Conid{S}\;\lhd^{\star}\;\Conid{P}^{\Conid{J}}\;\Varid{⟧}^{\star}\;\Conid{X}\;\rightarrow^{\star}\;\Conid{X}\;\rightarrow\;\Conid{WI}\;\Conid{S}\;\Conid{P}^{\Conid{J}}\;\rightarrow^{\star}\;\Conid{X}{}\<[E]%
\\
\>[B]{}\Conid{WIfold}\;\Varid{f}\;\Varid{j}\;(\Varid{sup}\;(\Varid{s},\Varid{g}))\;\mathrel{=}\;\Varid{f}\;\Varid{j}\;(\Varid{s},\lambda\;\Varid{j′}\;\Varid{p}\;\rightarrow\;\Conid{WIfold}\;\Varid{f}\;\Varid{j′}\;(\Varid{g}\;\Varid{j′}\;\Varid{p})){}\<[E]%
\ColumnHook
\end{hscode}\resethooks


\noindent
This mirrors the construction for plain containers, where we can view
ordinary \ensuremath{\Conid{W}} types as the initial algebra of a container functor.

Positions are given by paths through such a tree, terminated by a
non-recursive \ensuremath{\Conid{P}^{\Conid{I}}}:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{12}{@{}>{\hspre}l<{\hspost}@{}}%
\column{13}{@{}>{\hspre}l<{\hspost}@{}}%
\column{16}{@{}>{\hspre}l<{\hspost}@{}}%
\column{17}{@{}>{\hspre}l<{\hspost}@{}}%
\column{38}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{data}\;\Conid{Path}\;{}\<[12]%
\>[12]{}\{\mskip1.5mu \Conid{I}\;\Conid{J}\;\in\;\Conid{Set}\mskip1.5mu\}\;(\Conid{S}\;\in\;\Conid{J}\;\rightarrow\;\Conid{Set})\;{}\<[E]%
\\
\>[12]{}(\Conid{P}^{\Conid{I}}\;{}\<[17]%
\>[17]{}\in\;(\Varid{j}\;\in\;\Conid{J})\;\rightarrow\;\Conid{S}\;\Varid{j}\;\rightarrow\;\Conid{I}\;{}\<[38]%
\>[38]{}\rightarrow\;\Conid{Set})\;{}\<[E]%
\\
\>[12]{}(\Conid{P}^{\Conid{J}}\;{}\<[17]%
\>[17]{}\in\;(\Varid{j}\;\in\;\Conid{J})\;\rightarrow\;\Conid{S}\;\Varid{j}\;\rightarrow\;\Conid{J}\;{}\<[38]%
\>[38]{}\rightarrow\;\Conid{Set})\;{}\<[E]%
\\
\>[12]{}\in\;(\Varid{j}\;\in\;\Conid{J})\;\rightarrow\;\Conid{WI}\;\Conid{S}\;\Conid{P}^{\Conid{J}}\;\Varid{j}\;\rightarrow\;\Conid{I}\;\rightarrow\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{path}\;\in\;\forall{}\;{}\<[13]%
\>[13]{}\{\mskip1.5mu \Varid{j}\;\Varid{s}\;\Varid{f}\;\Varid{i}\mskip1.5mu\}\;\rightarrow\;{}\<[E]%
\\
\>[13]{}\hsindent{3}{}\<[16]%
\>[16]{}\Conid{P}^{\Conid{I}}\;\Varid{j}\;\Varid{s}\;\Varid{i}\;{}\<[E]%
\\
\>[13]{}\uplus\;{}\<[16]%
\>[16]{}(\Sigma(\!\;\Varid{j′}\;\in\;\Conid{J}\;\!)\!\times\!\;(\Sigma(\!\;\Varid{p}\;\in\;\Conid{P}^{\Conid{J}}\;\Varid{j}\;\Varid{s}\;\Varid{j′}\;\!)\!\times\!\;\Conid{Path}\;\Conid{S}\;\Conid{P}^{\Conid{I}}\;\Conid{P}^{\Conid{J}}\;\Varid{j′}\;(\Varid{f}\;\Varid{j′}\;\Varid{p})\;\Varid{i}))\;{}\<[E]%
\\
\>[13]{}\rightarrow\;\Conid{Path}\;\Conid{S}\;\Conid{P}^{\Conid{I}}\;\Conid{P}^{\Conid{J}}\;\Varid{j}\;(\Varid{sup}\;(\Varid{s},\Varid{f}))\;\Varid{i}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks



\noindent
Again this mirrors the partial application construction where positions were 
given by a \ensuremath{\Conid{P}^{\Conid{J}}} position at the top level, or a pair of a \ensuremath{\Conid{P}^{\Conid{J}}} position and a 
sub \ensuremath{\Conid{Q}} position. Here the \ensuremath{\Conid{Q}} positions are recursive \ensuremath{\Conid{Path}} positions. 


\noindent
We can now give the object part of the parametrised initial algebra of a
container, given by:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{8}{@{}>{\hspre}l<{\hspost}@{}}%
\column{12}{@{}>{\hspre}l<{\hspost}@{}}%
\column{33}{@{}>{\hspre}l<{\hspost}@{}}%
\column{42}{@{}>{\hspre}l<{\hspost}@{}}%
\column{46}{@{}>{\hspre}l<{\hspost}@{}}%
\column{54}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\mu^{\text{\tiny C}}\;\in\;\{\mskip1.5mu \Conid{I}\;\Conid{J}\;\in\;\Conid{Set}\mskip1.5mu\}\;\rightarrow\;\Conid{ICont}^{\star}\;(\Conid{I}\;\uplus\;\Conid{J})\;\Conid{J}\;\rightarrow\;\Conid{ICont}^{\star}\;\Conid{I}\;\Conid{J}{}\<[E]%
\\
\>[B]{}\mu^{\text{\tiny C}}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{J}\mskip1.5mu\}\;(\Conid{S}\;\lhd^{\star}\;\Conid{P})\;\mathrel{=}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{let}\;{}\<[8]%
\>[8]{}\Conid{P}^{\Conid{I}}\;{}\<[12]%
\>[12]{}\in\;(\Varid{j}\;\in\;\Conid{J})\;\rightarrow\;\Conid{S}\;\Varid{j}\;\rightarrow\;\Conid{I}\;{}\<[33]%
\>[33]{}\rightarrow\;\Conid{Set};{}\<[42]%
\>[42]{}\Conid{P}^{\Conid{I}}\;{}\<[46]%
\>[46]{}\Varid{j}\;\Varid{s}\;\Varid{i}\;{}\<[54]%
\>[54]{}\mathrel{=}\;\Conid{P}\;\!\!\;\Varid{j}\;\!\!\;\Varid{s}\;\!\!\;(\Varid{inl}\;\Varid{i}){}\<[E]%
\\
\>[8]{}\Conid{P}^{\Conid{J}}\;{}\<[12]%
\>[12]{}\in\;(\Varid{j}\;\in\;\Conid{J})\;\rightarrow\;\Conid{S}\;\Varid{j}\;\rightarrow\;\Conid{J}\;{}\<[33]%
\>[33]{}\rightarrow\;\Conid{Set};{}\<[42]%
\>[42]{}\Conid{P}^{\Conid{J}}\;{}\<[46]%
\>[46]{}\Varid{j}\;\Varid{s}\;\Varid{j′}\;{}\<[54]%
\>[54]{}\mathrel{=}\;\Conid{P}\;\!\!\;\Varid{j}\;\!\!\;\Varid{s}\;\!\!\;(\Varid{inr}\;\Varid{j′}){}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{in}\;{}\<[8]%
\>[8]{}\Conid{WI}\;\Conid{S}\;\Conid{P}^{\Conid{J}}\;\lhd^{\star}\;\Conid{Path}\;\Conid{S}\;\Conid{P}^{\Conid{I}}\;\Conid{P}^{\Conid{J}}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks


\noindent
The algebra map is a container morphism from the partial application of \ensuremath{\Conid{F}}
and its parametrised initial algebra, to the initial algebra, given by the
algebra map of \ensuremath{\Conid{WI}} (\ensuremath{\Varid{sup}}) and our mediation function \ensuremath{\Varid{path}}:


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Varid{in}^{\text{\tiny C}}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\;\Conid{J}\mskip1.5mu\}\;\rightarrow\;(\Conid{F}\;\in\;\Conid{ICont}^{\star}\;(\Conid{I}\;\uplus\;\Conid{J})\;\Conid{J})\;\rightarrow\;\Conid{F}\;[\mskip1.5mu \;\mu^{\text{\tiny C}}\;\Conid{F}\;\mskip1.5mu]^{\text{\tiny{C}}^{\star}}\;\Rightarrow^{\text{\tiny C}^{\star}}\;\mu^{\text{\tiny C}}\;\Conid{F}{}\<[E]%
\\
\>[B]{}\Varid{in}^{\text{\tiny C}}\;\Conid{F}\;\mathrel{=}\;(\lambda\;\anonymous \;\rightarrow\;\Varid{sup})\;\lhd^{\star}\;\lambda\;\anonymous \;\anonymous \;(\Varid{path}\;\Varid{p})\;\rightarrow\;\Varid{p}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{12}{@{}>{\hspre}l<{\hspost}@{}}%
\column{13}{@{}>{\hspre}l<{\hspost}@{}}%
\column{14}{@{}>{\hspre}l<{\hspost}@{}}%
\column{16}{@{}>{\hspre}l<{\hspost}@{}}%
\column{19}{@{}>{\hspre}l<{\hspost}@{}}%
\column{21}{@{}>{\hspre}l<{\hspost}@{}}%
\column{37}{@{}>{\hspre}l<{\hspost}@{}}%
\column{38}{@{}>{\hspre}l<{\hspost}@{}}%
\column{47}{@{}>{\hspre}l<{\hspost}@{}}%
\column{51}{@{}>{\hspre}l<{\hspost}@{}}%
\column{59}{@{}>{\hspre}l<{\hspost}@{}}%
\column{60}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Varid{fold}^{\text{\tiny C}}\;\in\;\forall{}\;{}\<[13]%
\>[13]{}\{\mskip1.5mu \Conid{I}\;\Conid{J}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{F}\;\in\;\Conid{ICont}^{\star}\;(\Conid{I}\;\uplus\;\Conid{J})\;\Conid{J}\mskip1.5mu\}\;(\Conid{G}\;\in\;\Conid{ICont}^{\star}\;\Conid{I}\;\Conid{J})\;\rightarrow\;{}\<[E]%
\\
\>[13]{}\Conid{F}\;[\mskip1.5mu \;\Conid{G}\;\mskip1.5mu]^{\text{\tiny{C}}^{\star}}\;\Rightarrow^{\text{\tiny C}^{\star}}\;\Conid{G}\;\rightarrow\;\mu^{\text{\tiny C}}\;\Conid{F}\;\Rightarrow^{\text{\tiny C}^{\star}}\;\Conid{G}{}\<[E]%
\\
\>[B]{}\Varid{fold}^{\text{\tiny C}}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{J}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{S}\;\lhd^{\star}\;\Conid{P}\mskip1.5mu\}\;(\Conid{T}\;\lhd^{\star}\;\Conid{Q})\;(\Varid{f}\;\lhd^{\star}\;\Varid{r})\;\mathrel{=}\;\Varid{ffold}\;\lhd^{\star}\;\Varid{rfold}{}\<[E]%
\\
\>[B]{}\hsindent{5}{}\<[5]%
\>[5]{}\Keyword{where}\;{}\<[12]%
\>[12]{}\Conid{P}^{\Conid{I}}\;{}\<[16]%
\>[16]{}\in\;{}\<[19]%
\>[19]{}(\Varid{j}\;\in\;\Conid{J})\;\rightarrow\;\Conid{S}\;\Varid{j}\;\rightarrow\;\Conid{I}\;{}\<[38]%
\>[38]{}\rightarrow\;\Conid{Set};{}\<[47]%
\>[47]{}\Conid{P}^{\Conid{I}}\;{}\<[51]%
\>[51]{}\Varid{j}\;\Varid{s}\;\Varid{i}\;{}\<[59]%
\>[59]{}\mathrel{=}\;\Conid{P}\;\Varid{j}\;\Varid{s}\;(\Varid{inl}\;\Varid{i}){}\<[E]%
\\
\>[12]{}\Conid{P}^{\Conid{J}}\;{}\<[16]%
\>[16]{}\in\;{}\<[19]%
\>[19]{}(\Varid{j}\;\in\;\Conid{J})\;\rightarrow\;\Conid{S}\;\Varid{j}\;\rightarrow\;\Conid{J}\;{}\<[38]%
\>[38]{}\rightarrow\;\Conid{Set};{}\<[47]%
\>[47]{}\Conid{P}^{\Conid{J}}\;{}\<[51]%
\>[51]{}\Varid{j}\;\Varid{s}\;\Varid{j′}\;{}\<[59]%
\>[59]{}\mathrel{=}\;\Conid{P}\;\Varid{j}\;\Varid{s}\;(\Varid{inr}\;\Varid{j′}){}\<[E]%
\\
\>[12]{}\Varid{ffold}\;\mathrel{=}\;\Conid{WIfold}\;\Varid{f}{}\<[E]%
\\
\>[12]{}\Varid{rfold}\;\in\;{}\<[21]%
\>[21]{}\{\mskip1.5mu \Varid{j}\;\in\;\Conid{J}\mskip1.5mu\}\;(\Varid{s}\;\in\;\Conid{WI}\;\Conid{S}\;\Conid{P}^{\Conid{J}}\;\Varid{j})\;{}\<[E]%
\\
\>[21]{}(\Varid{i}\;\in\;\Conid{I})\;\rightarrow\;\Conid{Q}\;\Varid{j}\;(\Varid{ffold}\;\Varid{j}\;\Varid{s})\;\Varid{i}\;\rightarrow\;\Conid{Path}\;\Conid{S}\;\Conid{P}^{\Conid{I}}\;\Conid{P}^{\Conid{J}}\;\Varid{j}\;\Varid{s}\;\Varid{i}{}\<[E]%
\\
\>[12]{}\Varid{rfold}\;(\Varid{sup}\;(\Varid{s},\Varid{f}))\;\Varid{i}\;\Varid{p}\;{}\<[37]%
\>[37]{}\Keyword{with}\;\Varid{r}\;(\Varid{s},\anonymous )\;\Varid{i}\;\Varid{p}{}\<[E]%
\\
\>[12]{}\Varid{rfold}\;(\Varid{sup}\;(\Varid{s},\Varid{f}))\;\Varid{i}\;\Varid{p}\;{}\<[37]%
\>[37]{}\mid \;\Varid{inl}\;\Varid{x}\;{}\<[60]%
\>[60]{}\mathrel{=}\;{}\<[E]%
\\
\>[12]{}\hsindent{2}{}\<[14]%
\>[14]{}\Varid{path}\;(\Varid{inl}\;\Varid{x}){}\<[E]%
\\
\>[12]{}\Varid{rfold}\;(\Varid{sup}\;(\Varid{s},\Varid{f}))\;\Varid{i}\;\Varid{p}\;{}\<[37]%
\>[37]{}\mid \;\Varid{inr}\;(\Varid{j′},(\Varid{q},\Varid{y}))\;{}\<[60]%
\>[60]{}\mathrel{=}\;{}\<[E]%
\\
\>[12]{}\hsindent{2}{}\<[14]%
\>[14]{}\Varid{path}\;(\Varid{inr}\;(\Varid{j′},(\Varid{q},\Varid{rfold}\;(\Varid{f}\;\Varid{j′}\;\Varid{q})\;\Varid{i}\;\Varid{y}))){}\<[E]%
\ColumnHook
\end{hscode}\resethooks

 
%%Term Co-Alg ICont


\section{Terminal Coalgebras of Indexed Containers}
\label{sec:termcoalg}

Dually to the initial algebra construction outlined above, we can also show
that indexed containers are closed under parameterised terminal coalgebras.
We proceed in much the same way as before, by first constructing the dual of
the indexed \ensuremath{\Conid{W}}-type, which we refer to as an indexed \ensuremath{\Conid{M}}-type. As you might
expect this is in fact the plain (as opposed to parametrized) terminal
coalgebra of an indexed container functor:


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{10}{@{}>{\hspre}l<{\hspost}@{}}%
\column{11}{@{}>{\hspre}l<{\hspost}@{}}%
\column{50}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{data}\;\Conid{MI}\;{}\<[10]%
\>[10]{}\{\mskip1.5mu \Conid{I}\;\in\;\Conid{Set}\mskip1.5mu\}\;(\Conid{S}\;\in\;\Conid{I}\;\rightarrow\;\Conid{Set})\;{}\<[E]%
\\
\>[10]{}(\Conid{P}^{\Conid{I}}\;\in\;(\Varid{i}\;\in\;\Conid{I})\;\rightarrow\;\Conid{S}\;\Varid{i}\;\rightarrow\;\Conid{I}\;\rightarrow\;\Conid{Set})\;\in\;\Conid{I}\;\rightarrow\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{sup}\;\in\;\;\Varid{⟦}\;\Conid{S}\;\lhd^{\star}\;\Conid{P}^{\Conid{I}}\;\Varid{⟧}^{\star}\;(\lambda\;\Varid{i}\;\rightarrow\;\infty\;(\Conid{MI}\;\Conid{S}\;\Conid{P}^{\Conid{I}}\;\Varid{i}))\;{}\<[50]%
\>[50]{}\rightarrow^{\star}\;\Conid{MI}\;\Conid{S}\;\Conid{P}^{\Conid{I}}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Varid{sup⁻¹}\;\in\;{}\<[10]%
\>[10]{}\{\mskip1.5mu \Conid{I}\;\in\;\Conid{Set}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{S}\;\in\;\Conid{I}\;\rightarrow\;\Conid{Set}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{P}^{\Conid{I}}\;\in\;(\Varid{i}\;\in\;\Conid{I})\;\rightarrow\;\Conid{S}\;\Varid{i}\;\rightarrow\;\Conid{I}\;\rightarrow\;\Conid{Set}\mskip1.5mu\}\;\rightarrow\;{}\<[E]%
\\
\>[10]{}\hsindent{1}{}\<[11]%
\>[11]{}\Conid{MI}\;\Conid{S}\;\Conid{P}^{\Conid{I}}\;\rightarrow^{\star}\;\;\Varid{⟦}\;\Conid{S}\;\lhd^{\star}\;\Conid{P}^{\Conid{I}}\;\Varid{⟧}^{\star}\;(\Conid{MI}\;\Conid{S}\;\Conid{P}^{\Conid{I}}){}\<[E]%
\\
\>[B]{}\Varid{sup⁻¹}\;(\Varid{sup}\;(\Varid{s},\Varid{f}))\;\mathrel{=}\;\Varid{s},\lambda\;\Varid{i}\;\Varid{p}\;\rightarrow\;\flat\;(\Varid{f}\;\Varid{i}\;\Varid{p}){}\<[E]%
\ColumnHook
\end{hscode}\resethooks


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{13}{@{}>{\hspre}l<{\hspost}@{}}%
\column{14}{@{}>{\hspre}l<{\hspost}@{}}%
\column{16}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Conid{MIunfold}\;\in\;{}\<[13]%
\>[13]{}\forall{}\;{}\<[16]%
\>[16]{}\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{X}\;\in\;\Conid{I}\;\rightarrow\;\Conid{Set}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{S}\;\in\;\Conid{I}\;\rightarrow\;\Conid{Set}\mskip1.5mu\}\;{}\<[E]%
\\
\>[13]{}\hsindent{1}{}\<[14]%
\>[14]{}\{\mskip1.5mu \Conid{P}^{\Conid{I}}\;\in\;(\Varid{i}\;\in\;\Conid{I})\;\rightarrow\;\Conid{S}\;\Varid{i}\;\rightarrow\;\Conid{I}\;\rightarrow\;\Conid{Set}\mskip1.5mu\}\;\rightarrow\;{}\<[E]%
\\
\>[13]{}\hsindent{1}{}\<[14]%
\>[14]{}\Conid{X}\;\rightarrow^{\star}\;\;\Varid{⟦}\;\Conid{S}\;\lhd^{\star}\;\Conid{P}^{\Conid{I}}\;\Varid{⟧}^{\star}\;\Conid{X}\;\rightarrow\;\Conid{X}\;\rightarrow^{\star}\;\Conid{MI}\;\Conid{S}\;\Conid{P}^{\Conid{I}}{}\<[E]%
\\
\>[B]{}\Conid{MIunfold}\;\Varid{m}\;\Varid{i}\;\Varid{x}\;\Keyword{with}\;\Varid{m}\;\Varid{i}\;\Varid{x}{}\<[E]%
\\
\>[B]{}\Conid{MIunfold}\;\Varid{m}\;\Varid{i}\;\Varid{x}\;\mid \;\Varid{s},\Varid{f}\;\mathrel{=}\;\Varid{sup}\;(\Varid{s},(\lambda\;\Varid{i′}\;\Varid{p}\;\rightarrow\;\sharp\;\Conid{MIunfold}\;\Varid{m}\;\Varid{i′}\;(\Varid{f}\;\Varid{i′}\;\Varid{p}))){}\<[E]%
\ColumnHook
\end{hscode}\resethooks

Here we employ Agda's approach to coprogramming (e.g. see \cite{txa:mpc2010g}), where we mark (possibly) infinite subtrees with \ensuremath{\infty}, \ensuremath{\sharp\;\in\;\Conid{A}\;\rightarrow\;\infty\;\Conid{A}} and \ensuremath{\flat\;\in\;\infty\;\Conid{A}\;\rightarrow\;\Conid{A}} pack and unpack infinite objects respectively.

The paths to positions in and indexed \ensuremath{\Conid{M}} tree, are always finite -- in fact modulo the use of \ensuremath{\flat}, this \ensuremath{\Conid{Path}} is the same as the definition for the initial algebra case.

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{12}{@{}>{\hspre}l<{\hspost}@{}}%
\column{13}{@{}>{\hspre}l<{\hspost}@{}}%
\column{16}{@{}>{\hspre}l<{\hspost}@{}}%
\column{17}{@{}>{\hspre}l<{\hspost}@{}}%
\column{38}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{data}\;\Conid{Path}\;{}\<[12]%
\>[12]{}\{\mskip1.5mu \Conid{I}\;\Conid{J}\;\in\;\Conid{Set}\mskip1.5mu\}\;(\Conid{S}\;\in\;\Conid{J}\;\rightarrow\;\Conid{Set})\;{}\<[E]%
\\
\>[12]{}(\Conid{P}^{\Conid{I}}\;{}\<[17]%
\>[17]{}\in\;(\Varid{j}\;\in\;\Conid{J})\;\rightarrow\;\Conid{S}\;\Varid{j}\;\rightarrow\;\Conid{I}\;{}\<[38]%
\>[38]{}\rightarrow\;\Conid{Set})\;{}\<[E]%
\\
\>[12]{}(\Conid{P}^{\Conid{J}}\;{}\<[17]%
\>[17]{}\in\;(\Varid{j}\;\in\;\Conid{J})\;\rightarrow\;\Conid{S}\;\Varid{j}\;\rightarrow\;\Conid{J}\;{}\<[38]%
\>[38]{}\rightarrow\;\Conid{Set})\;{}\<[E]%
\\
\>[12]{}\in\;(\Varid{j}\;\in\;\Conid{J})\;\rightarrow\;\Conid{MI}\;\Conid{S}\;\Conid{P}^{\Conid{J}}\;\Varid{j}\;\rightarrow\;\Conid{I}\;\rightarrow\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{path}\;\in\;\forall{}\;{}\<[13]%
\>[13]{}\{\mskip1.5mu \Varid{j}\;\Varid{s}\;\Varid{f}\;\Varid{i}\mskip1.5mu\}\;\rightarrow\;{}\<[E]%
\\
\>[13]{}\hsindent{3}{}\<[16]%
\>[16]{}\Conid{P}^{\Conid{I}}\;\Varid{j}\;\Varid{s}\;\Varid{i}\;{}\<[E]%
\\
\>[13]{}\uplus\;{}\<[16]%
\>[16]{}(\Sigma(\!\;\Varid{j′}\;\in\;\Conid{J}\;\!)\!\times\!\;(\Sigma(\!\;\Varid{p}\;\in\;\Conid{P}^{\Conid{J}}\;\Varid{j}\;\Varid{s}\;\Varid{j′}\;\!)\!\times\!\;\Conid{Path}\;\Conid{S}\;\Conid{P}^{\Conid{I}}\;\Conid{P}^{\Conid{J}}\;\Varid{j′}\;(\flat\;(\Varid{f}\;\Varid{j′}\;\Varid{p}))\;\Varid{i}))\;{}\<[E]%
\\
\>[13]{}\rightarrow\;\Conid{Path}\;\Conid{S}\;\Conid{P}^{\Conid{I}}\;\Conid{P}^{\Conid{J}}\;\Varid{j}\;(\Varid{sup}\;(\Varid{s},\Varid{f}))\;\Varid{i}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

The parameterised terminal co-algebra of an indexed container is, then, given by a choice of \ensuremath{\Conid{MI}} shapes and positions given by \ensuremath{\Conid{Path}}.

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{8}{@{}>{\hspre}l<{\hspost}@{}}%
\column{12}{@{}>{\hspre}l<{\hspost}@{}}%
\column{33}{@{}>{\hspre}l<{\hspost}@{}}%
\column{42}{@{}>{\hspre}l<{\hspost}@{}}%
\column{46}{@{}>{\hspre}l<{\hspost}@{}}%
\column{54}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\nu^{\text{\tiny C}}\;\in\;\{\mskip1.5mu \Conid{I}\;\Conid{J}\;\in\;\Conid{Set}\mskip1.5mu\}\;\rightarrow\;\Conid{ICont}^{\star}\;(\Conid{I}\;\uplus\;\Conid{J})\;\Conid{J}\;\rightarrow\;\Conid{ICont}^{\star}\;\Conid{I}\;\Conid{J}{}\<[E]%
\\
\>[B]{}\nu^{\text{\tiny C}}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{J}\mskip1.5mu\}\;(\Conid{S}\;\lhd^{\star}\;\Conid{P})\;\mathrel{=}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{let}\;{}\<[8]%
\>[8]{}\Conid{P}^{\Conid{I}}\;{}\<[12]%
\>[12]{}\in\;(\Varid{j}\;\in\;\Conid{J})\;\rightarrow\;\Conid{S}\;\Varid{j}\;\rightarrow\;\Conid{I}\;{}\<[33]%
\>[33]{}\rightarrow\;\Conid{Set};{}\<[42]%
\>[42]{}\Conid{P}^{\Conid{I}}\;{}\<[46]%
\>[46]{}\Varid{j}\;\Varid{s}\;\Varid{i}\;{}\<[54]%
\>[54]{}\mathrel{=}\;\Conid{P}\;\!\!\;\Varid{j}\;\!\!\;\Varid{s}\;\!\!\;(\Varid{inl}\;\Varid{i}){}\<[E]%
\\
\>[8]{}\Conid{P}^{\Conid{J}}\;{}\<[12]%
\>[12]{}\in\;(\Varid{j}\;\in\;\Conid{J})\;\rightarrow\;\Conid{S}\;\Varid{j}\;\rightarrow\;\Conid{J}\;{}\<[33]%
\>[33]{}\rightarrow\;\Conid{Set};{}\<[42]%
\>[42]{}\Conid{P}^{\Conid{J}}\;{}\<[46]%
\>[46]{}\Varid{j}\;\Varid{s}\;\Varid{j′}\;{}\<[54]%
\>[54]{}\mathrel{=}\;\Conid{P}\;\!\!\;\Varid{j}\;\!\!\;\Varid{s}\;\!\!\;(\Varid{inr}\;\Varid{j′}){}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{in}\;{}\<[8]%
\>[8]{}\Conid{MI}\;\Conid{S}\;\Conid{P}^{\Conid{J}}\;\lhd^{\star}\;\Conid{Path}\;\Conid{S}\;\Conid{P}^{\Conid{I}}\;\Conid{P}^{\Conid{J}}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Varid{out}^{\text{\tiny C}}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\;\Conid{J}\mskip1.5mu\}\;\rightarrow\;(\Conid{F}\;\in\;\Conid{ICont}^{\star}\;(\Conid{I}\;\uplus\;\Conid{J})\;\Conid{J})\;\rightarrow\;\nu^{\text{\tiny C}}\;\Conid{F}\;\Rightarrow^{\text{\tiny C}^{\star}}\;\Conid{F}\;[\mskip1.5mu \;\nu^{\text{\tiny C}}\;\Conid{F}\;\mskip1.5mu]^{\text{\tiny{C}}^{\star}}{}\<[E]%
\\
\>[B]{}\Varid{out}^{\text{\tiny C}}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{J}\mskip1.5mu\}\;(\Conid{S}\;\lhd^{\star}\;\Conid{P})\;\mathrel{=}\;(\lambda\;\anonymous \;(\Varid{sup}\;\Varid{x})\;\rightarrow\;\Varid{x})\;\lhd^{\star}\;\lambda\;(\Varid{sup}\;\Varid{x})\;\Varid{i′}\;\Varid{p}\;\rightarrow\;\Varid{path}\;\Varid{p}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{12}{@{}>{\hspre}l<{\hspost}@{}}%
\column{14}{@{}>{\hspre}l<{\hspost}@{}}%
\column{15}{@{}>{\hspre}l<{\hspost}@{}}%
\column{16}{@{}>{\hspre}l<{\hspost}@{}}%
\column{19}{@{}>{\hspre}l<{\hspost}@{}}%
\column{23}{@{}>{\hspre}l<{\hspost}@{}}%
\column{38}{@{}>{\hspre}l<{\hspost}@{}}%
\column{47}{@{}>{\hspre}l<{\hspost}@{}}%
\column{51}{@{}>{\hspre}l<{\hspost}@{}}%
\column{59}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Varid{unfold}^{\text{\tiny C}}\;\in\;\forall{}\;{}\<[15]%
\>[15]{}\{\mskip1.5mu \Conid{I}\;\Conid{J}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{F}\;\in\;\Conid{ICont}^{\star}\;(\Conid{I}\;\uplus\;\Conid{J})\;\Conid{I}\mskip1.5mu\}\;(\Conid{G}\;\in\;\Conid{ICont}^{\star}\;\Conid{J}\;\Conid{I})\;\rightarrow\;{}\<[E]%
\\
\>[15]{}\Conid{G}\;\Rightarrow^{\text{\tiny C}^{\star}}\;\Conid{F}\;[\mskip1.5mu \;\Conid{G}\;\mskip1.5mu]^{\text{\tiny{C}}^{\star}}\;\rightarrow\;\Conid{G}\;\Rightarrow^{\text{\tiny C}^{\star}}\;\nu^{\text{\tiny C}}\;\Conid{F}{}\<[E]%
\\
\>[B]{}\Varid{unfold}^{\text{\tiny C}}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{J}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{S}\;\lhd^{\star}\;\Conid{P}\mskip1.5mu\}\;(\Conid{T}\;\lhd^{\star}\;\Conid{Q})\;(\Varid{f}\;\lhd^{\star}\;\Varid{r})\;\mathrel{=}\;\Varid{funfold}\;\lhd^{\star}\;\Varid{runfold}{}\<[E]%
\\
\>[B]{}\hsindent{5}{}\<[5]%
\>[5]{}\Keyword{where}\;{}\<[12]%
\>[12]{}\Conid{P}^{\Conid{I}}\;{}\<[16]%
\>[16]{}\in\;{}\<[19]%
\>[19]{}(\Varid{i}\;\in\;\Conid{I})\;\rightarrow\;\Conid{S}\;\Varid{i}\;\rightarrow\;\Conid{I}\;{}\<[38]%
\>[38]{}\rightarrow\;\Conid{Set};{}\<[47]%
\>[47]{}\Conid{P}^{\Conid{I}}\;{}\<[51]%
\>[51]{}\Varid{i}\;\Varid{s}\;\Varid{i′}\;{}\<[59]%
\>[59]{}\mathrel{=}\;\Conid{P}\;\Varid{i}\;\Varid{s}\;(\Varid{inl}\;\Varid{i′}){}\<[E]%
\\
\>[12]{}\Conid{P}^{\Conid{J}}\;{}\<[16]%
\>[16]{}\in\;{}\<[19]%
\>[19]{}(\Varid{i}\;\in\;\Conid{I})\;\rightarrow\;\Conid{S}\;\Varid{i}\;\rightarrow\;\Conid{J}\;{}\<[38]%
\>[38]{}\rightarrow\;\Conid{Set};{}\<[47]%
\>[47]{}\Conid{P}^{\Conid{J}}\;{}\<[51]%
\>[51]{}\Varid{i}\;\Varid{s}\;\Varid{j}\;{}\<[59]%
\>[59]{}\mathrel{=}\;\Conid{P}\;\Varid{i}\;\Varid{s}\;(\Varid{inr}\;\Varid{j}){}\<[E]%
\\
\>[12]{}\Varid{funfold}\;\mathrel{=}\;\Conid{MIunfold}\;\Varid{f}{}\<[E]%
\\
\>[12]{}\Varid{runfold}\;\in\;{}\<[23]%
\>[23]{}\{\mskip1.5mu \Varid{i}\;\in\;\Conid{I}\mskip1.5mu\}\;(\Varid{t}\;\in\;\Conid{T}\;\Varid{i})\;{}\<[E]%
\\
\>[23]{}(\Varid{j}\;\in\;\Conid{J})\;\rightarrow\;\Conid{Path}\;\Conid{S}\;\Conid{P}^{\Conid{I}}\;\Conid{P}^{\Conid{J}}\;\Varid{i}\;(\Varid{funfold}\;\Varid{i}\;\Varid{t})\;\Varid{j}\;\rightarrow\;\Conid{Q}\;\Varid{i}\;\Varid{t}\;\Varid{j}{}\<[E]%
\\
\>[12]{}\Varid{runfold}\;\Varid{t}\;\Varid{j}\;(\Varid{path}\;(\Varid{inl}\;\Varid{x}))\;\mathrel{=}\;{}\<[E]%
\\
\>[12]{}\hsindent{2}{}\<[14]%
\>[14]{}\Varid{r}\;\Varid{t}\;\Varid{j}\;(\Varid{inl}\;\Varid{x}){}\<[E]%
\\
\>[12]{}\Varid{runfold}\;\Varid{t}\;\Varid{j}\;(\Varid{path}\;(\Varid{inr}\;(\Varid{i},(\Varid{p},\Varid{q}))))\;\mathrel{=}\;{}\<[E]%
\\
\>[12]{}\hsindent{2}{}\<[14]%
\>[14]{}\Varid{r}\;\Varid{t}\;\Varid{j}\;(\Varid{inr}\;(\Varid{i},\Varid{p},\Varid{runfold}\;(\pi_{1}\;(\Varid{f}\;\anonymous \;\Varid{t})\;\Varid{i}\;\Varid{p})\;\Varid{j}\;\Varid{q})){}\<[E]%
\ColumnHook
\end{hscode}\resethooks



\section{W is still enough}
\label{sec:w-enough}



So far we have developed a theory of indexed containers using a rich Type
Theory. We claimed in the introduction, however, that this theory required
only the presence of \ensuremath{\Conid{W}}-types. In this section we will outline the
translation of many of the definitions above into such a spartan theory.
First we will show how to obtain indexed \ensuremath{\Conid{W}}-types from un-indexed ones, and
by analogy \ensuremath{\Conid{MI}} from \ensuremath{\Conid{M}}, and then we will revisit a proof of how to derive
\ensuremath{\Conid{M}}-types from \ensuremath{\Conid{W}}.


\subsection*{\ensuremath{\Conid{WI}} from \ensuremath{\Conid{W}}}
\label{wifromw}

How, then, can we build \ensuremath{\Conid{WI}} from \ensuremath{\Conid{W}}? The initial step is to create a type
of \emph{pre}-\ensuremath{\Conid{WI}} trees, with nodes containing a shape \emph{and} its index,
and branching over positions \emph{and their} indices:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{8}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Conid{WI′}\;\in\;{}\<[8]%
\>[8]{}\{\mskip1.5mu \Conid{I}\;\in\;\Conid{Set}\mskip1.5mu\}\;(\Conid{S}\;\in\;\Conid{I}\;\rightarrow\;\Conid{Set})\;{}\<[E]%
\\
\>[8]{}(\Conid{P}\;\in\;(\Varid{i}\;\in\;\Conid{I})\;(\Varid{s}\;\in\;\Conid{S}\;\Varid{i})\;\rightarrow\;\Conid{I}\;\rightarrow\;\Conid{Set})\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\Conid{WI′}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\Conid{S}\;\Conid{P}\;\mathrel{=}\;\Conid{W}\;(\Sigma(\!\;\Varid{i}\;\in\;\Conid{I}\;\!)\!\times\!\;\Conid{S}\;\Varid{i})\;(\lambda (\!\;\Varid{i}\;\!,\!\;\Varid{s}\;\!\!)\;\rightarrow\;\Sigma(\!\;\Varid{i′}\;\in\;\Conid{I}\;\!)\!\times\!\;\Conid{P}\;\Varid{i}\;\Varid{s}\;\Varid{i′}\;\!\;\!){}\<[E]%
\ColumnHook
\end{hscode}\resethooks

Given such a tree we want to express the property that the subtrees of such a pre-tree have the correct index in their node information. In order to do this we need a second \ensuremath{\Conid{W}}-type, which is similar to \ensuremath{\Conid{WWI′}}, but with an extra copy of the index information stored in that node:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{8}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Conid{WIl}\;\in\;{}\<[8]%
\>[8]{}\{\mskip1.5mu \Conid{I}\;\in\;\Conid{Set}\mskip1.5mu\}\;(\Conid{S}\;\in\;\Conid{I}\;\rightarrow\;\Conid{Set})\;{}\<[E]%
\\
\>[8]{}(\Conid{P}\;\in\;(\Varid{i}\;\in\;\Conid{I})\;(\Varid{s}\;\in\;\Conid{S}\;\Varid{i})\;\rightarrow\;\Conid{I}\;\rightarrow\;\Conid{Set})\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\Conid{WIl}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\Conid{S}\;\Conid{P}\;\mathrel{=}\;\Conid{W}\;(\Conid{I}\;\times\;(\Sigma(\!\;\Varid{i}\;\in\;\Conid{I}\;\!)\!\times\!\;\Conid{S}\;\Varid{i}))\;(\lambda (\!\;\Varid{i′}\;\!,\!\;\Varid{i}\;\!,\!\;\Varid{s}\;\!\!)\;\rightarrow\;\Sigma(\!\;\Varid{i′}\;\in\;\Conid{I}\;\!)\!\times\!\;\Conid{P}\;\Varid{i}\;\Varid{s}\;\Varid{i′}\;\!\;\!){}\<[E]%
\ColumnHook
\end{hscode}\resethooks

There are two possible completions of this extra indexing information, either we push the indexes down to the subtrees, or we copy it from the sub-trees themselves:


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[3]{}\Varid{lup}\;\in\;\Conid{WI′}\;\Conid{S}\;\Conid{P}\;\rightarrow\;\Conid{WIl}\;\Conid{S}\;\Conid{P}{}\<[E]%
\\
\>[3]{}\Varid{lup}\;(\Varid{sup}\;((\Varid{i},\Varid{s}),\Varid{f}))\;\mathrel{=}\;\Varid{sup}\;((\Varid{i},(\Varid{i},\Varid{s})),(\lambda\;\Varid{p}\;\rightarrow\;\Varid{lup}\;(\Varid{f}\;\Varid{p}))){}\<[E]%
\\[\blanklineskip]%
\>[3]{}\Varid{ldown}\;\in\;\Conid{I}\;\rightarrow\;\Conid{WI′}\;\Conid{S}\;\Conid{P}\;\rightarrow\;\Conid{WIl}\;\Conid{S}\;\Conid{P}{}\<[E]%
\\
\>[3]{}\Varid{ldown}\;\Varid{i}\;(\Varid{sup}\;(\Varid{s},\Varid{f}))\;\mathrel{=}\;\Varid{sup}\;((\Varid{i},\Varid{s}),\lambda (\!\;\Varid{i′}\;\!,\!\;\Varid{p}\;\!\!)\;\rightarrow\;\Varid{ldown}\;\Varid{i′}\;(\Varid{f}\;(\Varid{i′},\Varid{p}))\;\!\;\!){}\<[E]%
\ColumnHook
\end{hscode}\resethooks


The property of a pre-tree being type correct can be stated as its two possible labellings being equal:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{7}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Conid{WI}\;\in\;{}\<[7]%
\>[7]{}\{\mskip1.5mu \Conid{I}\;\in\;\Conid{Set}\mskip1.5mu\}\;(\Conid{S}\;\in\;\Conid{I}\;\rightarrow\;\Conid{Set})\;{}\<[E]%
\\
\>[7]{}(\Conid{P}\;\in\;(\Varid{i}\;\in\;\Conid{I})\;(\Varid{s}\;\in\;\Conid{S}\;\Varid{i})\;\rightarrow\;\Conid{I}\;\rightarrow\;\Conid{Set})\;\rightarrow\;\Conid{I}\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\Conid{WI}\;\Conid{S}\;\Conid{P}\;\Varid{i}\;\mathrel{=}\;\Sigma\;(\Conid{WI′}\;\Conid{S}\;\Conid{P})\;\lambda\;\Varid{x}\;\rightarrow\;\Varid{lup}\;\{\mskip1.5mu \anonymous \mskip1.5mu\}\;\{\mskip1.5mu \Conid{S}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{P}\mskip1.5mu\}\;\Varid{x}\;\equiv\;\Varid{ldown}\;\{\mskip1.5mu \anonymous \mskip1.5mu\}\;\{\mskip1.5mu \Conid{S}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{P}\mskip1.5mu\}\;\Varid{i}\;\Varid{x}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks



We rely on function extensionality to define the constructor \ensuremath{\Varid{sup}}:


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{19}{@{}>{\hspre}c<{\hspost}@{}}%
\column{19E}{@{}l@{}}%
\column{22}{@{}>{\hspre}l<{\hspost}@{}}%
\column{37}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[3]{}\Varid{sup}\;\in\;\;\Varid{⟦}\;\Conid{S}\;\lhd^{\star}\;\Conid{P}\;\Varid{⟧}^{\star}\;(\Conid{WI}\;\Conid{S}\;\Conid{P})\;{}\<[37]%
\>[37]{}\rightarrow^{\star}\;\Conid{WI}\;\Conid{S}\;\Conid{P}{}\<[E]%
\\
\>[3]{}\Varid{sup}\;(\Varid{s},\Varid{f})\;\mathrel{=}\;{}\<[19]%
\>[19]{}({}\<[19E]%
\>[22]{}\Varid{sup}\;((\anonymous ,\Varid{s}),\lambda (\!\;\Varid{i}\;\!,\!\;\Varid{p}\;\!\!)\;\rightarrow\;\pi_{0}\;(\Varid{f}\;\Varid{i}\;\Varid{p})\;\!\;\!)){}\<[E]%
\\
\>[19]{},{}\<[19E]%
\>[22]{}\Varid{cong}\;(\lambda\;\Varid{x}\;\rightarrow\;\Varid{sup}\;((\anonymous ,\anonymous ,\Varid{s}),\Varid{x}))\;(\Varid{ext}\;\lambda (\!\;\Varid{i}\;\!,\!\;\Varid{p}\;\!\!)\;\rightarrow\;\pi_{1}\;(\Varid{f}\;\Varid{i}\;\Varid{p})\;\!\;\!){}\<[E]%
\ColumnHook
\end{hscode}\resethooks

The recursion principle then relies on the uniqueness of identity 
proofs. It's also the case that in its form below \ensuremath{\Varid{wirec}} does not pass Agda's termination checker. The direct encoding via \ensuremath{\Varid{wrec}} would avoid this problem, at the expense of being even more verbose:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{7}{@{}>{\hspre}l<{\hspost}@{}}%
\column{11}{@{}>{\hspre}l<{\hspost}@{}}%
\column{12}{@{}>{\hspre}l<{\hspost}@{}}%
\column{17}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[3]{}\Varid{wirec}\;\in\;\{\mskip1.5mu \Varid{i}\;\in\;\Conid{I}\mskip1.5mu\}\;(\Varid{x}\;\in\;\Conid{WI}\;\Conid{S}\;\Conid{P}\;\Varid{i})\;(\Conid{Q}\;\in\;\{\mskip1.5mu \Varid{i}\;\in\;\Conid{I}\mskip1.5mu\}\;\rightarrow\;\Conid{WI}\;\Conid{S}\;\Conid{P}\;\Varid{i}\;\rightarrow\;\Conid{Set})\;{}\<[E]%
\\
\>[3]{}\hsindent{8}{}\<[11]%
\>[11]{}(\Varid{m}\;\in\;{}\<[17]%
\>[17]{}\{\mskip1.5mu \Varid{i}\;\in\;\Conid{I}\mskip1.5mu\}\;(\Varid{s}\;\in\;\Conid{S}\;\Varid{i})\;(\Varid{f}\;\in\;\Conid{P}\;\Varid{i}\;\Varid{s}\;\rightarrow^{\star}\;\Conid{WI}\;\Conid{S}\;\Conid{P})\;{}\<[E]%
\\
\>[17]{}(\Varid{h}\;\in\;\{\mskip1.5mu \Varid{i′}\;\in\;\Conid{I}\mskip1.5mu\}\;(\Varid{p}\;\in\;\Conid{P}\;\Varid{i}\;\Varid{s}\;\Varid{i′})\;\rightarrow\;\Conid{Q}\;(\Varid{f}\;\Varid{i′}\;\Varid{p}))\;\rightarrow\;\Conid{Q}\;\{\mskip1.5mu \Varid{i}\mskip1.5mu\}\;(\Varid{sup}\;(\Varid{s},\Varid{f})))\;{}\<[E]%
\\
\>[3]{}\hsindent{8}{}\<[11]%
\>[11]{}\rightarrow\;\Conid{Q}\;\Varid{x}{}\<[E]%
\\
\>[3]{}\Varid{wirec}\;\{\mskip1.5mu \Varid{i}\mskip1.5mu\}\;(\Varid{sup}\;((\Varid{i′},\Varid{s}),\Varid{f}),\Varid{ok})\;\Conid{Q}\;\Varid{m}\;\Keyword{with}\;\pi_{0}\equiv\;(\Varid{sup₁≡}\;\Varid{ok}){}\<[E]%
\\
\>[3]{}\Varid{wirec}\;\{\mskip1.5mu \Varid{i}\mskip1.5mu\}\;(\Varid{sup}\;((\Varid{.i},\Varid{s}),\Varid{f}),\Varid{ok})\;\Conid{Q}\;\Varid{m}\;\mid \;\Varid{refl}\;\mathrel{=}\;{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{subst}\;\Conid{Q}\;(\Varid{cong}\;\{\mskip1.5mu \Conid{B}\;\mathrel{=}\;\lambda\;\anonymous \;\rightarrow\;\Conid{WI}\;\Conid{S}\;\Conid{P}\;\Varid{i}\mskip1.5mu\}\;(\lambda\;\Varid{x}\;\rightarrow\;\Varid{sup}\;((\Varid{i},\Varid{s}),\Varid{f}),\Varid{x})\;\Conid{UIP})\;{}\<[E]%
\\
\>[5]{}\hsindent{2}{}\<[7]%
\>[7]{}(\Varid{m}\;\Varid{s}\;(\lambda\;\Varid{i}\;\Varid{p}\;\rightarrow\;\Varid{f}\;(\Varid{i},\Varid{p}),\Varid{ext⁻¹}\;(\Varid{sup₂≡}\;\Varid{ok})\;(\Varid{i},\Varid{p}))\;{}\<[E]%
\\
\>[7]{}\hsindent{5}{}\<[12]%
\>[12]{}(\lambda\;\{\mskip1.5mu \Varid{i′}\mskip1.5mu\}\;\Varid{p}\;\rightarrow\;\Varid{wirec}\;(\Varid{f}\;(\Varid{i′},\Varid{p}),\Varid{ext⁻¹}\;(\Varid{sup₂≡}\;\Varid{ok})\;(\Varid{i′},\Varid{p}))\;\Conid{Q}\;\Varid{m})){}\<[E]%
\ColumnHook
\end{hscode}\resethooks

It's then straight forward but labourious to prove the $\beta$ law for \ensuremath{\Varid{wirec}}, which would has type:



\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{12}{@{}>{\hspre}l<{\hspost}@{}}%
\column{18}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[3]{}\beta\Varid{wirec}\;\in\;{}\<[E]%
\\
\>[3]{}\hsindent{9}{}\<[12]%
\>[12]{}\{\mskip1.5mu \Varid{i}\;\in\;\Conid{I}\mskip1.5mu\}\;(\Varid{s}\;\in\;\Conid{S}\;\Varid{i})\;(\Varid{f}\;\in\;\Conid{P}\;\Varid{i}\;\Varid{s}\;\rightarrow^{\star}\;\Conid{WI}\;\Conid{I}\;\Conid{S}\;\Conid{P})\;{}\<[E]%
\\
\>[3]{}\hsindent{9}{}\<[12]%
\>[12]{}(\Conid{Q}\;\in\;\{\mskip1.5mu \Varid{i}\;\in\;\Conid{I}\mskip1.5mu\}\;\rightarrow\;\Conid{WI}\;\Conid{I}\;\Conid{S}\;\Conid{P}\;\Varid{i}\;\rightarrow\;\Conid{Set})\;{}\<[E]%
\\
\>[3]{}\hsindent{9}{}\<[12]%
\>[12]{}(\Varid{m}\;\in\;{}\<[18]%
\>[18]{}\{\mskip1.5mu \Varid{i}\;\in\;\Conid{I}\mskip1.5mu\}\;(\Varid{s}\;\in\;\Conid{S}\;\Varid{i})\;(\Varid{f}\;\in\;\{\mskip1.5mu \Varid{i′}\;\in\;\Conid{I}\mskip1.5mu\}\;\rightarrow\;\Conid{P}\;\Varid{i}\;\Varid{s}\;\Varid{i′}\;\rightarrow\;\Conid{WI}\;\Conid{I}\;\Conid{S}\;\Conid{P}\;\Varid{i′})\;{}\<[E]%
\\
\>[18]{}(\Varid{h}\;\in\;\{\mskip1.5mu \Varid{i′}\;\in\;\Conid{I}\mskip1.5mu\}\;(\Varid{p}\;\in\;\Conid{P}\;\Varid{i}\;\Varid{s}\;\Varid{i′})\;\rightarrow\;\Conid{Q}\;(\Varid{f}\;\Varid{p}))\;\rightarrow\;\Conid{Q}\;\{\mskip1.5mu \Varid{i}\mskip1.5mu\}\;(\Varid{sup}\;\Varid{s}\;\Varid{f}))\;{}\<[E]%
\\
\>[3]{}\hsindent{9}{}\<[12]%
\>[12]{}\rightarrow\;\Varid{wirec}\;\{\mskip1.5mu \Varid{i}\mskip1.5mu\}\;(\Varid{sup}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{S}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{P}\mskip1.5mu\}\;\Varid{s}\;\Varid{f})\;\Conid{Q}\;\Varid{m}\;\equiv\;\Varid{m}\;\{\mskip1.5mu \Varid{i}\mskip1.5mu\}\;\Varid{s}\;\Varid{f}\;(\lambda\;\{\mskip1.5mu \Varid{i′}\mskip1.5mu\}\;\Varid{p}\;\rightarrow\;\Varid{wirec}\;(\Varid{f}\;\Varid{p})\;\Conid{Q}\;\Varid{m}){}\<[E]%
\ColumnHook
\end{hscode}\resethooks


We can use this proof that \ensuremath{\Conid{WI}}-types can be encoded by \ensuremath{\Conid{W}} to explain where 
\ensuremath{\Conid{Path}} fits in, since it is straight forwardly encoded as a \ensuremath{\Conid{WI}}:


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{9}{@{}>{\hspre}l<{\hspost}@{}}%
\column{11}{@{}>{\hspre}l<{\hspost}@{}}%
\column{14}{@{}>{\hspre}l<{\hspost}@{}}%
\column{35}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Conid{Path}\;\in\;{}\<[9]%
\>[9]{}\{\mskip1.5mu \Conid{I}\;\Conid{J}\;\in\;\Conid{Set}\mskip1.5mu\}\;(\Conid{S}\;\in\;\Conid{J}\;\rightarrow\;\Conid{Set})\;{}\<[E]%
\\
\>[9]{}(\Conid{P}^{\Conid{I}}\;{}\<[14]%
\>[14]{}\in\;(\Varid{j}\;\in\;\Conid{J})\;\rightarrow\;\Conid{S}\;\Varid{j}\;\rightarrow\;\Conid{I}\;{}\<[35]%
\>[35]{}\rightarrow\;\Conid{Set})\;{}\<[E]%
\\
\>[9]{}(\Conid{P}^{\Conid{J}}\;{}\<[14]%
\>[14]{}\in\;(\Varid{j}\;\in\;\Conid{J})\;\rightarrow\;\Conid{S}\;\Varid{j}\;\rightarrow\;\Conid{J}\;{}\<[35]%
\>[35]{}\rightarrow\;\Conid{Set})\;{}\<[E]%
\\
\>[9]{}(\Varid{j}\;\in\;\Conid{J})\;\rightarrow\;\Conid{WI}\;\Conid{S}\;\Conid{P}^{\Conid{J}}\;\Varid{j}\;\rightarrow\;\Conid{I}\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\Conid{Path}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{J}\mskip1.5mu\}\;\Conid{S}\;\Conid{P}^{\Conid{I}}\;\Conid{P}^{\Conid{J}}\;\Varid{j}\;\Varid{w}\;\Varid{i}\;\mathrel{=}\;\Conid{WI}\;\Conid{PathS}\;\Conid{PathP}\;(\Varid{j},\Varid{w}){}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{where}\;\Conid{PathS}\;\in\;\Sigma(\!\;\Varid{j}\;\in\;\Conid{J}\;\!)\!\times\!\;\Conid{WI}\;\Conid{S}\;\Conid{P}^{\Conid{J}}\;\Varid{j}\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[3]{}\hsindent{6}{}\<[9]%
\>[9]{}\Conid{PathS}\;(\Varid{j},\Varid{sup}\;(\Varid{s},\Varid{f}))\;\mathrel{=}\;\Conid{P}^{\Conid{I}}\;\Varid{j}\;\Varid{s}\;\Varid{i}\;\uplus\;\Sigma\;\Conid{J}\;(\Conid{P}^{\Conid{J}}\;\Varid{j}\;\Varid{s}){}\<[E]%
\\
\>[3]{}\hsindent{6}{}\<[9]%
\>[9]{}\Conid{PathP}\;\in\;(\Varid{jw}\;\in\;\Sigma(\!\;\Varid{j}\;\in\;\Conid{J}\;\!)\!\times\!\;\Conid{WI}\;\Conid{S}\;\Conid{P}^{\Conid{J}}\;\Varid{j})\;(\Varid{s}\;\in\;\Conid{PathS}\;\Varid{jw})\;\rightarrow\;\Sigma(\!\;\Varid{j}\;\in\;\Conid{J}\;\!)\!\times\!\;\Conid{WI}\;\Conid{S}\;\Conid{P}^{\Conid{J}}\;\Varid{j}\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[3]{}\hsindent{6}{}\<[9]%
\>[9]{}\Conid{PathP}\;(\Varid{j},\Varid{sup}\;(\Varid{s},\Varid{f}))\;(\Varid{inl}\;\Varid{p})\;(\Varid{j′},\Varid{w′})\;\mathrel{=}\;\bot{}\<[E]%
\\
\>[3]{}\hsindent{6}{}\<[9]%
\>[9]{}\Conid{PathP}\;(\Varid{j},\Varid{sup}\;(\Varid{s},\Varid{f}))\;(\Varid{inr}\;(\Varid{j′′},\Varid{p}))\;(\Varid{j′},\Varid{w′})\;\mathrel{=}\;{}\<[E]%
\\
\>[9]{}\hsindent{2}{}\<[11]%
\>[11]{}(\Varid{j′′}\;\equiv\;\Varid{j′})\;\times\;(\Varid{f}\;\Varid{j′′}\;\Varid{p}\;\cong\;\Varid{w′}){}\<[E]%
\ColumnHook
\end{hscode}\resethooks


\todo{Derive MI from M or at least say so and hide the proof.}


\subsection*{\ensuremath{\Conid{M}} from \ensuremath{\Conid{W}}}
\label{sec:mfromw}

Since we have shown that both \ensuremath{\Conid{WI}} and \ensuremath{\Conid{MI}} types can be reduced to their
non-indexed counterparts, it only remains to show that \ensuremath{\Conid{M}} types can be,
reduced
to \ensuremath{\Conid{W}} types. This is a result from our previous work on
containers~\cite{alti:cont-tcs}, though in the setting of indexed \ensuremath{\Conid{WI}} types,
we can give a better expalnation.

In category theory, an $\omega$-chain, is an infinite diagram:

\[
\xymatrix{
\ensuremath{\Conid{A}}_{0} &
\ar[l]_{\ensuremath{\Varid{a}}_{0}}
\ensuremath{\Conid{A}}_{1} &
\ar[l]_{\ensuremath{\Varid{a}}_{1}}
\ensuremath{\Conid{A}}_{2} &
\cdots &
\ensuremath{\Conid{A}}_{n-1} &
\ar[l]_{\ensuremath{\Varid{a}}_{n-1}} 
\ensuremath{\Conid{A}}_{n} &
\ar[l]_{\ensuremath{\Varid{a}}_{n}} 
\ensuremath{\Conid{A}}_{n+1} &
\cdots} 
\]

In type-theroy, we can represent such a chain, as a pair of functions:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Conid{Chain}\;\in\;\Conid{Set₁}{}\<[E]%
\\
\>[B]{}\Conid{Chain}\;\mathrel{=}\;\Sigma(\!\;\Conid{A}\;\in\;(\Conid{ℕ}\;\rightarrow\;\Conid{Set})\;\!)\!\times\!\;((\Varid{n}\;\in\;\Conid{ℕ})\;\rightarrow\;\Conid{A}\;(\Varid{suc}\;\Varid{n})\;\rightarrow\;\Conid{A}\;\Varid{n}){}\<[E]%
\ColumnHook
\end{hscode}\resethooks

The limit of a chain is an object \ensuremath{\Conid{X}} and family of projections 
$\pi_{n} \in \mbox{\ensuremath{\Conid{X}}} → \mbox{\ensuremath{\Conid{A}}}_{n}$ such that in the following diagram, 
all the small triangles commute:

\[
\xymatrix{
\ensuremath{\Conid{A}}_{\ensuremath{\Varid{0}}} &
\ar[l]_{\ensuremath{\Varid{a}}_{\ensuremath{\Varid{0}}}}
\ensuremath{\Conid{A}}_{1} &
\ar[l]_{\ensuremath{\Varid{a}}_{\ensuremath{\Varid{1}}}}
\ensuremath{\Conid{A}}_{2} &
\cdots &
\ensuremath{\Conid{A}}_{n-\ensuremath{\Varid{1}}} &
\ar[l]_{\ensuremath{\Varid{a}}_{n-1}} 
\ensuremath{\Conid{A}}_{n} &
\ar[l]_{\ensuremath{\Varid{a}}_{n}} 
\ensuremath{\Conid{A}}_{n+\ensuremath{\Varid{1}}} &
\cdots
\\
\\
& & & & 
\ensuremath{\Conid{X}}
\ar[uullll]_{\pi_{\ensuremath{\Varid{0}}}}
\ar[uulll]_{\pi_{\ensuremath{\Varid{1}}}}
\ar[uull]_{\pi_{\ensuremath{\Varid{2}}}}
\ar[uu]_{\pi_{n - \ensuremath{\Varid{1}}}}
\ar[uur]_{\pi_{n}}
\ar[uurr]_{\pi_{n + \ensuremath{\Varid{1}}}}
&&&\\
} 
\]

It is also required that the limit is the terminal cone with this property. 
Again, we can encode the limit of a chain, its projections, and this universal 
property in type theory:


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{8}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Conid{LIM}\;\in\;\Conid{Chain}\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\Conid{LIM}\;(\Conid{A},\Varid{a})\;\mathrel{=}\;\Sigma(\!\;\Varid{f}\;\in\;((\Varid{n}\;\in\;\Conid{ℕ})\;\rightarrow\;\Conid{A}\;\Varid{n})\;\!)\!\times\!\;((\Varid{n}\;\in\;\Conid{ℕ})\;\rightarrow\;\Varid{a}\;\Varid{n}\;(\Varid{f}\;(\Varid{suc}\;\Varid{n}))\;\equiv\;\Varid{f}\;\Varid{n}){}\<[E]%
\\[\blanklineskip]%
\>[B]{}\pi\;\in\;\{\mskip1.5mu \Varid{c}\;\in\;\Conid{Chain}\mskip1.5mu\}\;\rightarrow\;(\Varid{n}\;\in\;\Conid{ℕ})\;\rightarrow\;\Conid{LIM}\;\Varid{c}\;\rightarrow\;\pi_{0}\;\Varid{c}\;\Varid{n}{}\<[E]%
\\
\>[B]{}\pi\;\Varid{n}\;(\Varid{f},\Varid{p})\;\mathrel{=}\;\Varid{f}\;\Varid{n}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Varid{comm}\;\in\;\{\mskip1.5mu \Varid{c}\;\in\;\Conid{Chain}\mskip1.5mu\}\;(\Varid{n}\;\in\;\Conid{ℕ})\;(\Varid{l}\;\in\;\Conid{LIM}\;\Varid{c})\;\rightarrow\;\pi_{1}\;\Varid{c}\;\Varid{n}\;(\pi\;\{\mskip1.5mu \Varid{c}\mskip1.5mu\}\;(\Varid{suc}\;\Varid{n})\;\Varid{l})\;\equiv\;\pi\;\{\mskip1.5mu \Varid{c}\mskip1.5mu\}\;\Varid{n}\;\Varid{l}{}\<[E]%
\\
\>[B]{}\Varid{comm}\;\Varid{n}\;(\Varid{f},\Varid{p})\;\mathrel{=}\;\Varid{p}\;\Varid{n}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Varid{univ}\;\in\;\{\mskip1.5mu \Varid{c}\;\in\;\Conid{Chain}\mskip1.5mu\}\;\{\mskip1.5mu \Conid{X}\;\in\;\Conid{Set}\mskip1.5mu\}\;(\Varid{pro}\;\in\;(\Varid{n}\;\in\;\Conid{ℕ})\;\rightarrow\;\Conid{X}\;\rightarrow\;\pi_{0}\;\Varid{c}\;\Varid{n})\;{}\<[E]%
\\
\>[B]{}\hsindent{8}{}\<[8]%
\>[8]{}(\Varid{com}\;\in\;(\Varid{n}\;\in\;\Conid{ℕ})\;(\Varid{x}\;\in\;\Conid{X})\;\rightarrow\;\pi_{1}\;\Varid{c}\;\Varid{n}\;(\Varid{pro}\;(\Varid{suc}\;\Varid{n})\;\Varid{x})\;\equiv\;\Varid{pro}\;\Varid{n}\;\Varid{x})\;\rightarrow\;{}\<[E]%
\\
\>[B]{}\hsindent{8}{}\<[8]%
\>[8]{}\Conid{X}\;\rightarrow\;\Conid{LIM}\;\Varid{c}{}\<[E]%
\\
\>[B]{}\Varid{univ}\;\Varid{pro}\;\Varid{com}\;\Varid{x}\;\mathrel{=}\;(\lambda\;\Varid{n}\;\rightarrow\;\Varid{pro}\;\Varid{n}\;\Varid{x}),(\lambda\;\Varid{n}\;\rightarrow\;\Varid{com}\;\Varid{n}\;\Varid{x}){}\<[E]%
\ColumnHook
\end{hscode}\resethooks

Given a functor \ensuremath{\Conid{F}}, we can build a chain:

\[
\xymatrix{
\ensuremath{\top} &
\ar[l]_{\ensuremath{\mathbin{!}}}
\ensuremath{\Conid{F}} \ensuremath{\top} &
\ar[l]_{\ensuremath{\Conid{F}} \ensuremath{\mathbin{!}}}
\ensuremath{\Conid{F}}^{\ensuremath{\Varid{2}}} \ensuremath{\top} &
\ar[l]_{\ensuremath{\Conid{F}}^{\ensuremath{\Varid{2}}} \ensuremath{\mathbin{!}}}
\ensuremath{\Conid{F}}^{\ensuremath{\Varid{3}}} \ensuremath{\top} &
\cdots &
} 
\]


\noindent
For the moment denote this chain \ensuremath{\Conid{F}\;\!^{\omega}\;\mathrel{=}\;((\lambda\;\Varid{n}\;\rightarrow\;\Conid{F}\;\!^{\Varid{n}}\;\top),\lambda\;\Varid{n}\;\rightarrow\;\Conid{F}\;\!^{\Varid{n}}\;\mathbin{!})}. 
We know from Asperti and Longo \cite{aspertilongo} that if \ensuremath{\Conid{F}} is 
$\omega$-continuous, \emph{i.e.} that for any chain \ensuremath{(\Conid{A},\Varid{a})}:

\ensuremath{\Conid{F}\;(\Conid{LIM}\;(\Conid{A},\Varid{a}))\;\cong\;\Conid{LIM}\;((\Conid{F}\;\ensuremath{\mbox{$\circ$}}\;\Conid{A}),(\Conid{F}\;\ensuremath{\mbox{$\circ$}}\;\Varid{a}))}

\noindent
then the limit of \ensuremath{\Conid{F}\;\!^{\omega}} will be the terminal co-algebra of \ensuremath{\Conid{F}}. 

To see this we first observe that we there is an isomorphism between the limit of a chain, and the limit of any of its \emph{tails}:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{9}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Varid{tail}\;\in\;\Conid{Chain}\;\rightarrow\;\Conid{Chain}{}\<[E]%
\\
\>[B]{}\Varid{tail}\;(\Conid{A},\Varid{a})\;\mathrel{=}\;(\Conid{A}\;\ensuremath{\mbox{$\circ$}}\;\Varid{suc},\Varid{a}\;\ensuremath{\mbox{$\circ$}}\;\Varid{suc}){}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Varid{tailLIM}\;\in\;(\Varid{c}\;\in\;\Conid{Chain})\;\rightarrow\;\Conid{LIM}\;\Varid{c}\;\rightarrow\;\Conid{LIM}\;(\Varid{tail}\;\Varid{c}){}\<[E]%
\\
\>[B]{}\Varid{tailLIM}\;(\Conid{A},\Varid{a})\;(\Varid{f},\Varid{p})\;\mathrel{=}\;\Varid{f}\;\ensuremath{\mbox{$\circ$}}\;\Varid{suc},\Varid{p}\;\ensuremath{\mbox{$\circ$}}\;\Varid{suc}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Varid{tailLIM⁻¹}\;\in\;(\Varid{c}\;\in\;\Conid{Chain})\;\rightarrow\;\Conid{LIM}\;(\Varid{tail}\;\Varid{c})\;\rightarrow\;\Conid{LIM}\;\Varid{c}{}\<[E]%
\\
\>[B]{}\Varid{tailLIM⁻¹}\;(\Conid{A},\Varid{a})\;(\Varid{f},\Varid{p})\;\mathrel{=}\;\Varid{f′},\Varid{p′}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{where}\;\Varid{f′}\;\in\;(\Varid{n}\;\in\;\Conid{ℕ})\;\rightarrow\;\Conid{A}\;\Varid{n}{}\<[E]%
\\
\>[3]{}\hsindent{6}{}\<[9]%
\>[9]{}\Varid{f′}\;\Varid{zero}\;\mathrel{=}\;\Varid{a}\;\anonymous \;(\Varid{f}\;\Varid{zero}){}\<[E]%
\\
\>[3]{}\hsindent{6}{}\<[9]%
\>[9]{}\Varid{f′}\;(\Varid{suc}\;\Varid{n})\;\mathrel{=}\;\Varid{f}\;\Varid{n}{}\<[E]%
\\
\>[3]{}\hsindent{6}{}\<[9]%
\>[9]{}\Varid{p′}\;\in\;(\Varid{n}\;\in\;\Conid{ℕ})\;\rightarrow\;\Varid{a}\;\anonymous \;(\Varid{f}\;\Varid{n})\;\cong\;\Varid{f′}\;\Varid{n}{}\<[E]%
\\
\>[3]{}\hsindent{6}{}\<[9]%
\>[9]{}\Varid{p′}\;\Varid{zero}\;\mathrel{=}\;\Varid{refl}{}\<[E]%
\\
\>[3]{}\hsindent{6}{}\<[9]%
\>[9]{}\Varid{p′}\;(\Varid{suc}\;\Varid{n})\;\mathrel{=}\;\Varid{p}\;\Varid{n}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\noindent 
We also note that the tail of \ensuremath{\Conid{F}\;\!^{\omega}} is \ensuremath{((\lambda\;\Varid{n}\;\rightarrow\;\Conid{F}\;(\Conid{F}\;\!^{\Varid{n}}\;\top)),\lambda\;\Varid{n}\;\rightarrow\;\Conid{F}\;(\Conid{F}\;\!^{\Varid{n}}\;\mathbin{!}))}, which allows us to construct the isomorphism between \ensuremath{\Conid{F}\;(\Conid{LIM}\;\Conid{F}\;\!^{\omega})} and 
\ensuremath{\Conid{LIM}\;\Conid{F}\;\!^{\omega}}:

\begin{align*}
&&& \ensuremath{\Conid{F}\;(\Conid{LIM}\;\Conid{F}\;\!^{\omega})} & \\
&\cong&& \ensuremath{\Conid{LIM}\;(\Conid{F}\;\ensuremath{\mbox{$\circ$}}\;(\lambda\;\Varid{n}\;\rightarrow\;\Conid{F}\;\!^{\Varid{n}}\;\top),\Conid{F}\;\ensuremath{\mbox{$\circ$}}\;(\lambda\;\Varid{n}\;\rightarrow\;\Conid{F}\;\!^{\Varid{n}}\;\mathbin{!}))} & \{\mbox{\ensuremath{\Conid{F}} is $\omega$-continuous}\} \\
&\equiv&& \ensuremath{\Conid{LIM}\;((\lambda\;\Varid{n}\;\rightarrow\;\Conid{F}\;(\Conid{F}\;\!^{\Varid{n}}\;\top)),(\lambda\;\Varid{n}\;\rightarrow\;\Conid{F}\;(\Conid{F}\;\!^{\Varid{n}}\;\mathbin{!})))} & \{\mbox{definition}\}\\
&\cong&& \ensuremath{\Conid{LIM}\;\Conid{F}\;\!^{\omega}} & \{\mbox{ \ensuremath{\Varid{tailLIM}} }\} \\
\end{align*}


This isomorphism is witnessed from right to left by the co-algebra map \ensuremath{\Varid{out}}.
To show that the co-algebra is terminal, we employ the universal property of
\ensuremath{\Conid{LIM}}. Given a co-algebra for \ensuremath{\alpha\;\in\;\Conid{X}\;\rightarrow\;\Conid{F}\;\Conid{X}} we construct an \ensuremath{\Conid{F}\;\!^{\omega}} cone:

\[
\xymatrix{
\ensuremath{\top} &
\ar[l]_{\ensuremath{\mathbin{!}}}
\ensuremath{\Conid{F}} \ensuremath{\top} &
\ar[l]_{\ensuremath{\Conid{F}} \ensuremath{\mathbin{!}}}
\ensuremath{\Conid{F}}^{2} \ensuremath{\top} &
\ar[l]_{\ensuremath{\Conid{F}}^{\ensuremath{\Varid{2}}} \ensuremath{\mathbin{!}}}
\ensuremath{\Conid{F}}^{3} \ensuremath{\top} &
\cdots & \\
\ensuremath{\Conid{X}} 
\ar[u]_{\ensuremath{\mathbin{!}}}
\ar[r]_{\ensuremath{\Varid{f}}} &
\ensuremath{\Conid{F}} \ensuremath{\Conid{X}} 
\ar[u]_{\ensuremath{\Conid{F}} \ensuremath{\mathbin{!}}}
\ar[r]_{\ensuremath{\Conid{F}} \ensuremath{\Varid{f}}} &
\ensuremath{\Conid{F}}^{2} \ensuremath{\Conid{X}}
\ar[u]_{\ensuremath{\Conid{F}}^{\ensuremath{\Varid{2}}} \ensuremath{\mathbin{!}}} 
\ar[r]_{\ensuremath{\Conid{F}}^{\ensuremath{\Varid{2}}} \ensuremath{\Varid{f}}} &
\ensuremath{\Conid{F}}^{3} \ensuremath{\Conid{X}}
\ar[u]_{\ensuremath{\Conid{F}}^{\ensuremath{\Varid{3}}} \ensuremath{\mathbin{!}}} 
 &
\cdots \\
}
\]

We want to build \ensuremath{\Conid{M}}-types, which we know to be the terminal co-algebras of 
container functors. In order to do this, we must construct 
iteration of container functors (to build the chain) and show that all container
functors are $\omega$ continuous.

Since we only need to build iterations of container functors applied to the 
terminal object \ensuremath{\top}, we build that directly. We define the following variation 
of \ensuremath{\Conid{W}}, cut off at a know depth:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{data}\;\Conid{WM}\;(\Conid{S}\;\in\;\Conid{Set})\;(\Conid{P}\;\in\;\Conid{S}\;\rightarrow\;\Conid{Set})\;\in\;\Conid{ℕ}\;\rightarrow\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{wm⊤}\;\in\;\Conid{WM}\;\Conid{S}\;\Conid{P}\;\Varid{zero}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{sup}\;\in\;\forall{}\;\{\mskip1.5mu \Varid{n}\mskip1.5mu\}\;\rightarrow\;\!\;\Varid{⟦}\;\Conid{S}\;\lhd\;\Conid{P}\;\Varid{⟧}\;(\Conid{WM}\;\Conid{S}\;\Conid{P}\;\Varid{n})\;\rightarrow\;\Conid{WM}\;\Conid{S}\;\Conid{P}\;(\Varid{suc}\;\Varid{n}){}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\noindent
It should be obvious that \ensuremath{\Conid{WM}\;\Varid{zero}} is indeed terminal in \ensuremath{\Conid{Set}} and that 
\ensuremath{\Varid{⟦}\;\Conid{S}\;\lhd\;\Conid{P}\;\Varid{⟧}\;(\Conid{WM}\;\Conid{S}\;\Conid{P}\;\Varid{n})\;\cong\;\Conid{WM}\;\Conid{S}\;\Conid{P}\;(\Varid{suc}\;\Varid{n})}, so upto to isomorphism, this just the 
thing we need to construct \ensuremath{\Varid{⟦}\;\Conid{S}\;\lhd\;\Conid{P}\;\Varid{⟧}}$^{\omega}$.

Note that \ensuremath{\Conid{WM}} is itself encodable as an indexed \ensuremath{\Conid{WI}} type, and by the result 
above, a \ensuremath{\Conid{W}} type:


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Conid{WM′}\;\in\;(\Conid{S}\;\in\;\Conid{Set})\;(\Conid{P}\;\in\;\Conid{S}\;\rightarrow\;\Conid{Set})\;\rightarrow\;\Conid{ℕ}\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\Conid{WM′}\;\Conid{S}\;\Conid{P}\;\mathrel{=}\;\Conid{WI}\;\Conid{S′}\;\Conid{P′}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{where}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Conid{S′}\;\in\;\Conid{ℕ}\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Conid{S′}\;\Varid{zero}\;\mathrel{=}\;\top{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Conid{S′}\;(\Varid{suc}\;\Varid{n})\;\mathrel{=}\;\Conid{S}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Conid{P′}\;\in\;(\Varid{n}\;\in\;\Conid{ℕ})\;\rightarrow\;\Conid{S′}\;\Varid{n}\;\rightarrow\;\Conid{ℕ}\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Conid{P′}\;\Varid{zero}\;\anonymous \;\anonymous \;\mathrel{=}\;\bot{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Conid{P′}\;(\Varid{suc}\;\Varid{m})\;\Varid{s}\;\Varid{n}\;\Keyword{with}\;\Varid{m}\;\Varid{≟}\;\Varid{n}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Conid{P′}\;(\Varid{suc}\;\Varid{.n})\;\Varid{s}\;\Varid{n}\;\mid \;\Varid{yes}\;\Varid{refl}\;\mathrel{=}\;\Conid{P}\;\Varid{s}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Conid{P′}\;(\Varid{suc}\;\Varid{m})\;\Varid{s}\;\Varid{n}\;\mid \;\Varid{no}\;\Varid{¬p}\;\mathrel{=}\;\bot{}\<[E]%
\ColumnHook
\end{hscode}\resethooks


\noindent
We can truncate any given tree of depth greater than 1, this amounts to the 
iteration of the morphism part of the container functor applied to the unique 
morphism into the terminal object:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Varid{trunc}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{S}\;\Conid{P}\mskip1.5mu\}\;\rightarrow\;(\Varid{n}\;\in\;\Conid{ℕ})\;\rightarrow\;\Conid{WM}\;\Conid{S}\;\Conid{P}\;(\Varid{suc}\;\Varid{n})\;\rightarrow\;\Conid{WM}\;\Conid{S}\;\Conid{P}\;\Varid{n}{}\<[E]%
\\
\>[B]{}\Varid{trunc}\;\Varid{zero}\;(\Varid{sup}\;(\Varid{s},\Varid{f}))\;\mathrel{=}\;\Varid{wm⊤}{}\<[E]%
\\
\>[B]{}\Varid{trunc}\;(\Varid{suc}\;\Varid{n})\;(\Varid{sup}\;(\Varid{s},\Varid{f}))\;\mathrel{=}\;\Varid{sup}\;(\Varid{s},\Varid{trunc}\;\Varid{n}\;\ensuremath{\mbox{$\circ$}}\;\Varid{f}){}\<[E]%
\ColumnHook
\end{hscode}\resethooks

So now we can build the chain of finite iterations of a container functor:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Conid{M-chain}\;\in\;(\Conid{S}\;\in\;\Conid{Set})\;(\Conid{P}\;\in\;\Conid{S}\;\rightarrow\;\Conid{Set})\;\rightarrow\;\Conid{Chain}{}\<[E]%
\\
\>[B]{}\Conid{M-chain}\;\Conid{S}\;\Conid{P}\;\mathrel{=}\;\Conid{WM}\;\Conid{S}\;\Conid{P},\Varid{trunc}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\begin{proposition}
All container functors are $\omega$-continuous. That is, they preserve 
$\omega$-limits.
\end{proposition}

\begin{proof}
We want to build the isomorphism 
\ensuremath{\Conid{F}\;(\Conid{LIM}\;(\Conid{A},\Varid{a}))\;\cong\;\Conid{LIM}\;((\Conid{F}\;\ensuremath{\mbox{$\circ$}}\;\Conid{A}),\Conid{F}\;\ensuremath{\mbox{$\circ$}}\;\Varid{a})} in the case that \ensuremath{\Conid{F}}
is a container functor. However, the function from left to right is uniquely 
given by the universal property of \ensuremath{\Conid{LIM}} for all functors \ensuremath{\Conid{F}\;\in\;\Conid{Set}\;\rightarrow\;\Conid{Set}}. 
To show this we build the cone for the chain \ensuremath{((\Conid{F}\;\ensuremath{\mbox{$\circ$}}\;\Conid{A}),\Conid{F}\;\ensuremath{\mbox{$\circ$}}\;\Varid{a})}:


\[
\xymatrix{
\ensuremath{\Conid{F}} \ensuremath{\Conid{A}}_{0} &
\ar[l]_{\ensuremath{\Conid{F}} \ensuremath{\Varid{a}}_{0}}
\ensuremath{\Conid{F}} \ensuremath{\Conid{A}}_{1} &
\ar[l]_{\ensuremath{\Conid{F}} \ensuremath{\Varid{a}}_{1}}
\ensuremath{\Conid{F}} \ensuremath{\Conid{A}}_{2} &
\cdots &
\ensuremath{\Conid{F}} \ensuremath{\Conid{A}}_{n-1} &
\ar[l]_{\ensuremath{\Conid{F}} \ensuremath{\Varid{a}}_{n-1}} 
\ensuremath{\Conid{F}} \ensuremath{\Conid{A}}_{n} &
\cdots
\\
\\
& & &  
\ensuremath{\Conid{F}\;(\Conid{LIM}\;(\Conid{A},\Varid{a}))}
\ar[uulll]^{\ensuremath{\Conid{F}} \pi_{0}}
\ar[uull]_{\ensuremath{\Conid{F}} \pi_{1}}
\ar[uul]_{\ensuremath{\Conid{F}} \pi_{2}}
\ar[uur]_{\ensuremath{\Conid{F}} \pi_{n-1}}
\ar[uurr]_{\ensuremath{\Conid{F}} \pi_{n}}
&&&\\
} 
\]

\noindent
The small triangles in the diagram above obviously commute, so there exists a 
unique morphism from \ensuremath{\Conid{F}\;(\Conid{LIM}\;(\Conid{A},\Varid{a}))} into 
\ensuremath{\Conid{LIM}\;((\Conid{F}\;\ensuremath{\mbox{$\circ$}}\;\Conid{A}),\Conid{F}\;\ensuremath{\mbox{$\circ$}}\;\Varid{a})}.
All that remains then, is to construct an inverse to this unique morphism, in 
the case that \ensuremath{\Conid{F}\;\equiv\;\Varid{⟦}\;\Conid{S}\;\lhd\;\Conid{P}\;\Varid{⟧}}, that is we must build a function:



\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{11}{@{}>{\hspre}l<{\hspost}@{}}%
\column{13}{@{}>{\hspre}l<{\hspost}@{}}%
\column{18}{@{}>{\hspre}l<{\hspost}@{}}%
\column{21}{@{}>{\hspre}c<{\hspost}@{}}%
\column{21E}{@{}l@{}}%
\column{24}{@{}>{\hspre}l<{\hspost}@{}}%
\column{51}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[3]{}\omega\Varid{-cont}\;\in\;{}\<[13]%
\>[13]{}\Conid{LIM}\;{}\<[18]%
\>[18]{}({}\<[21]%
\>[21]{}({}\<[21E]%
\>[24]{}\lambda\;\Varid{n}\;\rightarrow\;\Sigma(\!\;\Varid{s}\;\in\;\Conid{S}\;\!)\!\times\!\;(\Conid{P}\;\Varid{s}\;\rightarrow\;\Conid{A}\;\Varid{n})){}\<[E]%
\\
\>[18]{},{}\<[24]%
\>[24]{}\lambda\;\Varid{n}\;\rightarrow\;\lambda (\!\;\Varid{s}\;\!,\!\;\Varid{f}\;\!\!)\;\rightarrow\;{}\<[51]%
\>[51]{}(\Varid{s},\Varid{a}\;\Varid{n}\;\ensuremath{\mbox{$\circ$}}\;\Varid{f})\;\!\;\!{}\<[E]%
\\
\>[18]{})\;{}\<[E]%
\\
\>[3]{}\hsindent{8}{}\<[11]%
\>[11]{}\rightarrow\;\Sigma(\!\;\Varid{s}\;\in\;\Conid{S}\;\!)\!\times\!\;(\Conid{P}\;\Varid{s}\;\rightarrow\;(\Conid{LIM}\;(\Conid{A},\Varid{a}))){}\<[E]%
\ColumnHook
\end{hscode}\resethooks

Note that the shape picked at every point along the chain must be the same, in 
order to make the diagrams commute. This is the key insight
into constructing this function.


\end{proof}

We now entitled to derive \ensuremath{\Conid{M}} types from \ensuremath{\Conid{W}} by defining:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Conid{M}\;\in\;(\Conid{S}\;\in\;\Conid{Set})\;(\Conid{P}\;\in\;\Conid{S}\;\rightarrow\;\Conid{Set})\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\Conid{M}\;\Conid{S}\;\Conid{P}\;\mathrel{=}\;\Conid{LIM}\;(\Conid{M-chain}\;\Conid{S}\;\Conid{P}){}\<[E]%
\ColumnHook
\end{hscode}\resethooks

%%Strictly Positive Families


\section{Strictly Positive Families}
\label{sec:spf}








We now give a syntax for defining indexed strictly positive types and strictly positive families:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{20}{@{}>{\hspre}l<{\hspost}@{}}%
\column{47}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{mutual}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Conid{SPF}\;\in\;(\Conid{I}\;\Conid{J}\;\in\;\Conid{Set})\;\rightarrow\;\Conid{Set₁}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Conid{SPF}\;\Conid{I}\;\Conid{J}\;\mathrel{=}\;\Conid{J}\;\rightarrow\;\Conid{ISPT}\;\Conid{I}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{data}\;\Conid{ISPT}\;(\Conid{I}\;\in\;\Conid{Set})\;\in\;\Conid{Set₁}\;\Keyword{where}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\eta^{\text{\tiny T}}\;\in\;{}\<[20]%
\>[20]{}(\Varid{i}\;\in\;\Conid{I})\;{}\<[47]%
\>[47]{}\rightarrow\;\Conid{ISPT}\;\Conid{I}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Delta^{\text{\tiny T}}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{J}\;\Conid{K}\mskip1.5mu\}\;{}\<[20]%
\>[20]{}(\Varid{f}\;\in\;\Conid{J}\;\rightarrow\;\Conid{K})\;(\Conid{F}\;\in\;\Conid{SPF}\;\Conid{I}\;\Conid{K})\;{}\<[47]%
\>[47]{}\rightarrow\;\Conid{SPF}\;\Conid{I}\;\Conid{J}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Sigma^{\text{\tiny T}}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{J}\;\Conid{K}\mskip1.5mu\}\;{}\<[20]%
\>[20]{}(\Varid{f}\;\in\;\Conid{J}\;\rightarrow\;\Conid{K})\;(\Conid{F}\;\in\;\Conid{SPF}\;\Conid{I}\;\Conid{J})\;{}\<[47]%
\>[47]{}\rightarrow\;\Conid{SPF}\;\Conid{I}\;\Conid{K}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Pi^{\text{\tiny T}}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{J}\;\Conid{K}\mskip1.5mu\}\;{}\<[20]%
\>[20]{}(\Varid{f}\;\in\;\Conid{J}\;\rightarrow\;\Conid{K})\;(\Conid{F}\;\in\;\Conid{SPF}\;\Conid{I}\;\Conid{J})\;{}\<[47]%
\>[47]{}\rightarrow\;\Conid{SPF}\;\Conid{I}\;\Conid{K}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\mu^{\text{\tiny T}}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{J}\mskip1.5mu\}\;{}\<[20]%
\>[20]{}(\Conid{F}\;\in\;\Conid{SPF}\;(\Conid{I}\;\uplus\;\Conid{J})\;\Conid{J})\;{}\<[47]%
\>[47]{}\rightarrow\;\Conid{SPF}\;\Conid{I}\;\Conid{J}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\nu^{\text{\tiny T}}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{J}\mskip1.5mu\}\;{}\<[20]%
\>[20]{}(\Conid{F}\;\in\;\Conid{SPF}\;(\Conid{I}\;\uplus\;\Conid{J})\;\Conid{J})\;{}\<[47]%
\>[47]{}\rightarrow\;\Conid{SPF}\;\Conid{I}\;\Conid{J}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks


We intend to interpret terms in this syntax as indexed functors, in order to interpret \ensuremath{\mu^{\text{\tiny T}}} and \ensuremath{\nu^{\text{\tiny T}}} we need to go first via indexed containers, which we know to be closed under ther formation of these fixed-points:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{20}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{mutual}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{⟦}\anonymous \Varid{⟧}^{\text{\tiny T}\star}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\;\Conid{J}\mskip1.5mu\}\;\rightarrow\;\Conid{SPF}\;\Conid{I}\;\Conid{J}\;\rightarrow\;\Conid{ICont}^{\star}\;\Conid{I}\;\Conid{J}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{⟦}\;\Conid{F}\;\Varid{⟧}^{\text{\tiny T}\star}\;\mathrel{=}\;\!\!\;\lambda\;\Varid{j}\;\rightarrow\;\Varid{⟦}\;\Conid{F}\;\Varid{j}\;\Varid{⟧}^{\text{\tiny T}}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{⟦}\anonymous \Varid{⟧}^{\text{\tiny T}}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\rightarrow\;\Conid{ISPT}\;\Conid{I}\;\rightarrow\;\Conid{ICont}\;\Conid{I}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{⟦}\;\eta^{\text{\tiny T}}\;\Varid{i}\;\Varid{⟧}^{\text{\tiny T}}\;{}\<[20]%
\>[20]{}\mathrel{=}\;\eta^{\text{\tiny C}}\;\Varid{i}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{⟦}\;\Delta^{\text{\tiny T}}\;\Varid{f}\;\Conid{F}\;\Varid{j}\;\Varid{⟧}^{\text{\tiny T}}\;{}\<[20]%
\>[20]{}\mathrel{=}\;\!\;\!\!\;\Delta^{\text{\tiny C}}\;\Varid{f}\;\Varid{⟦}\;\Conid{F}\;\Varid{⟧}^{\text{\tiny T}\star}\;\!\!\;\Varid{j}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{⟦}\;\Sigma^{\text{\tiny T}}\;\Varid{f}\;\Conid{F}\;\Varid{k}\;\Varid{⟧}^{\text{\tiny T}}\;{}\<[20]%
\>[20]{}\mathrel{=}\;\!\;\!\!\;\Sigma^{\text{\tiny C}}\;\Varid{f}\;\Varid{⟦}\;\Conid{F}\;\Varid{⟧}^{\text{\tiny T}\star}\;\!\!\;\Varid{k}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{⟦}\;\Pi^{\text{\tiny T}}\;\Varid{f}\;\Conid{F}\;\Varid{k}\;\Varid{⟧}^{\text{\tiny T}}\;{}\<[20]%
\>[20]{}\mathrel{=}\;\!\;\!\!\;\Pi^{\text{\tiny C}}\;\Varid{f}\;\Varid{⟦}\;\Conid{F}\;\Varid{⟧}^{\text{\tiny T}\star}\;\!\!\;\Varid{k}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{⟦}\;\mu^{\text{\tiny T}}\;\Conid{F}\;\Varid{j}\;\Varid{⟧}^{\text{\tiny T}}\;{}\<[20]%
\>[20]{}\mathrel{=}\;\!\;\!\!\;\mu^{\text{\tiny C}}\;\Varid{⟦}\;\Conid{F}\;\Varid{⟧}^{\text{\tiny T}\star}\;\!\!\;\Varid{j}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{⟦}\;\nu^{\text{\tiny T}}\;\Conid{F}\;\Varid{j}\;\Varid{⟧}^{\text{\tiny T}}\;{}\<[20]%
\>[20]{}\mathrel{=}\;\!\;\!\!\;\nu^{\text{\tiny C}}\;\Varid{⟦}\;\Conid{F}\;\Varid{⟧}^{\text{\tiny T}\star}\;\!\!\;\Varid{j}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

We can equip this syntax with a substitution operation, \ensuremath{\anonymous \bind ^{\text{\tiny T}}\anonymous }:


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{14}{@{}>{\hspre}l<{\hspost}@{}}%
\column{48}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{mutual}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Conid{ISPT}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\;\Conid{J}\mskip1.5mu\}\;\rightarrow\;(\Conid{I}\;\rightarrow\;\Conid{J})\;\rightarrow\;\Conid{ISPT}\;\Conid{I}\;\rightarrow\;\Conid{ISPT}\;\Conid{J}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Conid{ISPT}\;\gamma\;\Varid{t}\;\mathrel{=}\;\Varid{t}\;\bind ^{\text{\tiny T}}\;(\eta^{\text{\tiny T}}\;\ensuremath{\mbox{$\circ$}}\;\gamma){}\<[E]%
\\[\blanklineskip]%
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Conid{SPF}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\;\Conid{J}\;\Conid{K}\mskip1.5mu\}\;\rightarrow\;(\Conid{I}\;\rightarrow\;\Conid{J})\;\rightarrow\;\Conid{SPF}\;\Conid{I}\;\Conid{K}\;\rightarrow\;\Conid{SPF}\;\Conid{J}\;\Conid{K}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Conid{SPF}\;\gamma\;\Varid{t}\;\Varid{k}\;\mathrel{=}\;\Conid{ISPT}\;\gamma\;(\Varid{t}\;\Varid{k}){}\<[E]%
\\[\blanklineskip]%
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\anonymous \bind ^{\text{\tiny T}}\anonymous \;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\;\Conid{J}\mskip1.5mu\}\;\rightarrow\;\Conid{ISPT}\;\Conid{I}\;\rightarrow\;\Conid{SPF}\;\Conid{J}\;\Conid{I}\;\rightarrow\;\Conid{ISPT}\;\Conid{J}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\eta^{\text{\tiny T}}\;\Varid{i}\;{}\<[14]%
\>[14]{}\bind ^{\text{\tiny T}}\;\Conid{F}\;\mathrel{=}\;\Conid{F}\;\Varid{i}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Delta^{\text{\tiny T}}\;\Varid{f}\;\Conid{G}\;\Varid{j}\;{}\<[14]%
\>[14]{}\bind ^{\text{\tiny T}}\;\Conid{F}\;\mathrel{=}\;\Delta^{\text{\tiny T}}\;\Varid{f}\;(\lambda\;\Varid{k}\;\rightarrow\;\Conid{G}\;\Varid{k}\;\bind ^{\text{\tiny T}}\;\Conid{F})\;\Varid{j}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Sigma^{\text{\tiny T}}\;\Varid{f}\;\Conid{G}\;\Varid{k}\;{}\<[14]%
\>[14]{}\bind ^{\text{\tiny T}}\;\Conid{F}\;\mathrel{=}\;\Sigma^{\text{\tiny T}}\;\Varid{f}\;(\lambda\;\Varid{j}\;\rightarrow\;\Conid{G}\;\Varid{j}\;\bind ^{\text{\tiny T}}\;\Conid{F})\;\Varid{k}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Pi^{\text{\tiny T}}\;\Varid{f}\;\Conid{G}\;\Varid{k}\;{}\<[14]%
\>[14]{}\bind ^{\text{\tiny T}}\;\Conid{F}\;\mathrel{=}\;\Pi^{\text{\tiny T}}\;\Varid{f}\;(\lambda\;\Varid{j}\;\rightarrow\;\Conid{G}\;\Varid{j}\;\bind ^{\text{\tiny T}}\;\Conid{F})\;\Varid{k}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\mu^{\text{\tiny T}}\;\Conid{G}\;\Varid{j}\;{}\<[14]%
\>[14]{}\bind ^{\text{\tiny T}}\;\Conid{F}\;\mathrel{=}\;\mu^{\text{\tiny T}}\;(\lambda\;\Varid{k}\;\rightarrow\;\Conid{G}\;\Varid{k}\;\bind ^{\text{\tiny T}}\;[\mskip1.5mu {}\<[48]%
\>[48]{}(\Conid{SPF}\;\Varid{inl}\;\Conid{F}),(\eta^{\text{\tiny T}}\;\ensuremath{\mbox{$\circ$}}\;\Varid{inr})\mskip1.5mu])\;\Varid{j}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\nu^{\text{\tiny T}}\;\Conid{G}\;\Varid{j}\;{}\<[14]%
\>[14]{}\bind ^{\text{\tiny T}}\;\Conid{F}\;\mathrel{=}\;\nu^{\text{\tiny T}}\;(\lambda\;\Varid{k}\;\rightarrow\;\Conid{G}\;\Varid{k}\;\bind ^{\text{\tiny T}}\;[\mskip1.5mu {}\<[48]%
\>[48]{}(\Conid{SPF}\;\Varid{inl}\;\Conid{F}),(\eta^{\text{\tiny T}}\;\ensuremath{\mbox{$\circ$}}\;\Varid{inr})\mskip1.5mu])\;\Varid{j}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks

As defined above this doesn't pass Agda's termination check, due to deriving the \ensuremath{\Conid{ISPT}} from the monad instance. If we define the map of the functor directly the whole thing obviously terminates, at the expense of having to show the two definitions of the map for \ensuremath{\Conid{ISPT}} agree.


\begin{proposition} 
\ensuremath{(\Conid{ISPT},\eta^{\text{\tiny T}},\anonymous \bind ^{\text{\tiny T}}\anonymous )} is a \emph{relative monad} on the 
lifting functor \ensuremath{\uparrow\;\in\;\Conid{Set}_{i}\;\rightarrow\;\Conid{Set}_{i+1}}. Moreover, this structure is preserved under the translation to containers \ensuremath{\Varid{⟦}\anonymous \Varid{⟧}^{\text{\tiny T}}}.
\end{proposition}

\begin{proof}
To prove the structure is a relative 
monad we observe that the following equalities hold:

For \ensuremath{\Conid{F}\;\in\;\Conid{ISPT}\;\Conid{K}}, \ensuremath{\Conid{G}\;\in\;\Conid{SPF}\;\Conid{J}\;\Conid{K}}, \ensuremath{\Conid{H}\;\in\;\Conid{ISPT}\;\Conid{I}\;\Conid{J}}:
\begin{align}
\ensuremath{\Conid{H}\;\Varid{j}}                 &\quad& \equiv &&\quad& \ensuremath{(\eta^{\text{\tiny T}}\;\Varid{j})\;\bind ^{\text{\tiny T}}\;\Conid{H}}               \\
\ensuremath{\Conid{F}}                   && \equiv &&& \ensuremath{\Conid{F}\;\bind ^{\text{\tiny T}}\;\eta^{\text{\tiny F}}}                 \\
\ensuremath{(\Conid{F}\;\bind ^{\text{\tiny T}}\;\Conid{G})\;\bind ^{\text{\tiny T}}\;\Conid{F}} && \equiv &&& \ensuremath{\Conid{F}\;\bind ^{\text{\tiny T}}\;(\lambda\;\Varid{k}\;\rightarrow\;(\Conid{G}\;\Varid{k})\;\bind ^{\text{\tiny T}}\;\Conid{H})} 
\end{align}

The first is by definition, and the others follow by induction on \ensuremath{\Conid{F}}. 
To show that the structure is preserved by \ensuremath{\Varid{⟦}\anonymous \Varid{⟧}^{\text{\tiny T}}} it is sufficient to show that for all \ensuremath{\Conid{F}\;\in\;\Conid{ISPT}\;\Conid{J}} and \ensuremath{\Conid{G}\;\in\;\Conid{SPF}\;\Conid{I}\;\Conid{J}} there exist mutually inverse container 
morphisms \ensuremath{\Varid{bindpres}} and \ensuremath{\Varid{bindpres⁻¹}}:


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{15}{@{}>{\hspre}l<{\hspost}@{}}%
\column{18}{@{}>{\hspre}l<{\hspost}@{}}%
\column{44}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[3]{}\Varid{bindpres}\;{}\<[15]%
\>[15]{}\in\;{}\<[18]%
\>[18]{}(\Varid{⟦}\;\Conid{F}\;\bind ^{\text{\tiny T}}\;\Conid{G}\;\Varid{⟧}^{\text{\tiny T}})\;{}\<[44]%
\>[44]{}\Rightarrow^{\text{\tiny C}}\;(\Varid{⟦}\;\Conid{F}\;\Varid{⟧}^{\text{\tiny T}}\;\bind ^{\text{\tiny C}}\;\Varid{⟦}\;\Conid{G}\;\Varid{⟧}^{\text{\tiny T}\star}){}\<[E]%
\\
\>[3]{}\Varid{bindpres⁻¹}\;{}\<[15]%
\>[15]{}\in\;{}\<[18]%
\>[18]{}(\Varid{⟦}\;\Conid{F}\;\Varid{⟧}^{\text{\tiny T}}\;\bind ^{\text{\tiny C}}\;\Varid{⟦}\;\Conid{G}\;\Varid{⟧}^{\text{\tiny T}\star})\;{}\<[44]%
\>[44]{}\Rightarrow^{\text{\tiny C}}\;(\Varid{⟦}\;\Conid{F}\;\bind ^{\text{\tiny T}}\;\Conid{G}\;\Varid{⟧}^{\text{\tiny T}}){}\<[E]%
\ColumnHook
\end{hscode}\resethooks




\end{proof}









We define disjoint union and cartesian product just as we did in the functor and container universes:

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\bot^{\text{\tiny T}}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\rightarrow\;\Conid{ISPT}\;\Conid{I}{}\<[E]%
\\
\>[B]{}\bot^{\text{\tiny T}}\;\mathrel{=}\;\Sigma^{\text{\tiny T}}\;\{\mskip1.5mu \Conid{J}\;\mathrel{=}\;\bot\mskip1.5mu\}\;\{\mskip1.5mu \Conid{K}\;\mathrel{=}\;\top\mskip1.5mu\}\;\anonymous \;(\lambda\;())\;\anonymous {}\<[E]%
\\[\blanklineskip]%
\>[B]{}\anonymous \uplus^{\text{\tiny T}}\anonymous \;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\rightarrow\;(\Conid{F}\;\Conid{G}\;\in\;\Conid{ISPT}\;\Conid{I})\;\rightarrow\;\Conid{ISPT}\;\Conid{I}{}\<[E]%
\\
\>[B]{}\Conid{F}\;\mathbin{\uplus^{\text{\tiny T}}}\;\Conid{G}\;\mathrel{=}\;\Sigma^{\text{\tiny T}}\;\{\mskip1.5mu \Conid{K}\;\mathrel{=}\;\top\mskip1.5mu\}\;\anonymous \;(\lambda\;\Varid{b}\;\rightarrow\;\Varid{if}\;\Varid{b}\;\Varid{then}\;\Conid{F}\;\Varid{else}\;\Conid{G})\;\anonymous {}\<[E]%
\\[\blanklineskip]%
\>[B]{}\top^{\text{\tiny T}}\;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\rightarrow\;\Conid{ISPT}\;\Conid{I}{}\<[E]%
\\
\>[B]{}\top^{\text{\tiny T}}\;\mathrel{=}\;\Pi^{\text{\tiny T}}\;\{\mskip1.5mu \Conid{J}\;\mathrel{=}\;\bot\mskip1.5mu\}\;\{\mskip1.5mu \Conid{K}\;\mathrel{=}\;\top\mskip1.5mu\}\;\anonymous \;(\lambda\;())\;\anonymous {}\<[E]%
\\[\blanklineskip]%
\>[B]{}\anonymous \times^{\text{\tiny T}}\anonymous \;\in\;\forall{}\;\{\mskip1.5mu \Conid{I}\mskip1.5mu\}\;\rightarrow\;(\Conid{F}\;\Conid{G}\;\in\;\Conid{ISPT}\;\Conid{I})\;\rightarrow\;\Conid{ISPT}\;\Conid{I}{}\<[E]%
\\
\>[B]{}\Conid{F}\;\mathbin{\times^{\text{\tiny T}}}\;\Conid{G}\;\mathrel{=}\;\Pi^{\text{\tiny T}}\;\{\mskip1.5mu \Conid{K}\;\mathrel{=}\;\top\mskip1.5mu\}\;\anonymous \;(\lambda\;\Varid{b}\;\rightarrow\;\Varid{if}\;\Varid{b}\;\Varid{then}\;\Conid{F}\;\Varid{else}\;\Conid{G})\;\anonymous {}\<[E]%
\ColumnHook
\end{hscode}\resethooks



\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{9}{@{}>{\hspre}l<{\hspost}@{}}%
\column{15}{@{}>{\hspre}l<{\hspost}@{}}%
\column{21}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Conid{T}_{\Conid{Fin}}\;\in\;\Conid{SPF}\;\bot\;\Conid{ℕ}{}\<[E]%
\\
\>[B]{}\Conid{T}_{\Conid{Fin}}\;\mathrel{=}\;\mu^{\text{\tiny T}}\;(\Sigma^{\text{\tiny T}}\;\Varid{suc}\;(\top^{\text{\tiny T}}\;\mathbin{\uplus^{\text{\tiny T}}}\;(\eta^{\text{\tiny T}}\;\ensuremath{\mbox{$\circ$}}\;\Varid{inr}))){}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Conid{T}_{\Conid{Vec}}\;\in\;\Conid{SPF}\;\top\;\Conid{ℕ}{}\<[E]%
\\
\>[B]{}\Conid{T}_{\Conid{Vec}}\;\mathrel{=}\;{}\<[9]%
\>[9]{}\mu^{\text{\tiny T}}\;{}\<[15]%
\>[15]{}({}\<[21]%
\>[21]{}\Sigma^{\text{\tiny T}}\;\{\mskip1.5mu \Conid{J}\;\mathrel{=}\;\top\mskip1.5mu\}\;(\lambda\;\anonymous \;\rightarrow\;\Varid{zero})\;(\lambda\;\anonymous \;\rightarrow\;\top^{\text{\tiny T}}){}\<[E]%
\\
\>[15]{}\mathbin{\uplus^{\text{\tiny T}}}\;{}\<[21]%
\>[21]{}\Sigma^{\text{\tiny T}}\;\Varid{suc}\;(\lambda\;\Varid{n}\;\rightarrow\;\eta^{\text{\tiny T}}\;(\Varid{inl}\;\anonymous )\;\mathbin{\times^{\text{\tiny T}}}\;\eta^{\text{\tiny T}}\;(\Varid{inr}\;\Varid{n}))){}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Conid{T}_{\Conid{ScLam}}\;\in\;\Conid{SPF}\;\bot\;\Conid{ℕ}{}\<[E]%
\\
\>[B]{}\Conid{T}_{\Conid{ScLam}}\;\mathrel{=}\;\mu^{\text{\tiny T}}\;{}\<[15]%
\>[15]{}({}\<[21]%
\>[21]{}\Conid{SPF}\;(\lambda\;())\;\Conid{T}_{\Conid{Fin}}{}\<[E]%
\\
\>[15]{}\mathbin{\uplus^{\text{\tiny T}}}\;{}\<[21]%
\>[21]{}(((\eta^{\text{\tiny T}}\;\ensuremath{\mbox{$\circ$}}\;\Varid{inr})\;\mathbin{\times^{\text{\tiny T}}}\;(\eta^{\text{\tiny T}}\;\ensuremath{\mbox{$\circ$}}\;\Varid{inr})){}\<[E]%
\\
\>[15]{}\mathbin{\uplus^{\text{\tiny T}}}\;{}\<[21]%
\>[21]{}\Delta^{\text{\tiny T}}\;\Varid{suc}\;(\eta^{\text{\tiny T}}\;\ensuremath{\mbox{$\circ$}}\;\Varid{inr}))){}\<[E]%
\ColumnHook
\end{hscode}\resethooks

Note that we have to weaken the reference to \ensuremath{\Conid{T}_{\Conid{Fin}}} in the definition of 
\ensuremath{\Conid{T}_{\Conid{ScLam}}}, since under the \ensuremath{\mu^{\text{\tiny T}}} we can refer to the recursive \ensuremath{\Conid{TSCLam}} trees, 
but \ensuremath{\Conid{T}_{\Conid{Fin}}} itself can refer to no variables.

We can also define the mutual types, \ensuremath{\Conid{Ne}} and \ensuremath{\Conid{Nf}}. Here, a copy of the normal 
forms is defined \emph{inside} the definition of the neutral terms, and vice
versa:


\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{10}{@{}>{\hspre}l<{\hspost}@{}}%
\column{11}{@{}>{\hspre}l<{\hspost}@{}}%
\column{12}{@{}>{\hspre}l<{\hspost}@{}}%
\column{17}{@{}>{\hspre}l<{\hspost}@{}}%
\column{18}{@{}>{\hspre}l<{\hspost}@{}}%
\column{23}{@{}>{\hspre}l<{\hspost}@{}}%
\column{29}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Conid{T}_{\Conid{Ne}}\;\in\;\Conid{SPF}\;\bot\;\Conid{ℕ}{}\<[E]%
\\
\>[B]{}\Conid{T}_{\Conid{Ne}}\;\mathrel{=}\;\mu^{\text{\tiny T}}\;({}\<[17]%
\>[17]{}\Conid{SPF}\;(\lambda\;())\;\Conid{T}_{\Conid{Fin}}{}\<[E]%
\\
\>[B]{}\hsindent{11}{}\<[11]%
\>[11]{}\mathbin{\uplus^{\text{\tiny T}}}\;{}\<[17]%
\>[17]{}((\eta^{\text{\tiny T}}\;\ensuremath{\mbox{$\circ$}}\;\Varid{inr})\;\mathbin{\times^{\text{\tiny T}}}\;\Conid{TNeNf})){}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{where}\;{}\<[10]%
\>[10]{}\Conid{TNeNf}\;\in\;\Conid{SPF}\;(\bot\;\uplus\;\Conid{ℕ})\;\Conid{ℕ}{}\<[E]%
\\
\>[10]{}\Conid{TNeNf}\;\mathrel{=}\;\mu^{\text{\tiny T}}\;{}\<[23]%
\>[23]{}({}\<[29]%
\>[29]{}(\Delta^{\text{\tiny T}}\;\Varid{suc}\;(\eta^{\text{\tiny T}}\;\ensuremath{\mbox{$\circ$}}\;\Varid{inr})){}\<[E]%
\\
\>[23]{}\mathbin{\uplus^{\text{\tiny T}}}\;{}\<[29]%
\>[29]{}(\eta^{\text{\tiny T}}\;\ensuremath{\mbox{$\circ$}}\;(\Varid{inl}\;\ensuremath{\mbox{$\circ$}}\;\Varid{inr}))){}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Conid{T}_{\Conid{Nf}}\;\in\;\Conid{SPF}\;\bot\;\Conid{ℕ}{}\<[E]%
\\
\>[B]{}\Conid{T}_{\Conid{Nf}}\;\mathrel{=}\;\mu^{\text{\tiny T}}\;{}\<[12]%
\>[12]{}({}\<[18]%
\>[18]{}\Delta^{\text{\tiny T}}\;\Varid{suc}\;(\eta^{\text{\tiny T}}\;\ensuremath{\mbox{$\circ$}}\;\Varid{inr}){}\<[E]%
\\
\>[12]{}\mathbin{\uplus^{\text{\tiny T}}}\;{}\<[18]%
\>[18]{}\Conid{TNfNe}){}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{where}\;{}\<[10]%
\>[10]{}\Conid{TNfNe}\;\in\;\Conid{SPF}\;(\bot\;\uplus\;\Conid{ℕ})\;\Conid{ℕ}{}\<[E]%
\\
\>[10]{}\Conid{TNfNe}\;\mathrel{=}\;\mu^{\text{\tiny T}}\;{}\<[23]%
\>[23]{}({}\<[29]%
\>[29]{}\Conid{SPF}\;(\lambda\;())\;\Conid{T}_{\Conid{Fin}}{}\<[E]%
\\
\>[23]{}\mathbin{\uplus^{\text{\tiny T}}}\;{}\<[29]%
\>[29]{}((\eta^{\text{\tiny T}}\;\ensuremath{\mbox{$\circ$}}\;\Varid{inr})\;\mathbin{\times^{\text{\tiny T}}}\;(\eta^{\text{\tiny T}}\;\ensuremath{\mbox{$\circ$}}\;(\Varid{inl}\;\ensuremath{\mbox{$\circ$}}\;\Varid{inr})))){}\<[E]%
\ColumnHook
\end{hscode}\resethooks

\section{Conclusions}

We have shown how inductive and coinductive families, a central
feature in dependently typed programming, can be constructed from the
standard infrastructure present in Type Theory, i.e. W-types together
with $\Pi$, $\Sigma$ and equality types. Indeed, we are able to reduce
the syntactically rich notion of families to a small collection of
categorically inspired combinators. This is an alternative to the
complex syntactic schemes present in the \emph{Calculus of Inductive
  Constructions} (CIC), or in the Agda and Epigram systems. We are
able to encode inductively defined families in a small core language
which means that we rely only on a small trusted code base. The
reduction to W-types requires an extensional propositional
equality. Our current approach using an axiom \ensuremath{\Varid{ext}} is sufficent for
proofs but isn't computationally adequate. A more satisfying approach
would built on \emph{Observational Type Theory} (OTT)
\cite{alti:ott-conf}.

\todo{Mention Epigram 2?}

The present paper is an annotated Agda script, i.e. all the proofs are
checked by the Agda system. We have tried hard to integrate the formal
development with the narrative. In some cases we have surpressed
certain details present in the source of the paper to keep the
material readable.

A more serious challenge are mutual inductively (or coinductively)
defined families where one type depends on another
\cite{setzer-forsberg-indind}. A typical example is the syntax of Type
Theory itself which, to simplify, can be encoded by mutually defining
contexts containing terms, types in a given context and terms in a
given type:
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Conid{Con}\;\in\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\Conid{Ty}\;\in\;\Conid{Con}\;\rightarrow\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\Conid{Tm}\;\in\;(\Gamma\;\in\;\Conid{Con})\;\rightarrow\;\Conid{Ty}\;\Gamma\;\rightarrow\;\Conid{Set}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
In recent work \cite{calco-indind} present a categorical semantics for
this kind of definitions based on dialgebras. However, a presentation
of strictly positive definitions in the spirit of contaienrs is not
yet available.

\todo{Discuss the relationship to inductive-recursive definitions.}

\bibliographystyle{plain}
\bibliography{ic}

\end{document}
